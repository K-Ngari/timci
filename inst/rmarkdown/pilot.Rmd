---
title: "TIMCI Pilot"
author: "H. Langet"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

```{r, echo=FALSE}
ruODK::ru_setup(
  svc = Sys.getenv("ODKC_SVC"),
  un = Sys.getenv("ODKC_UN"),
  pw = Sys.getenv("ODKC_PW"),
  tz = Sys.getenv("TZ"),
  verbose = FALSE # Can be switched to TRUE for demo or debugging
)

raw_facility_data <- ruODK::odata_submission_get(fid = "01-TIMCI-CRF-Facility")
raw_day7fu_data <- ruODK::odata_submission_get(fid = "01c-TIMCI-CRF-Day7")
raw_hospit_data <- ruODK::odata_submission_get(fid = "01b-TIMCI-CRF-Hospital")
raw_day28fu_data <- ruODK::odata_submission_get(fid = "01d-TIMCI-CRF-Day28")

facility_data <- timci::format_odk_data(raw_facility_data)
start_date <- min(facility_data$date)
end_date <- max(facility_data$date)
```

This report covers the period from **`r start_date`** to **`r end_date`**.

# Screening

```{r, echo=FALSE}
n_screened <- nrow(facility_data)
```

Number of children screened: **`r n_screened`**\

```{r, echo=FALSE}
facility_submission_bar_plot <- timci::generate_day_bar_plot(facility_data, start_date, end_date)
plot(facility_submission_bar_plot)
```

# Enrolment

```{r, echo=FALSE}
study_data <- timci::extract_enrolled_participants(facility_data)
pii <- timci::extract_pii(study_data)
n_enrolled <- nrow(study_data)
deidentified_facility_data <- timci::deidentify_data(study_data)
cdir <- "rct_exports/"
dir.create(file.path(cdir), showWarnings = FALSE)
export_fname <- file.path(cdir, paste("facility_data", "_", Sys.Date(), ".xlsx", sep = ""))
openxlsx::write.xlsx(deidentified_facility_data, export_fname, row.names = FALSE)
```

Number of children enrolled: **`r n_enrolled`**

### Enrolment versus global target
```{r, echo=FALSE}
#enrolment_hist <- timci::generate_enrolment_hist(deidentified_facility_data)
#plot(enrolment_hist)
```
### Enrolment versus weekly target
### Enrolment rate
```{r, echo=FALSE}
enrolment_pie_chart <- timci::generate_pie_chart(data.frame(group = c("Enrolled", "Not enrolled"), value = c(n_enrolled, n_screened - n_enrolled)))
plot(enrolment_pie_chart)
```

### Non-enrolment causes
```{r, echo=FALSE}
non_enrolment_causes <- timci::count_screening(facility_data)
nec_pie_chart <- timci::generate_pie_chart(non_enrolment_causes)
plot(nec_pie_chart)
```

## Referrals

```{r, echo=FALSE}
referral_data <- timci::extract_referrals(deidentified_facility_data)
n_referrals <- nrow(referral_data)
referral_pie_chart <- timci::generate_pie_chart(data.frame(group = c("Referred at Day 0", "Not referred at Day 0"), value = c(n_referrals, n_enrolled - n_referrals)))
plot(referral_pie_chart)
```

Number of children referred at Day 0: **`r n_referrals`**\

## Day 7 follow-up

## Day 28 follow-up
