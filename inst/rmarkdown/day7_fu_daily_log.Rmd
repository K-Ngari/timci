---
title: "TIMCI Day 7 follow-up - Daily log"
author: "`r Sys.getenv('TIMCI_INSTITUTION')`"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
params:
  output_dir: "."
  rct_ls_form_list: NULL
  pii: NULL
  raw_day7fu_data: NULL
  raw_withdrawal_data: NULL
output:
  html_document: default
  word_document:
    reference_docx: word_styles1.docx
---

```{r setup-rmd, include=FALSE}
library(qrcode)
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
crf_day7_fid <- Sys.getenv("TIMCI_CRF_DAY7_FID")
```

```{r output-directory}
# Create `odk_external_files` folder if it does not exist
dir.create(file.path(params$output_dir, "odk_external_files"), showWarnings = FALSE)
```

```{r}
day7fu <- NULL
if (!is.null(params$raw_day7fu_data)) {
  if (nrow(params$raw_day7fu_data) > 0) {
    
    day7fu <- timci::generate_fu_log(params$pii, params$raw_day7fu_data, 7, 9)
    failed_day7fu_data <- timci::format_day7_data(params$raw_day7fu_data)[[2]]
    tmp <- timci::export_df2xlsx(failed_day7fu_data, params$output_dir, "day7_unsuccessful_calls")
    day7lost <- timci::generate_fu_log(params$pii, params$raw_day7fu_data, 10, 2000)
    tmp <- timci::export_df2xlsx(day7lost, params$output_dir, "day7_lost_to_followup")
    
  }
}
```

```{r}
csv7_fname <- file.path(params$output_dir, "odk_external_files", "day7fu.csv")
write.csv(day7fu, csv7_fname, row.names = FALSE, quote = FALSE)
```

# Upload list of participants on the ODK Central server

```{r}
current_version <- "N/A"
if (crf_day7_fid %in% params$rct_ls_form_list) {
  # Get form details
  cform <- ruODK::form_detail(
    pid = ruODK::get_default_pid(),
    fid = crf_day7_fid,
    url = ruODK::get_default_url(),
    un = ruODK::get_default_un(),
    pw = ruODK::get_default_pw(),
  )
  current_version <- as.numeric(cform$version)
}
```

```{r}
form_url <- "N/A"
draft_response <- NULL
csv_upload_response <- NULL
new_version <- "N/A"
publication_response <- NULL
if (crf_day7_fid %in% params$rct_ls_form_list) {
  form_url <- paste0(ruODK::get_default_url(), "/v1/projects/", ruODK::get_default_pid(), "/forms/", crf_day7_fid)
  # Create a new draft of the form
  draft_response  <- timci::create_odkc_draft_form(ruODK::get_default_un(), ruODK::get_default_pw(), form_url)
  # Upload the new CSV created as a form attachment
  csv_upload_response <- timci::upload_odkc_csv_attachment(ruODK::get_default_un(), ruODK::get_default_pw(), form_url, csv7_fname)
  # Publish a draft form
  new_version <- as.character(current_version + 0.000001)
  publication_response <- timci::publish_odkc_draft_form(ruODK::get_default_un(), ruODK::get_default_pw(), form_url, new_version)
}
```

**`r form_url`**

* Initial version of the form: **`r current_version`**

* Create a new draft of the form: **`r draft_response$success`**

* Upload the CSV containing the current follow-up log as an attachment to the draft: **`r csv_upload_response$success`**

* Publish the updated form with version number **`r new_version`**: **`r publication_response$success`**
