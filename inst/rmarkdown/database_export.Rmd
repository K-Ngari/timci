---
title: "TIMCI Data Quality Report"
author: "`r if (Sys.getenv('TIMCI_COUNTRY') == 'Tanzania') {'Ifakara Health Institute (IHI)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'India') {'King George s Medical University (KGMU)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {'UniversitÃ© Cheikh Anta Diop de Dakar (UCAD)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Kenya') {'University of Nairobi (UoN)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Myanmar') {'Burnet Institute (BI)'} else {'Swiss Tropical and Public Health Institute (Swiss TPH)'}`"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  pdf_document:
    number_sections: true
    toc: true
    toc_depth: 3
  word_document:
    toc: true
    reference_docx: word_styles1.docx
    fig_width: 7.5
  html_document: default
params:
  rctls_dir: !r tempdir()
  participant_zip: !r file.path(tempdir(),"participants.zip")
  spa_dir: !r tempdir()
  qual1_dir: !r tempdir()
  facility_data: NULL
  lock_date: NULL
  facility_data_audit: NULL
  raw_day7fu_data: NULL
  raw_hospit_data: NULL
  raw_day28fu_data: NULL
  raw_withdrawal_data: NULL
  raw_problem_data: NULL
  spa_cgei_data: NULL
  spa_fa_data: NULL
  spa_hcpi_data: NULL
  spa_sco_data: NULL
  tf_data: NULL
  cgidi_invitation_data: NULL
  cgidi_encryption_data: NULL
  cgidi_interview_data: NULL
---

```{r setup-rmd, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE)
library(dplyr)
```

```{r setup-variables, echo = FALSE}

deidentification_on <- 0

spa_pid <- Sys.getenv("TIMCI_SPA_PID")
qpid <- Sys.getenv("TIMCI_QUAL_PID")
cgidi3_fid <- Sys.getenv("TIMCI_QUAL_CGIDI3_FID")

lock_date <- params$lock_date
lock_rctls_dir <- file.path(params$rctls_dir, "locked")
dir.create(lock_rctls_dir, showWarnings = FALSE)

qual1_dir <- params$qual1_dir

if (!is.null(params$facility_data)) {
  
  facility_data <- params$facility_data
  facility_data_audit <- params$facility_data_audit
  raw_day7fu_data <- params$raw_day7fu_data
  raw_hospit_data <- params$raw_hospit_data
  raw_day28fu_data <- params$raw_day28fu_data
  raw_withdrawal_data <- params$raw_withdrawal_data
  raw_problem_data <- params$raw_problem_data
  spa_cgei_data <- params$spa_cgei_data
  spa_fa_data <- params$spa_fa_data
  spa_hcpi_data <- params$spa_hcpi_data
  spa_sco_data <- params$spa_sco_data
  tf_data <- params$tf_data
  cgidi_invitation_data <- params$cgidi_invitation_data
  cgidi_encryption_data <- params$cgidi_encryption_data
  cgidi_interview_data <- params$cgidi_interview_data
  
} else {
  
  lock_date <- "2021-08-13"
  facility_data_audit <- NULL
  
  # Facility data
  raw_facility_csv <- "C://Users//langhe//Documents//Tanzania//raw_data//01a-TIMCI-CRF-Facility.csv"
  raw_facility_data <- readr::with_edition(1, readr::read_csv(raw_facility_csv))
  raw_facility_data <- timci::format_odk_metadata(raw_facility_data, "2021-07-05")
  facility_data <- timci::process_facility_data(raw_facility_data)
  pii <- timci::extract_enrolled_participants(facility_data)[[2]]
  
  # Withdrawal data
  raw_withdrawal_csv <- "C://Users//langhe//Documents//Tanzania//raw_data//99-TIMCI-withdrawal.csv"
  raw_withdrawal_data <- readr::with_edition(1, readr::read_csv(raw_withdrawal_csv))
  raw_withdrawal_data <- timci::format_odk_metadata(raw_withdrawal_data, "2021-07-05")
  
  # Day 7 follow-up data
  raw_day7fu_csv <- "C://Users//langhe//Documents//Tanzania//raw_data//01c-TIMCI-CRF-Day7.csv"
  raw_day7fu_data <- readr::with_edition(1, readr::read_csv(raw_day7fu_csv))
  raw_day7fu_data <- timci::format_odk_metadata(raw_day7fu_data, "2021-07-05")
  
  # Day 28 follow-up data
  raw_day28fu_csv <- "C://Users//langhe//Documents//Tanzania//raw_data//01d-TIMCI-CRF-fu-Day28.csv"
  raw_day28fu_data <- readr::with_edition(1, readr::read_csv(raw_day28fu_csv))
  raw_day28fu_data <- timci::format_odk_metadata(raw_day28fu_data, "2021-07-05")
  
  # Sick child observation protocol data
  spa_sco_csv <- "C://Users//langhe//Documents//Tanzania//raw_data//05a-TIMCI-SPA-sco.csv"
  spa_sco_data <- readr::with_edition(1, readr::read_csv(spa_sco_csv))
  spa_sco_data <- timci::format_odk_metadata(spa_sco_data, "2021-07-05")
  
}
```

# Dates

```{r load-RCT-LS-ODK-facility-data, results='asis'}
start_date <- NULL
end_date <- NULL
if (!is.null(facility_data)) {
  if (nrow(facility_data) > 0) {
    start_date <- min(facility_data$date_visit)
    end_date <- max(facility_data$date_visit)
    if (is.null(lock_date)) {
      lock_date <- end_date
    }
    week_nb <- ceiling(difftime(as.Date(lock_date), as.Date(start_date) - 1,units = "weeks"))
    if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
      cat(paste0("* Début de la collecte : **", start_date, "**"))
    } else {
      cat(paste0("* Data collection start: **", start_date, "**"))
    }
  }
}
```
```{r, results='asis'}
if (!is.null(facility_data)) {
  if (nrow(facility_data) > 0) {
    if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
      cat(paste0("* Clôture de la base de données : **", lock_date, "** (semaine **", week_nb,"** de l'étude)"))
    } else {
      cat(paste0("* Database lock: **", lock_date, "** (week **", week_nb,"** of the study)"))
    }
  }
}
```

# `r if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India"){'Pragmatic cluster RCT'} else{'Longitudinal Observational Study'}`

## Facility data quality checks

```{r}
screening_data <- timci::extract_screening_data(facility_data)
res <- timci::extract_enrolled_participants(facility_data)
day0_data <- res[[1]]
pii <- res[[2]]
n_enrolled <- nrow(day0_data)
```

```{r}
locked_screening_data <- screening_data %>% dplyr::filter(date_visit <= as.Date(lock_date, "%Y-%m-%d"))
locked_day0_data <- day0_data %>% dplyr::filter(date_visit <= as.Date(lock_date, "%Y-%m-%d"))
locked_pii <- pii %>% dplyr::filter(date_visit <= as.Date(lock_date, "%Y-%m-%d"))
```

### Duplicate management

#### Child ID duplicates  

```{r, results='asis'}
cat("Rule: child ID duplicates are removed from the locked database.")
```

```{r check-RCT-LS-ODK-facility-data-001, results='asis'}
day0_qc <- NULL
if (!is.null(facility_data)) {
  if (nrow(locked_day0_data) > 0) {
    day0_qc <- timci::detect_id_duplicates(locked_day0_data)
    id_duplicates <- day0_qc[day0_qc$id_fq > 1,]
    if (nrow(id_duplicates) > 0) { 
      id_duplicates %>% knitr::kable(caption = "ID duplicates", row.names = FALSE)
    }
  }
}
```

```{r, results='asis'}
if (!is.null(facility_data)) {
  if (nrow(locked_day0_data) > 0) {
    if (nrow(id_duplicates) > 0) { 
      # Remove duplicate child IDs from the clean database
      day0_data_id_duplicates <- locked_day0_data[locked_day0_data$child_id %in% id_duplicates$child_id, ]
      locked_day0_data <- locked_day0_data[!locked_day0_data$child_id %in% id_duplicates$child_id, ]
      cat(paste0("", nrow(id_duplicates), " duplicated IDs (corresponding to ", nrow(day0_data_id_duplicates), " participants) were detected and removed in the locked Day 0 database."))
    } else {
      cat("No duplicated IDs were detected.")
    }
  } else {
    cat("N/A")
  }
}
```

#### Name duplicates

```{r check-RCT-LS-ODK-facility-data-002, results='asis'}
if (!is.null(facility_data)) {
  if (nrow(locked_pii) > 0) {
    day0_qc1 <- timci::detect_name_duplicates(locked_pii)
    day0_qc <- merge(day0_qc, day0_qc1, by = 'child_id')
    duplicates <- day0_qc[(day0_qc$ex_name_fq > 1) | (day0_qc$sw_name_fq > 1),]
    if (nrow(duplicates) > 0) { 
      knitr::kable(duplicates, caption = "Possible name duplicates")
      cat("Information - no action taken at this stage.")
    }
  }
}

if (!is.null(facility_data)) {
  if (nrow(locked_pii) > 0) {
    if (nrow(duplicates) > 0) { 
      cat("Information - no action taken at this stage.")
    } else {
      cat("No duplicated names detected")
    }
  } else {
    cat("N/A")
  }
}

# Approximate String Matching (Fuzzy Matching)
#df <- dplyr::mutate(pii, full_name = tolower(paste(fs_name, ls_name, sep = ' ')))
#df3 <- df[c("child_id", "full_name")]
#qc3 <- lapply(list(df3$full_name), agrep, x = list(df3$full_name), value = TRUE)
#print(qc3)
```
```{r export-duplicates}
if (!is.null(day0_qc)) {
  fn <- timci::export_df2xlsx(day0_qc, params$rctls_dir,
                              "07_data_quality_checks")
}
```
### Withdrawal management

```{r, results='asis'}
if (!is.null(facility_data)) {
  if (nrow(locked_day0_data) > 0) {
    if (nrow(raw_withdrawal_data) > 0) { 
      raw_withdrawal_data$child_id <- ifelse(!is.na(raw_withdrawal_data$'page-a1_a_4'), raw_withdrawal_data$'page-a1_a_4', raw_withdrawal_data$'page-a1_a_4a')
      withdrawal_data2 <- raw_withdrawal_data[!is.na(raw_withdrawal_data$child_id), ]
      # Remove withdrawn participants from the clean database
      locked_day0_data <- locked_day0_data[!locked_day0_data$child_id %in% withdrawal_data2$child_id, ]
      day0_data_id_withdrawal <- locked_day0_data[locked_day0_data$child_id %in% withdrawal_data2$child_id, ]
      cat(paste0(nrow(raw_withdrawal_data), " withdrawals were reported and ", nrow(day0_data_id_withdrawal), " participants were found and removed in the locked Day 0 database."))
    } else {
      cat("No withdrawal reported.")
    }
  } else {
    cat("N/A")
  }
}
```

### Export data

```{r export-screening-data, results = 'asis'}
if (!is.null(facility_data)) { 
  fn <- timci::export_df2xlsx(screening_data, params$rctls_dir,
                              "01_timci_screening_data")
  fn <- timci::export_df2csv(screening_data, params$rctls_dir,
                             "01_timci_screening_data")
}
```

```{r export-locked-screening-data, results = 'asis'}
if (!is.null(facility_data)) {
  fn <- timci::export_df2xlsx(locked_screening_data, lock_rctls_dir,
                              "01_timci_screening_data")
  fn <- timci::export_df2csv(locked_screening_data, lock_rctls_dir,
                             "01_timci_screening_data")
}
cat(paste0("* Screening data are exported in ", "01_timci_screening_data", ".csv and ", "01_timci_screening_data", ".xslx in the ", params$rctls_dir, " folder"))
```

```{r export-facility-audit}
if (!is.null(facility_data_audit)) { 
  fn <- timci::export_df2csv(facility_data_audit, params$rctls_dir,
                             "00_facility_audit_data")
}
```

```{r split-pii-from-research-data}
if (!is.null(facility_data)) {
  
  if (deidentification_on == 1) {
    deidentified_day0_data <- timci::deidentify_data(day0_data)
    fn <- timci::export_df2xlsx(deidentified_day0_data, params$rctls_dir,
                                "02_timci_day0_data")
    fn <- timci::export_df2csv(deidentified_day0_data, params$rctls_dir,
                               "02_timci_day0_data")
    
    locked_day0_data <- timci::deidentify_data(locked_day0_data)
    fn <- timci::export_df2xlsx(locked_day0_data, lock_rctls_dir,
                                "02_timci_day0_data")
    fn <- timci::export_df2csv(locked_day0_data, lock_rctls_dir,
                               "02_timci_day0_data")
    
    deidentified_day0_data_id_duplicates <- timci::deidentify_data(day0_data_id_duplicates)
    fn <- timci::export_df2xlsx(deidentified_day0_data_id_duplicates, lock_rctls_dir,
                                "02a_timci_day0_data_id_duplicates")
    fn <- timci::export_df2csv(deidentified_day0_data_id_duplicates, lock_rctls_dir,
                               "02a_timci_day0_data_id_duplicates")
    
  } else {
    fn <- timci::export_df2xlsx(day0_data, params$rctls_dir,
                                "02_timci_day0_data")
    fn <- timci::export_df2csv(day0_data, params$rctls_dir,
                               "02_timci_day0_data")
    
    fn <- timci::export_df2xlsx(locked_day0_data, lock_rctls_dir,
                                "02_timci_day0_data")
    fn <- timci::export_df2csv(locked_day0_data, lock_rctls_dir,
                               "02_timci_day0_data")
    
    fn <- timci::export_df2xlsx(day0_data_id_duplicates, lock_rctls_dir,
                                "02a_timci_day0_data_id_duplicates")
    fn <- timci::export_df2csv(day0_data_id_duplicates, lock_rctls_dir,
                               "02a_timci_day0_data_id_duplicates")
  }
  
  xlsx_fname <- timci::export_df2xlsx(pii, tempdir(),
                                      "timci_contact_data")
  pii_pwd <- Sys.getenv("TIMCI_PII_PW")
  zip(params$participant_zip, 
      files = xlsx_fname, 
      flags = paste("-r9Xj --password", pii_pwd))
}
```

```{r export-visit-data, results = 'asis'}
facility_data_name <- "03_timci_facility_visits_data"
if (!is.null(facility_data)) {
  study_data <- timci::extract_all_visits(facility_data)
  
  if (deidentification_on == 1) {
    deidentified_facility_data <- timci::deidentify_data(study_data)
    fn <- timci::export_df2xlsx(deidentified_facility_data, params$rctls_dir, "03_timci_facility_visits_data")
    fn <- timci::export_df2csv(deidentified_facility_data, params$rctls_dir, "03_timci_facility_visits_data")
  } else {
    fn <- timci::export_df2xlsx(study_data, params$rctls_dir, "03_timci_facility_visits_data")
    fn <- timci::export_df2csv(study_data, params$rctls_dir, "03_timci_facility_visits_data")
  }
  cat(paste0("* Raw facility visit data are exported in ", facility_data_name, ".csv and ", facility_data_name, ".xslx in the ", params$rctls_dir, " folder"))
}
```

```{r export-RCT-LS-ODK-withdrawal, results = 'asis'}
withdrawal_export_name <- "99_withdrawal_data"
if (!is.null(raw_withdrawal_data)) {
  fn <- timci::export_df2xlsx(raw_withdrawal_data,
                              params$rctls_dir,
                              withdrawal_export_name)
  fn <- timci::export_df2csv(raw_withdrawal_data,
                             params$rctls_dir,
                             withdrawal_export_name)
  cat(paste0("* Raw withdrawal data are exported in ", withdrawal_export_name, ".csv and ", withdrawal_export_name, ".xslx in the ", params$rctls_dir, " folder"))
}
```

## Day 7 follow-up

### Load data

```{r format-RCT-LS-ODK-fu-day7-data}
day7fu_data <- NULL
allday7fu_data <- NULL
if (!is.null(raw_day7fu_data)) {
  if (nrow(raw_day7fu_data) > 0) {
    res <- timci::format_day7_data(raw_day7fu_data)
    day7fu_data <- res[[1]]
    allday7fu_data <- res[[3]]
  }
}
```

### Quality checks

#### Successful follow-up duplicates  

```{r, results='asis'}
cat("Rule: only one successful follow-up is kept with the following priority rule: day 7 > day 8 > day 9 > day 10 > day 6 > day 11 and above")
```

```{r check-RCT-LS-ODK-fu-day7-data, results='asis'}
if (!is.null(day7fu_data)) {
  day7fu_qc <- timci::detect_id_duplicates(day7fu_data)
  day7fu_duplicates <- day7fu_qc[day7fu_qc$id_fq > 1,]
  if (length(day7fu_duplicates) > 0) { 
    cat(paste0(nrow(day7fu_duplicates), "duplicated successful follow-ups detected."))
    knitr::kable(day7fu_duplicates,
                 caption = "ID duplicates",
                 row.names = FALSE)
  }
}

if (!is.null(day7fu_data)) {
  if (length(day7fu_duplicates) > 0) { 
    cat(paste0(nrow(day7fu_duplicates), "duplicated successful follow-ups detected."))
  }
}

```

#### Follow-up of enrolled children only

```{r}
# All follow-ups
locked_allday7fu_data <- allday7fu_data[allday7fu_data$child_id %in% locked_day0_data$child_id, ]
allday7fu_data_uids <- allday7fu_data[!allday7fu_data$child_id %in% locked_day0_data$child_id, ]
# Successful follow-ups
locked_day7fu_data <- day7fu_data[day7fu_data$child_id %in% locked_day0_data$child_id, ]
locked_day7fu_data <- locked_day7fu_data %>% dplyr::mutate(window = ifelse(days >= 7 & days <= 10, 1, 0))
# Process duplicates separately
day7fu_data_duplicates <- locked_day7fu_data[locked_day7fu_data$child_id %in% day7fu_duplicates$child_id, ]
day7fu_data_duplicates <- day7fu_data_duplicates %>%
  dplyr::group_by(child_id) %>%
  dplyr::slice_max(order_by = window) %>%
  dplyr::slice_min(order_by = days)
# Remove all duplicates from the list and concatenate with the filtered list
locked_day7fu_data <- locked_day7fu_data[!locked_day7fu_data$child_id %in% day7fu_duplicates$child_id, ]
locked_day7fu_data <- rbind(locked_day7fu_data, day7fu_data_duplicates)
```

### Export data

```{r export-RCT-LS-ODK-fu-day7-data}
if (!is.null(day7fu_data)) {
  
  fn <- timci::export_df2xlsx(day7fu_data,
                              params$rctls_dir,
                              "04b_timci_followup_successful_day7_data")
  fn <- timci::export_df2csv(day7fu_data,
                             params$rctls_dir,
                             "04b_timci_followup_successful_day7_data")
  
  fn <- timci::export_df2xlsx(locked_day7fu_data,
                              lock_rctls_dir,
                              "04b_timci_followup_successful_day7_data")
  fn <- timci::export_df2csv(locked_day7fu_data,
                             lock_rctls_dir,
                             "04b_timci_followup_successful_day7_data")
  
}
if (!is.null(allday7fu_data)) {
  
  fn <- timci::export_df2xlsx(allday7fu_data,
                              params$rctls_dir,
                              "04a_timci_followup_day7_data")
  fn <- timci::export_df2csv(allday7fu_data,
                             params$rctls_dir,
                             "04a_timci_followup_day7_data")
  
  fn <- timci::export_df2xlsx(locked_allday7fu_data,
                              lock_rctls_dir,
                              "04a_timci_followup_day7_data")
  fn <- timci::export_df2csv(locked_allday7fu_data,
                             lock_rctls_dir,
                             "04a_timci_followup_day7_data")
  
  fn <- timci::export_df2xlsx(allday7fu_data_uids,
                              lock_rctls_dir,
                              "04c_timci_followup_day7_data_unknown_ids")
  fn <- timci::export_df2csv(allday7fu_data_uids,
                             lock_rctls_dir,
                             "04c_timci_followup_day7_data_unknown_ids")
  
}
```

## Hospitalisation follow-up

### Load data

```{r format-RCT-LS-ODK-fu-hospit-data}
hospit_data <- NULL
if (!is.null(raw_hospit_data)) {
  hospit_data <- timci::format_hospital_data(raw_hospit_data)
}
```

### Quality checks

```{r check-RCT-LS-ODK-fu-hospit-data, results='asis'}
if (!is.null(hospit_data)) {
  if (length(hospit_data) > 0) { 
    hospit_data_duplicates <- timci::detect_id_duplicates(hospit_data)
    if (length(hospit_data_duplicates) > 0) { 
         knitr::kable(hospit_data_duplicates, caption = "ID duplicates")
    } else {
      cat("No ID duplicates detected")
    }
  }
}
```

### Export data

```{r export-RCT-LS-ODK-fu-hospit-data}
if (!is.null(hospit_data)) {
  fn <- timci::export_df2xlsx(hospit_data, params$rctls_dir,
                              "05_timci_followup_hospit_data")
  fn <- timci::export_df2csv(hospit_data, params$rctls_dir,
                             "05_timci_followup_hospit_data")
}
```

## Day 28 follow-up

```{r format-RCT-LS-ODK-fu-day28-data}
if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  day28fu_data <- NULL
  allday28fu_data <- NULL
  if (!is.null(raw_day28fu_data)) {
    if (nrow(raw_day28fu_data) > 0) {
      res <- timci::format_day28_data(raw_day28fu_data)
      day28fu_data <- res[[1]]
      allday28fu_data <- res[[3]]
    }
  }
}
```

### Quality checks

```{r check-RCT-LS-ODK-fu-day28-data, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  if (!is.null(day28fu_data)) {
    day28fu_qc <- timci::detect_id_duplicates(day28fu_data)
    day28fu_duplicates <- day28fu_qc[day28fu_qc$id_fq > 1,]
    if (length(day28fu_duplicates) > 0) { 
         knitr::kable(day28fu_duplicates,
                      caption = "ID duplicates",
                      row.names = FALSE)
    } else {
      cat("No ID duplicates detected")
    }
  }
}
```

#### Follow-up of enrolled children only

```{r}
if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  if (!is.null(day28fu_data)) {
    # All follow-ups
    locked_allday28fu_data <- allday28fu_data[allday28fu_data$child_id %in% locked_day0_data$child_id, ]
    allday28fu_data_uids <- allday28fu_data[!allday28fu_data$child_id %in% locked_day0_data$child_id, ]
    # Successful follow-ups
    locked_day28fu_data <- day28fu_data[day28fu_data$child_id %in% locked_day0_data$child_id, ]
    locked_day28fu_data <- locked_day7fu_data %>% dplyr::mutate(window = ifelse(days >= 28 & days <= 32, 1, 0))
    # Process duplicates separately
    day28fu_data_duplicates <- locked_day28fu_data[locked_day28fu_data$child_id %in% day28fu_duplicates$child_id, ]
    day28fu_data_duplicates <- day28fu_data_duplicates %>%
      dplyr::group_by(child_id) %>%
      dplyr::slice_max(order_by = window) %>%
      dplyr::slice_min(order_by = days)
    # Remove all duplicates from the list and concatenate with the filtered list
    locked_day28fu_data <- locked_day28fu_data[!locked_day28fu_data$child_id %in% day28fu_duplicates$child_id, ]
    locked_day28fu_data <- rbind(locked_day28fu_data, day28fu_data_duplicates)
  }
}
```

```{r export-RCT-LS-ODK-fu-day28-data}
if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  if (!is.null(day28fu_data)) {
    fn <- timci::export_df2xlsx(day28fu_data, params$rctls_dir,
                                "06_timci_followup_successful_day28_data")
    fn <- timci::export_df2csv(day28fu_data, params$rctls_dir,
                               "06_timci_followup_successful_day28_data")
  }
  if (!is.null(allday28fu_data)) {
    fn <- timci::export_df2xlsx(allday28fu_data, params$rctls_dir, "06a_timci_followup_day28_data")
    fn <- timci::export_df2csv(allday28fu_data, params$rctls_dir, "06a_timci_followup_day28_data")
  }
}
```

## Problem report data

```{r export-RCT-LS-ODK-problem}
if (!is.null(raw_problem_data)) {
  fn <- timci::export_df2xlsx(raw_problem_data, params$rctls_dir,
                              "98_problem_data")
  fn <- timci::export_df2csv(raw_withdrawal_data, params$rctls_dir,
                             "98_problem_data")
}
```

# Service Provision Assessment (SPA)

## Caregiver exit interview

```{r cg-exit-interview-export}
if (!is.null(spa_cgei_data)) {
  fn <- timci::export_df2xlsx(spa_cgei_data, params$spa_dir,
                              "03_timci_spa_exit_interview_data")
  fn <- timci::export_df2csv(spa_cgei_data, params$spa_dir,
                             "03_timci_spa_exit_interview_data")
}
```

## Facility assessment

```{r facility-assessment-export}
if (!is.null(spa_fa_data)) {
  fn <- timci::export_df2xlsx(spa_fa_data, params$spa_dir,
                              "01_timci_spa_facility_assessment_data")
  fn <- timci::export_df2csv(spa_fa_data, params$spa_dir,
                             "01_timci_spa_facility_assessment_data")
}
```

## Healthcare provider interview

```{r hcp-interview-export}
if (!is.null(spa_hcpi_data)) {
  spa_hcpi_data <- process_spa_hcpi_data(spa_hcpi_data)
  fn <- timci::export_df2xlsx(spa_hcpi_data, params$spa_dir,
                              "02_timci_spa_provider_interview_data")
  fn <- timci::export_df2csv(spa_hcpi_data, params$spa_dir,
                             "02_timci_spa_provider_interview_data")
}
```

## Sick child observation protocol

```{r}
# Extract entries of child IDs enrolled in the Day 0 database
locked_spa_sco_data <- spa_sco_data[spa_sco_data$'child_identification-pid' %in% locked_day0_data$child_id, ]
spa_sco_data_uids <- spa_sco_data[!spa_sco_data$'child_identification-pid' %in% locked_day0_data$child_id, ]
```

```{r sick-child-observation-export}
print("Sick child observation protocol data export")
if (!is.null(spa_sco_data)) {
  if (deidentification_on == 1) {
    deidentified_spa_sco_data <- timci::deidentify_spa_data(spa_sco_data)
    fn <- timci::export_df2xlsx(deidentified_spa_sco_data, params$spa_dir,
                                "04_timci_spa_consultation_obs_data")
    fn <- timci::export_df2csv(deidentified_spa_sco_data, params$spa_dir,
                               "04_timci_spa_consultation_obs_data")
    fn <- timci::export_df2xlsx(locked_spa_sco_data,
                              lock_rctls_dir,
                              "04_timci_spa_consultation_obs_data")
    fn <- timci::export_df2csv(locked_spa_sco_data,
                               lock_rctls_dir,
                               "04_timci_spa_consultation_obs_data")
    
    fn <- timci::export_df2xlsx(spa_sco_data_uids,
                                lock_rctls_dir,
                                "04_timci_spa_consultation_obs_data_unknown_ids")
    fn <- timci::export_df2csv(spa_sco_data_uids,
                               lock_rctls_dir,
                               "04_timci_spa_consultation_obs_data_unknown_ids")
  } else {
    fn <- timci::export_df2xlsx(spa_sco_data, params$spa_dir,
                                "04_timci_spa_consultation_obs_data")
    fn <- timci::export_df2csv(spa_sco_data, params$spa_dir,
                               "04_timci_spa_consultation_obs_data")
    
    fn <- timci::export_df2xlsx(locked_spa_sco_data,
                              lock_rctls_dir,
                              "04_timci_spa_consultation_obs_data")
    fn <- timci::export_df2csv(locked_spa_sco_data,
                               lock_rctls_dir,
                               "04_timci_spa_consultation_obs_data")
    
    fn <- timci::export_df2xlsx(spa_sco_data_uids,
                                lock_rctls_dir,
                                "04_timci_spa_consultation_obs_data_unknown_ids")
    fn <- timci::export_df2csv(spa_sco_data_uids,
                               lock_rctls_dir,
                               "04_timci_spa_consultation_obs_data_unknown_ids")
  }
  
}
```

## Time-flow

```{r time-flow-export}
if (!is.null(tf_data)) {
  if (!is.null(tf_data[[1]])) {
    fn <- timci::export_df2xlsx(tf_data[[1]], params$spa_dir,
                                "05a_timci_timeflow_data")
    fn <- timci::export_df2csv(tf_data[[1]], params$spa_dir,
                               "05a_timci_timeflow_data")
  }
  if (!is.null(tf_data[[2]])) {
    fn <- timci::export_df2xlsx(tf_data[[2]], params$spa_dir,
                                "05b_timci_timeflow_audit")
    fn <- timci::export_df2csv(tf_data[[2]], params$spa_dir,
                               "05b_timci_timeflow_audit")
  }
  if (!is.null(tf_data[[3]])) {
    fn <- timci::export_df2xlsx(tf_data[[3]], params$spa_dir,
                                "05c_timci_timeflow_steps")
    fn <- timci::export_df2csv(tf_data[[3]], params$spa_dir,
                               "05c_timci_timeflow_steps")
  }
}
```

# Qualitative studies

## Caregiver in-depth interview

```{r cg-idi-potential-participants}
if (!is.null(day0_data) && !is.null(day7fu_data)) {
  cg_qual_export_data <- timci::generate_cg_log(day0_data, day7fu_data)
  fn <- timci::export_df2xlsx(cg_qual_export_data, qual1_dir,
                              "cg_idi_participants")
  fn <- timci::export_df2csv(cg_qual_export_data, qual1_dir,
                             "cg_idi_participants")
}
```

```{r cg-idi-invitation-export}
if (!is.null(cgidi_invitation_data)) {
  fn <- timci::export_df2xlsx(cgidi_invitation_data, qual1_dir,
                              "01_timci_cg_invitation_data")
}
```

```{r cg-idi-encryption-export}
if (!is.null(cgidi_encryption_data)) {
  fn <- timci::export_df2xlsx(cgidi_encryption_data, qual1_dir,
                              "02_timci_cg_encryption_data")
}
```

```{r cg-idi-interview-export}
if (!is.null(cgidi_interview_data)) {
  fn <- timci::export_df2xlsx(cgidi_interview_data, qual1_dir,
                              "03_timci_cg_interview_data")

  sl <- ruODK::submission_list(pid = qpid,
                               fid = cgidi3_fid)
  
  # Loop on all rows
  for (i in 1:nrow(sl)) {
    crow <- cgidi_interview_data[i,]
    uuid <- crow$'meta-instanceID'
    cpath <- file.path(qual1_dir, crow$'identification-idiidm')
    print(paste0("Participant: ", crow$'identification-idiidm'))
    dir.create(cpath, showWarnings = FALSE)
    # Create a new dataframe using the transpose of crow
    tcrow <- as.data.frame(t(as.matrix(crow)))
    names(tcrow)[names(tcrow) == "V1"] <- "values"
    fname <- file.path(cpath, paste("data", "_", Sys.Date(), ".xlsx", sep = ""))
    openxlsx::write.xlsx(tcrow, fname, row.names = TRUE)
    
    # Download attachments
    al <- ruODK::get_one_submission_attachment_list(pid = qpid,
                                                    fid = cgidi3_fid,
                                                    uuid)
    for (j in 1:nrow(al)) {
      aid <- al$name[[j]]
      print(paste0("Attachment: ", aid))
      ruODK::attachment_get(pid = qpid,
                            fid = cgidi3_fid,
                            uuid, 
                            aid,
                            local_dir = cpath)
    }
  }
}
```
