---
title: "TIMCI M&E report"
author: "`r if (Sys.getenv('TIMCI_COUNTRY') == 'Tanzania') {'Ifakara Health Institute (IHI)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'India') {'King George s Medical University (KGMU)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {'Universit√© Cheikh Anta Diop de Dakar (UCAD)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Kenya') {'University of Nairobi (UoN)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Myanmar') {'Burnet Institute (BI)'} else {'Swiss Tropical and Public Health Institute (Swiss TPH)'}`"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
params:
  path_dir: !r tempdir()
  facility_data: NULL
  wfa_data: NULL
output:
  html_document: default
  word_document:
    reference_docx: word_styles1.docx
    fig_width: 7.5
---

```{r setup-rmd, include=FALSE, warning=FALSE}
library(timci)
library(magrittr)
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r}
stats <- timci::get_summary_by_facility(params$facility_data)
```

```{r, results = "asis"}
form_list <- ruODK::form_list()$fid
if (!is.null(params$wfa_data)) {
  
  if (nrow(params$wfa_data) > 0) {
    
    last_data <- extract_last_fa_data(params$wfa_data, stats)
    soc_data <- last_data[last_data$'page1_arm' == 0,]
    pox_data <- last_data[last_data$'page1_arm' == 1,]
    cdsa_data <- last_data[last_data$'page1_arm' == 2,]
    
    if (nrow(pox_data) > 0) {
      cat('# Facilities with pulse oximetry alone\n\n')
      display_weekly_fa_data_per_facility(pox_data, params$wfa_data)
    }
    if (nrow(cdsa_data) > 0) {
      cat('# Facilities with pulse oximetry and CDSA\n\n')
      display_weekly_fa_data_per_facility(cdsa_data, params$wfa_data)
    }
    
    tmp <- timci::export_df2xlsx(format_weekly_fa_data_for_export(last_data), params$path_dir, "path_data")
    
  }
  
}
```
