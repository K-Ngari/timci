---
title: "TIMCI M&E report"
author: "`r Sys.getenv('TIMCI_INSTITUTION')`"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
params:
  path_dir: "."
output:
  html_document: default
  word_document:
    reference_docx: word_styles1.docx
---

```{r setup, include=FALSE, warning=FALSE}
library(timci)
library(magrittr)
knitr::opts_chunk$set(echo = TRUE)
```

```{r ruODK-setup, echo=FALSE}
ruODK::ru_setup(
  svc = Sys.getenv("ODKC_SVC"),
  un = Sys.getenv("ODKC_UN"),
  pw = Sys.getenv("ODKC_PW"),
  tz = Sys.getenv("TZ"),
  verbose = FALSE # Can be switched to TRUE for demo or debugging
)
```

```{r, echo=FALSE}
crf_facility_fid <- Sys.getenv("TIMCI_CRF_FACILITY_FID")
raw_facility_data <- ruODK::odata_submission_get(fid = crf_facility_fid,
                                                 download = FALSE)
facility_data <- timci::process_facility_data(raw_facility_data)
stats <- timci::get_summary_by_facility(facility_data)
```

```{r, echo=FALSE}
crf_wfa_fid <- Sys.getenv("TIMCI_WEEKLY_FA_FID")
raw_wfa_data <- ruODK::odata_submission_get(fid = crf_wfa_fid,
                                            download = FALSE)
wfa_data <- timci::process_weekly_fa_data(raw_wfa_data)
```

```{r, echo=FALSE}
last_data <- extract_last_fa_data(wfa_data, stats)
soc_data <- last_data[last_data$'page1_arm' == 0,]
pox_data <- last_data[last_data$'page1_arm' == 1,]
cdsa_data <- last_data[last_data$'page1_arm' == 2,]
```

```{r, echo=FALSE, results='asis'}
if (nrow(pox_data) > 0) {
  cat('# Facilities with pulse oximetry alone\n\n')
  display_weekly_fa_data_per_facility(pox_data, wfa_data)
}
if (nrow(cdsa_data) > 0) {
  cat('# Facilities with pulse oximetry and CDSA\n\n')
  display_weekly_fa_data_per_facility(cdsa_data, wfa_data)
}
```

```{r xlsx-export, echo=FALSE}
tmp <- timci::export_df2xlsx(format_weekly_fa_data_for_export(last_data), params$path_dir, "path_data")
```
