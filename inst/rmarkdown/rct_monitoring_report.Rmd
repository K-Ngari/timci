---
title: "TIMCI `r if (Sys.getenv('TIMCI_COUNTRY') == 'Tanzania' || Sys.getenv('TIMCI_COUNTRY') == 'India') {'Pragmatic cluster RCT - Monitoring Report'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {'Étude Longitudinale Observationnelle - Rapport de suivi'} else {'Longitudinal Observational Study (LS) - Monitoring Report'}`"
author: "`r if (Sys.getenv('TIMCI_COUNTRY') == 'Tanzania') {'Ifakara Health Institute (IHI)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'India') {'King Georges Medical University (KGMU)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {'Université Cheikh Anta Diop de Dakar (UCAD)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Kenya') {'University of Nairobi (UoN)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Myanmar') {'Burnet Institute (BI)'} else {'Swiss Tropical and Public Health Institute (Swiss TPH)'}`"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M')`"
params:
  research_facilities: !r data.frame(deviceid = character(0), district = character(0), facility = character(0))
  start_date: NULL
  end_date: NULL
  day7fu_end_date: NULL
  sample_target: NULL
  facility_data: NULL
  raw_day7fu_data: NULL
  raw_hospit_data: NULL
  raw_day28fu_data: NULL<
  raw_withdrawal_data: NULL
  wfa_data: NULL
output:
  pdf_document:
    number_sections: true
    extra_dependencies:
      float: null
      flafter: null
      bm: null
      tocbibind: ["nottoc"]
      babel: ["french","english"]
      graphicx: null
      fancyhdr: null
      lastpage: null
classoption: table
---

```{r setup-rmd, include=FALSE}
library(magrittr)
library(readxl)
library(ggplot2)
library(lubridate)
library(gridExtra)
library(knitr)
library(kableExtra)
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      fig.pos='!H')
options(qwraps2_markup = 'rmarkdown')
options(knitr.table.format = "latex")

# Qwraps2 parameters
prec <- 1

#kableExtra table parameters
table_fs <- 7
figsize <- 3
total_row_ft <- "gray"
total_row_ft2 <- "white"
striped_row_bg <- "gray!10"
total_row_bg2 <- "gray"

if (Sys.getenv('TIMCI_COUNTRY') == "India") {
  hospit_value <- 13
} else{
  hospit_value <- 1
}
```

\fancypagestyle{plain}{\pagestyle{fancy}}
\pagestyle{fancy}
\fancyhf{}
\setlength{\headheight}{32pt}
\renewcommand{\headrulewidth}{0pt}
\fancyhead[C]{\includegraphics[width=10cm]{banner.png}}
\fancyfoot[R]{Page \thepage\ of \pageref{LastPage}}
\fancyfoot[L]{TIMCI Data Monitoring Report v1.0 - Template: H. LANGET (Swiss TPH)}

```{r translations-subsection, child = 'translations.Rmd'}
```

\setcounter{tocdepth}{2}
\tableofcontents

\newpage

`r notice_str`

`r intro_str`

```{r setup-variables}
start_date <- params$start_date
end_date <- params$end_date
sample_target <- params$sample_target

if (!is.null(params$facility_data)) {
  
  facility_data <- params$facility_data
  raw_day7fu_data <- params$raw_day7fu_data
  raw_hospit_data <- params$raw_hospit_data
  raw_day28fu_data <- params$raw_day28fu_data
  raw_withdrawal_data <- params$raw_withdrawal_data
  wfa_data <- params$wfa_data
  
}

# Add facility generic information to the RCT/LS facility data
facility_data <- timci::allocate_screening_facility(facility_data,
                                                    params$research_facilities)

# Extract personally identifiable information from RCT/LS facility data
pii <- timci::extract_enrolled_participants(facility_data)[[2]]
# Add facility generic information to personally identifiable information
pii <- timci::allocate_screening_facility(pii,
                                          params$research_facilities)

if (!is.null(raw_day7fu_data)) {
  if (nrow(raw_day7fu_data) > 0) {
    raw_day7fu_data <- merge(x = raw_day7fu_data,
                             y = params$research_facilities[, c("facility_id", "facility_name")],
                             by.x = 'a1-fid',
                             by.y = 'facility_id',
                             all = FALSE)
  }
}

# if (!is.null(raw_hospit_data)) {
#   if (nrow(raw_hospit_data) > 0) {
#     raw_hospit_data <- merge(x = raw_hospit_data,
#                              y = params$research_facilities[, c("facility_id", "facility_name")],
#                              by.x = 'a1-fid',
#                              by.y = 'facility_id',
#                              all = FALSE)
#   }
#}
```

```{r}
rct_cond <- (Sys.getenv('TIMCI_COUNTRY') == 'Tanzania') | (Sys.getenv('TIMCI_COUNTRY') == 'India')
```

```{r}
if (rct_cond) {
  if (!is.null(raw_day28fu_data)) {
    if (nrow(raw_day28fu_data) > 0) {
      raw_day28fu_data <- merge(x = raw_day28fu_data,
                               y = params$research_facilities[, c("facility_id", "facility_name")],
                               by.x = 'a1-fid',
                               by.y = 'facility_id',
                               all = FALSE)
    }
  }
}
```

```{r process-facility-data, results='asis'}
if (nrow(facility_data) > 0) {
  week_nb <- ceiling(difftime(as.Date(end_date), as.Date(start_date) - 1, units = "weeks"))
  days_nb <- sum(!lubridate::wday(seq(as.Date(start_date), as.Date(end_date), "days")) %in% c("7", "1"))
  
  if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
    date_boundary_str <- paste0("Ce rapport couvre la période du **", start_date, "** (début de l'étude) au **", end_date, "** (semaine **", week_nb, "** de l'étude) pour le **Sénégal**.")
  } else {
    date_boundary_str <- paste0("This report covers the period from **", start_date, "** (study start) to **", end_date, "** (week **", week_nb,"** of the study) for **", Sys.getenv('TIMCI_COUNTRY'), "**.")
  }
  
  cat(date_boundary_str)
}
```

```{r context-subsection, child = 'context.Rmd'}
```

\newpage

```{r, results = "asis"}
n_total <- 0

# Screening data
n_screened <- nrow(facility_data)
screening_data <- timci::extract_screening_data(facility_data)
visit_names <- c(screening_str)
submissions <- c(n_screened)
n_total <- n_total + n_screened

study_data <- timci::extract_all_visits(facility_data)
res <- timci::extract_enrolled_participants(facility_data)
noneligible <- timci::extract_noneligible(facility_data)

# Baseline data
baseline_data <- timci::extract_baseline_visits(study_data)
baseline_data <- timci::allocate_screening_facility(baseline_data,
                                                    params$research_facilities)

demog_data <- res[[1]]
n_enrolled <- nrow(demog_data)
n_enrolled7 <- nrow(dplyr::filter(demog_data, date_visit >= as.Date(end_date - 6)))
n_enrolled28 <- nrow(dplyr::filter(demog_data, date_visit >= as.Date(end_date - 27)))
visit_names <- c(visit_names, paste0(baseline_str, kableExtra::footnote_marker_number(1)))
submissions <- c(submissions, n_enrolled)

# Count facility submissions corresponding to repeat visits
repeat_data <- timci::extract_repeat_visits(study_data)
n_repeat <- nrow(repeat_data)
visit_names <- c(visit_names, paste0(repeat_str, kableExtra::footnote_marker_number(2)))
submissions <- c(submissions, n_repeat)

# Count Day 7 phone call submissions
if (!is.null(raw_day7fu_data)) {
  n_day7fu <- nrow(raw_day7fu_data)
  visit_names <- c(visit_names, day7_phone_call_str)
  submissions <- c(submissions, n_day7fu)
  n_total <- n_total + n_day7fu
}

if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  if (!is.null(raw_day28fu_data)) {
    n_day28fu <- nrow(raw_day28fu_data)
    visit_names <- c(visit_names, "Day 28 phone call")
    submissions <- c(submissions, n_day28fu)
    n_total <- n_total + n_day28fu
  }
}

# Count hospital visit submissions
if (!is.null(raw_hospit_data)) {
  n_hospit <- nrow(raw_hospit_data)
  visit_names <- c(visit_names, hospital_submission_str)
  submissions <- c(submissions, n_hospit)
  n_total <- n_total + n_hospit
}

# Count withdrawal submissions
if (!is.null(raw_withdrawal_data)) {
  n_withdrawal <- nrow(raw_withdrawal_data)
  visit_names <- c(visit_names, withdrawal_str)
  submissions <- c(submissions, n_withdrawal)
  n_total <- n_total + n_withdrawal
}
```

`r title_str`

```{r, eval = FALSE, results='asis'}
#timci::text_2_plot(paste0(days_nb))
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == "Senegal") {
  wdays_str <- " jours travaillés depuis le début de la collecte de données."
} else{
  wdays_str <- " working days since the start of the data collection."
}
cat(paste0(days_nb, wdays_str))
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == "Kenya") {
  hc_enrolment_target <- 14
  dispensary_enrolment_target <- 6
  day_target <- dispensary_enrolment_target * dispensary_nb + hc_enrolment_target * hc_nb
  enrolment_target <- round(day_target / facility_nb, 0)
} else if (Sys.getenv('TIMCI_COUNTRY') == "Senegal") {
  enrolment_target <- 4
} else if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania") {
  hc_enrolment_target <- 16
  dispensary_enrolment_target <- 4
  day_target <- dispensary_enrolment_target * dispensary_nb + hc_enrolment_target * hc_nb
  enrolment_target <- round(day_target / facility_nb, 0)
} else if (Sys.getenv('TIMCI_COUNTRY') == "India") {
  hc_enrolment_target <- 6
  dispensary_enrolment_target <- 1
  day_target <- dispensary_enrolment_target * dispensary_nb + hc_enrolment_target * hc_nb
  enrolment_target <- round(day_target / facility_nb, 0)
} else{
  enrolment_target <- 8
}
```

```{r, results='asis'}
cat(paste0(sample_size_str, sample_target))
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') != "Tanzania" || Sys.getenv('TIMCI_COUNTRY') != "Kenya") {
  day_target <- enrolment_target * facility_nb
  if (Sys.getenv('TIMCI_COUNTRY') == "Senegal") {
    cat(paste0("Cible de recrutement quotidienne : ", enrolment_target))
  } else{
    cat(paste0("Daily enrolment target: ", enrolment_target))
  }
} else{
  cat(paste0("Daily enrolment target: ", dispensary_enrolment_target, " (dispensaries) and ", hc_enrolment_target, " (health centres), with ", enrolment_target, " as an average target if the facility type is not taken into account"))
}
```

```{r, results='asis'}
if (nrow(facility_data) > 0) {
  plot0 <- timci::plot_gauge(n_enrolled/sample_target, plot0_str, 100, 75, 90, scale = 0.4)
  plot1 <- timci::plot_gauge(n_enrolled28/(min(20, days_nb) * day_target), plot1_str, 100, 62.5, 90, scale = 0.4)
  plot2 <- timci::plot_gauge(n_enrolled7/(min(5, days_nb) * day_target), plot2_str, 100, 62.5, 90, scale = 0.4)
  plot3 <- timci::plot_gauge(n_enrolled/(n_screened - n_repeat), plot3_str, 100, 70, 80, scale = 0.4)
}
```

```{r, results='asis'}
day7_wmin <- 7
day7_wmax <- 10

day7fu_data <- NULL
if (!is.null(raw_day7fu_data)) {
  if (nrow(raw_day7fu_data) > 0) {
    
    # Extract and clean all Day 7 follow-up data
    day7fu_data <- timci::format_day7_data(raw_day7fu_data)[[3]]
    day7fu_data <- day7fu_data[day7fu_data$child_id %in% baseline_data$child_id, ]
    
    # Extract and clean successful Day 7 follow-up data
    succ_day7fu_data <- timci::format_day7_data(raw_day7fu_data)[[1]]
    succ_day7fu_data <- clean_followup_for_rate_estimation(baseline_data, succ_day7fu_data)
    
    n_completed_day7fu <- sum((as.Date(succ_day7fu_data$date_day0, "%Y-%m-%d") + day7_wmin) <= Sys.Date(), na.rm = TRUE) 
    n_valid_day7fu <- sum(((as.Date(succ_day7fu_data$date_day0, "%Y-%m-%d") + day7_wmin) <= Sys.Date()) & (succ_day7fu_data$days >= day7_wmin) & (succ_day7fu_data$days <= day7_wmax), na.rm = TRUE) 
  } else {
    n_completed_day7fu <- 0
    n_valid_day7fu <- 0
  }
} else {
  n_completed_day7fu <- 0
  n_valid_day7fu <- 0
}
```

```{r}
n_due_day7fu <- sum((as.Date(demog_data$date_visit, "%Y-%m-%d") + day7_wmin) <= Sys.Date())
```

```{r, results='asis'}
if (n_due_day7fu > 0) {
  n_day7fu_rate <- n_completed_day7fu/n_due_day7fu
  n_day7fu_rate100 <- round(100 * n_day7fu_rate, prec)
  plot4 <- timci::plot_gauge(n_day7fu_rate, plot4_str, 100, 85, 95, scale = 0.4)
  plot5 <- timci::plot_gauge(n_valid_day7fu/n_due_day7fu, plot5_str, 100, 85, 95, scale = 0.4)
}
```

```{r, results='asis'}
day28_wmin <- 28
day28_wmax <- 32

if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  day28fu_data <- NULL
  if (!is.null(raw_day28fu_data)) {
    if (nrow(raw_day28fu_data) > 0) {
      
      # Extract and clean all Day 28 follow-up data
      day28fu_data <- timci::format_day28_data(raw_day28fu_data)[[3]]
      day28fu_data <- day28fu_data[day28fu_data$child_id %in% baseline_data$child_id, ]
      
      # Extract and clean successful Day 28 follow-up data
      succ_day28fu_data <- timci::format_day28_data(raw_day28fu_data)[[1]]
      succ_day28fu_data <- clean_followup_for_rate_estimation(baseline_data, succ_day28fu_data)
      
      n_completed_day28fu <- sum((as.Date(succ_day28fu_data$date_day0, "%Y-%m-%d") + day28_wmin) <= Sys.Date(), na.rm = TRUE) 
      n_valid_day28fu <- sum(((as.Date(succ_day28fu_data$date_day0, "%Y-%m-%d") + day28_wmin) <= Sys.Date()) & (succ_day28fu_data$days >= day28_wmin) & (succ_day28fu_data$days <= day28_wmax), na.rm = TRUE) 
    } else {
      n_completed_day28fu <- 0
      n_valid_day28fu <- 0
    }
  } else {
    n_completed_day28fu <- 0
    n_valid_day28fu <- 0
  }
  
  n_due_day28fu <- sum((as.Date(demog_data$date_visit, "%Y-%m-%d") + day28_wmin) <= Sys.Date())
}
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  if (n_due_day28fu > 0) {
    plot7 <- timci::plot_gauge(n_completed_day28fu/n_due_day28fu, "Day 28 follow-up rate", 100, 85, 95, scale = 0.4)
    plot8 <- timci::plot_gauge(n_valid_day28fu/n_due_day28fu, "Day 28 follow-up rate\nwithin the time window", 100, 85, 95, scale = 0.4)
  } 
}
```

```{r, results='asis'}
if (n_due_day7fu > 0) {
  if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
    if (n_due_day28fu > 0){
      gridExtra::grid.arrange(plot0, plot1, plot2, plot3, plot4, plot5, plot7, plot8,
                              ncol = 3, nrow = 3,
                              widths = unit(c(6,6,6), c("cm", "cm", "cm")),
                              heights = unit(c(4,4,4), c("cm", "cm", "cm")))
    } else{
      gridExtra::grid.arrange(plot0, plot1, plot2, plot3, plot4, plot5,
                            ncol = 3, nrow = 3,
                            widths = unit(c(6,6,6), c("cm", "cm", "cm")),
                            heights = unit(c(4,4,4), c("cm", "cm", "cm")))
    }
  } else{
    gridExtra::grid.arrange(plot0, plot1, plot2, plot3, plot4, plot5,
                            ncol = 3, nrow = 3,
                            widths = unit(c(6,6,6), c("cm", "cm", "cm")),
                            heights = unit(c(4,4,4), c("cm", "cm", "cm")))
  }
} else{
  gridExtra::grid.arrange(plot0, plot1, plot2, plot3,
                          ncol = 3, nrow = 3,
                          widths = unit(c(6,6,6), c("cm", "cm", "cm")),
                          heights = unit(c(4,4,4), c("cm", "cm", "cm")))
}
```

```{r submissions-1, results = "asis"}
visit_names <- c(all_str, visit_names)
submissions <- c(n_total, submissions)

out <- data.frame(visit_names, submissions)
out %>%
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  col.names = c("Submission", "N"),
                  align = c("l", "c"),
                  caption = submission_table_cap,
                  escape = FALSE) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"),
                            font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg) %>%
  kableExtra::footnote(number = c("Day 0 visit (enrolment on the same day as the screening).",
                                  "All other visits that occur during the enrolment period."),
                       escape = FALSE)
```

```{r ls-full-participant-journey}
all <- baseline_data[, c("child_id", "facility_name", "date_visit")]
if (!is.null(day7fu_data)) {
  if (nrow(day7fu_data) > 0) {
    all <- all %>%
      merge(y = succ_day7fu_data[, c("child_id", "proceed_day7", "hf_visit_type", "status_day7")],
            by = 'child_id',
            all.x = TRUE)
  }
}

# Create an empty column if Day 7 follow-up has not started yet
all["proceed_day7"[!("proceed_day7" %in% colnames(all))]] <- 0
all["hf_visit_type"[!("hf_visit_type" %in% colnames(all))]] <- 0
all["status_day7"[!("status_day7" %in% colnames(all))]] <- 0

all$due_day7 <- (as.Date(all$date_visit, "%Y-%m-%d") + day7_wmin) <= Sys.Date()
all$proceed_day7[is.na(all$proceed_day7)] <- 0
all$lost_day7 <- ((as.Date(all$date_visit, "%Y-%m-%d") + day7_wmax) <= Sys.Date()) & (all$proceed_day7 == 0)

if (!is.null(raw_hospit_data)) {
  if (nrow(raw_hospit_data) > 0) {
    hospit_data <- format_hospital_data(raw_hospit_data) %>%
      dplyr::distinct_at(dplyr::vars(child_id),
                         .keep_all = TRUE)
    all <- all %>%
      merge(y = hospit_data[, c("child_id", "found")],
            by = 'child_id',
            all.x = TRUE)
  }
}

# Create an empty column if hospital follow-up has not started yet
all["found"[!("found" %in% colnames(all))]] <- 0
all$found[is.na(all$found)] <- 0
all$hospitalised <- (all$status_day7 == 2) | (all$hf_visit_type == hospit_value)
all$hospitalised[is.na(all$hospitalised)] <- 0
```

```{r rct-full-participant-journey, eval = rct_cond}
if (!is.null(day28fu_data)) {
  if (nrow(day28fu_data) > 0) {
    all <- all %>%
      merge(y = succ_day28fu_data[, c("child_id", "proceed_day28")],
            by = 'child_id',
            all.x = TRUE)
  }
}

# Create an empty column if Day 28 follow-up has not started yet
all["proceed_day28"[!("proceed_day28" %in% colnames(all))]] <- 0

all$due_day28 <- (as.Date(all$date_visit, "%Y-%m-%d") + day28_wmin) <= Sys.Date()
all$proceed_day28[is.na(all$proceed_day28)] <- 0
all$lost_day28 <- ((as.Date(all$date_visit, "%Y-%m-%d") + day28_wmax) <= Sys.Date()) & (all$proceed_day28 == 0)
```

```{r all-completion, eval = rct_cond}
completion_summary <- list(
  "Summary" = list(
    "Day 7 and Day 28" = ~qwraps2::n_perc(proceed_day7 == 1 & proceed_day28 == 1, prec),
    "Day 7 or Day 28" = ~qwraps2::n_perc(proceed_day7 == 1 | proceed_day28 == 1, prec),
    "None" = ~qwraps2::n_perc(proceed_day7 == 0 & proceed_day28 == 0, prec)
    )
)
out <- format_summary_table(all,
                            completion_summary,
                            facility_name)
out %>%
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  align = c("c", "c", "c"),
                  caption = tcap_all_completion) %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"),
                            font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
```

```{r day7fu-completion}
completion_summary <- list(
  "Summary" = list(
    "Due" = ~qwraps2::n_perc(due_day7 == 1, prec),
    "Completed" = ~qwraps2::n_perc(proceed_day7 == 1, prec),
    "Lost" = ~qwraps2::n_perc(lost_day7 == 1, prec)
    )
)
out <- format_summary_table(all,
                            completion_summary,
                            facility_name)
out %>%
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  align = c("c", "c"),
                  caption = tcap_day7fu_completion) %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"),
                            font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
```

```{r hospit-completion}
completion_summary <- list(
  "Summary" = list(
    "Due" = ~qwraps2::n_perc(hospitalised == 1, prec),
    "Completed" = ~qwraps2::n_perc(found == 1 & hospitalised == 1, prec),
    "Completed (not due)" = ~qwraps2::n_perc(found == 1 & hospitalised == 0, prec),
    "Lost" = ~qwraps2::n_perc(found == 0 & hospitalised == 1, prec)
    )
)
out <- format_summary_table(all,
                            completion_summary,
                            facility_name)
out %>%
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  align = c("c", "c", "c", "c"),
                  caption = tcap_hospit_completion) %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"),
                            font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
```

```{r day28fu-completion, eval = rct_cond}
completion_summary <- list(
  "Summary" = list(
    "Due" = ~qwraps2::n_perc(due_day28 == 1, prec),
    "Completed" = ~qwraps2::n_perc(proceed_day28 == 1, prec),
    "Lost" = ~qwraps2::n_perc(lost_day28 == 1, prec)
    )
)
out <- format_summary_table(all,
                            completion_summary,
                            facility_name)
out %>%
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  align = c("c", "c", "c"),
                  caption = tcap_day28fu_completion) %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"),
                            font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
```

\newpage

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("# Participants\n\n")
} else {
  cat("# Participants\n\n")
}
```

```{r, results='asis'}
cat(weekly_enrolment_hdr2)
```

```{r, results = "asis", fig.height = figsize}
if (!is.null(baseline_data)){
    if (length(baseline_data) > 0 & nrow(baseline_data) > 0) {
      val <- day_target * 5
      p <- timci::generate_week_bar_plot(date_vec = baseline_data$date_visit,
                                         date_min = as.Date(start_date),
                                         date_max = as.Date(as.Date(end_date) + 7),
                                         ylbl = paste0(enrolment_str),
                                         rref = val,
                                         relative = FALSE)
      plot(p)
  }
}
```

```{r, results='asis'}
if (!is.null(baseline_data)){
    if (length(baseline_data) > 0 & nrow(baseline_data) > 0) {
       baseline_data %>%
        dplyr::mutate(week = lubridate::floor_date(as.Date(baseline_data$date_visit),
                                                   "week",
                                                   week_start = getOption("lubridate.week.start", 1))) %>%
        dplyr::group_by(week) %>%
        dplyr::tally() %>%
        dplyr::rename('N' = 'n') %>%
        kableExtra::kbl(booktabs = TRUE,
                        linesep = "",
                        align = c("l", "c"),
                        caption = weekly_enrolment_cap) %>% 
        kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
        kableExtra::row_spec(0, bold = TRUE) %>%
        kableExtra::row_spec(1:(nrow(baseline_data)/2) * 2, background = striped_row_bg)
  }
}
```

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("## Fréquentation hebdomadaire des postes\n\n")
} else {
  cat("## Clinic weekly attendance\n\n")
}
```

```{r, results = "asis", fig.height = figsize}
if (!is.null(wfa_data)) {
  if (length(wfa_data) > 0 & nrow(wfa_data) > 0) {
    if (Sys.getenv('TIMCI_COUNTRY') != 'India') {
      p <- timci::generate_week_bar_plot2(date_vec = wfa_data$date,
                                          values = wfa_data$u5_attendance_last_week,
                                          date_min = as.Date(start_date),
                                          date_max = as.Date(as.Date(end_date) + 7),
                                          ylbl = "Under 5 attendance")
      plot(p)
    }
  }
}
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("## Nombre de soumissions au cours des 30 derniers jours\n\n")
} else {
  cat("## Number of submissions during the last 30 days\n\n")
}
```

```{r, results='asis', fig.height = figsize}
w <- 29
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("### Recrutement quotidien\n\n"))
} else {
  cat(paste0("### Daily enrolment\n\n"))
}
if (nrow(baseline_data) > 0) {
  timci::generate_day_bar_plot(date_vec = baseline_data$date_visit,
                               date_min = as.Date(end_date - w),
                               date_max = as.Date(end_date + 1),
                               ylbl = enrolment_str,
                               rref = day_target)
}
```

```{r, results='asis', fig.height = figsize}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("### Visites primaires et secondaires\n\n"))
} else {
  cat(paste0("### Baseline and repeat visits\n\n"))
}

# Frequency
if (nrow(baseline_data) > 0) {
  timci::generate_day_cumbar_plot(list(noneligible$date_visit,
                                       baseline_data$date_visit,
                                       repeat_data$date_visit),
                                  c("Non-eligible", baseline_str, repeat_str),
                                  as.Date(end_date - w),
                                  as.Date(end_date + 1),
                                  ylbl = submission_str)
} else{
  cat('N/A\n\n')
}
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("## Cartes thermiques calendaires\n\n")
  cat("### Screening\n\n")
} else {
  cat("## Calendar heatmaps\n\n")
  cat("### Screening\n\n")
}

timci::generate_calendar_heatmap2(facility_data,
                                  date_visit,
                                  legendtitle = "Number of screenings")
```

```{r, results='asis'}

```

```{r, results='asis'}
cat(baseline_visit_title_str)

if (nrow(baseline_data) > 0) {
  timci::generate_calendar_heatmap2(baseline_data,
                                    date_visit,
                                    legendtitle = "Number of enrolments")
}
```

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("## Heure de début du screening\n\n")
} else {
  cat("## Screening start times\n\n")
}
```

```{r, results='asis', fig.cap = screening_times_str, fig.height = figsize}
timci::heatmap_wday_hourofday(facility_data,
                              'start')
```

\newpage

`r eligibility_title`

`r eligibility_str`

```{r, results = "asis"}
all <- data.frame(facility_data)
all$yg_infant <- ifelse(all$yg_infant == 0, "2-59m", "0-2m")

age_statistics <- list(
  "Facility" = list(
    "First day of life" = ~qwraps2::n_perc(age_excl == 1, prec),
    "1 - 59 days" = ~qwraps2::n_perc(age_excl == 0 & age_incl == 1 & yg_infant == "0-2m", prec),
    "2 - 59 months" = ~qwraps2::n_perc(age_incl == 1 & yg_infant == "2-59m", prec),
    "Above 59 months" = ~qwraps2::n_perc(age_incl == 0, prec)
    )
)
out <- format_summary_table(all, age_statistics, facility_name)
out %>% 
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  align = c("c", "c", "c", "c"),
                  caption = age_eligibility_table_cap) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::column_spec(5, color = ifelse(grepl(pattern = "(0.0%)", x = out[, 4], fixed = TRUE),
                                            "red",
                                            "black")) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg) %>%
  kableExtra::footnote(general = c(age_eligibility_table_gfn),
                       footnote_as_chunk = TRUE)
```

```{r, results = "asis"}
all <- all %>% filter(age_incl == 1 & age_excl == 0)
all$sickness[is.na(all$sickness)] <- 0

sickness_statistics <- list(
  "Facility" = list(
    "Sick" = ~qwraps2::n_perc(sickness == 1, prec),
    "Not sick" = ~qwraps2::n_perc(sickness == 0, prec)
    )
)
out <- format_summary_table(all, sickness_statistics, facility_name)
out %>% 
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  align = c("c", "c"),
                  caption = sick_cap) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::column_spec(3, color = ifelse(grepl(pattern = "(0.0%)", x = out[, 2], fixed = TRUE),
                                            "red",
                                            "black")) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
```

```{r, results = "asis"}
sick <- all %>% filter(sickness == 1)
nonsick <- all %>% filter(sickness == 0)
all <- sick
all$consult_reason[is.na(all$consult_reason)] <- 0

sick_reason_statistics <- list(
  "Facility" = list(
    "Sickness" = ~qwraps2::n_perc(consult_reason == 1, prec),
    "Trauma" = ~qwraps2::n_perc(consult_reason == 2 & sickness == 1, prec),
    "Immunisation" = ~qwraps2::n_perc(consult_reason == 3 & sickness == 1, prec),
    "Monitoring" = ~qwraps2::n_perc(consult_reason == 4 & sickness == 1, prec)
    )
)
out <- format_summary_table(all, sick_reason_statistics, facility_name) 
out %>% 
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  align = c("c", "c", "c", "c"),
                  caption = consultion_sick_cap) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
```

```{r, results = "asis"}
all <- nonsick
all$inpatient[is.na(all$inpatient)] <- 0
all$consult_reason[is.na(all$consult_reason)] <- 0

reason_statistics <- list(
  "Facility" = list(
    "Trauma" = ~qwraps2::n_perc(consult_reason == 2 & sickness == 0, prec),
    "Immunisation" = ~qwraps2::n_perc(consult_reason == 3 & sickness == 0, prec),
    "Monitoring" = ~qwraps2::n_perc(consult_reason == 4 & sickness == 0, prec),
    "Inpatient admission" = ~qwraps2::n_perc(inpatient == 1, prec)
    )
)
if (!is.null(all) & length(all) > 0 & nrow(all) > 0) {
  out <- format_summary_table(all, reason_statistics, facility_name)
  out %>% 
    kableExtra::kbl(booktabs = TRUE,
                    linesep = "",
                    align = c("c", "c", "c", "c"),
                    caption = consultation_nonsick_cap) %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
}
```

```{r, results = "asis"}
all <- sick
all$cg_eligibility[is.na(all$cg_eligibility)] <- 0

if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cg_age_eligibility_table_cap <- "Âge de l'accompagnant principal"
} else {
  cg_age_eligibility_table_cap <- "Caregiver's age"
}

caregiver_statistics <- list(
  "Facility" = list(
    "Mother < 18" = ~qwraps2::n_perc(cg_eligibility == 0 & main_cg == 1, prec),
    "Other < 18" = ~qwraps2::n_perc(cg_eligibility == 0 & main_cg != 1, prec),
    ">= 18" = ~qwraps2::n_perc(cg_eligibility == 1, prec)
    )
)
out <- format_summary_table(all, caregiver_statistics, facility_name)
out <- gsub("%", "\\\\%", out)
out %>% 
  kableExtra::kbl(booktabs = TRUE,
                  align = c("c", "c", "c"),
                  linesep = "",
                  caption = cg_age_eligibility_table_cap,
                  col.names = c("Mother < 18", "Other < 18", "$\\bm{\\geq 18}$"),
                  escape = FALSE) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
```

```{r, results = "asis"}
all <- sick %>% filter(main_cg != 1 & !is.na(underaged_mother))

if (nrow(all) > 0) {
  mother_statistics <- list(
    "Summary" = list(
      "< 18" = ~qwraps2::n_perc(underaged_mother == 1, prec),
      ">= 18" = ~qwraps2::n_perc(underaged_mother == 0, prec)
      )
  )

  out <- format_summary_table(all, mother_statistics, facility_name)
  out <- gsub("%", "\\\\%", out)
  out %>% 
    kableExtra::kbl(booktabs = TRUE,
                    align = c("c", "c"),
                    linesep = "",
                    caption = u18_mother_cap,
                    col.names = c("< 18", "$\\bm{\\geq 18}$"),
                    escape = FALSE) %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
}
```

```{r, results = "asis"}
all <- sick %>% filter(cg_eligibility == 1)
all$prev_enrl[is.na(all$prev_enrl)] <- 0
all$repeat_consult[is.na(all$repeat_consult)] <- 0

summary_statistics <- list(
  "Summary" = list(
    "First" = ~qwraps2::n_perc(prev_enrl == 3 | prev_enrl == 98, prec),
    "Previous" = ~qwraps2::n_perc(prev_enrl == 1 | prev_enrl == 2, prec),
    "Last <= 28 days" = ~qwraps2::n_perc(repeat_consult == 1, prec),
    "Last > 28 days" = ~qwraps2::n_perc((prev_enrl == 1 | prev_enrl == 2) & repeat_consult == 0, prec)
    )
)
out <- format_summary_table(all, summary_statistics, facility_name)
out <- gsub("%", "\\\\%", out)
out %>% 
  kableExtra::kbl(booktabs = TRUE,
                  align = c("c", "c", "c", "c"),
                  linesep = "",
                  caption = multi_rec_cap,
                  col.names = c("First", "Previous", "Last $\\bm{\\leq 28}$ days", "Last > 28 days"),
                  escape = FALSE) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
```

```{r, results = "asis"}
all <- all %>% filter((prev_enrl == 3 | prev_enrl == 98) | ((prev_enrl == 1 | prev_enrl == 2) & repeat_consult == 0))

consent_statistics <- list(
  "Facility" = list(
    "Consented" = ~qwraps2::n_perc(consent == 1, prec),
    "Not consented" = ~qwraps2::n_perc(consent == 0, prec)
    )
)
out <- format_summary_table(all, consent_statistics, facility_name)
out %>% 
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  align = c("c", "c"),
                  caption = consent_cap) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::column_spec(2, color = ifelse(grepl(pattern = "(100.0%)", x = out[, 1], fixed = TRUE),
                                            "red",
                                            "black")) %>%
  kableExtra::column_spec(3, color = ifelse(grepl(pattern = "(0.0%)", x = out[, 2], fixed = TRUE),
                                            "red",
                                            "black")) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
```
  
```{r, results='asis', fig.height = figsize, fig.cap = nonenrolment_cap}
non_enrolment_causes <- timci::count_screening(facility_data)
nec_pie_chart <- timci::generate_pie_chart(non_enrolment_causes)
plot(nec_pie_chart)
```

\newpage

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("# Visite primaire\n\n"))
} else {
  cat(paste0("# Baseline visit\n\n"))
}
```

```{r contact-details-title, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("## Informations de contact")
} else {
  cat("## Contact details")
}
```

```{r, results = "asis"}
if (!is.null(pii)) {
  if (nrow(pii) > 0) {
    
    all <- data.frame(pii)
    all$phone_nb[!is.na(all$phone_nb)] <- 1
    all$phone_nb[is.na(all$phone_nb)] <- 0
    all$phone_nb2[!is.na(all$phone_nb2)] <- 1
    all$phone_nb2[is.na(all$phone_nb2)] <- 0
    
    phone_stats <- list(
      "Facility" = list(
        "0 phone numbers" = ~qwraps2::n_perc(phone_nb == 0, prec),
        "1 phone number" = ~qwraps2::n_perc(phone_nb == 1, prec),
        "2 phone numbers" = ~qwraps2::n_perc((phone_nb == 1) & (phone_nb2 == 1), prec)
        )
    )
    
    out <- format_summary_table(all, phone_stats, facility_name)
    out %>% 
      kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
      kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
      kableExtra::row_spec(0, bold = TRUE) %>%
      kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
      kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
    
  }
}
```

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') != 'India') {
  
  if (!is.null(pii)) {
    if (nrow(pii) > 0) {
      
      all <- all %>%
        dplyr::filter(all$phone_nb == 0)
      
      all$cmty[is.na(all$cmty)] <- 0
      all$cmty[!is.na(all$cmty) & "hapana" %in% tolower(all$cmty)] <- 0
      all$cmty[!is.na(all$cmty) & !("hapana" %in% tolower(all$cmty))] <- 1
      all$location[all$location != '' & all$location != ' ' & all$location != 'Outside the region'] <- 1
      all$location[all$location == '' | all$location == ' ' | all$location == 'Outside the region'] <- 0
      
      contact_details_stats <- list(
        "Facility" = list(
          "No community contact" = ~qwraps2::n_perc((cmty == 0) & (phone_nb == 0), prec),
          "Unknown residence" = ~qwraps2::n_perc((location == 0) & (phone_nb == 0), prec)
          )
      )
  
      out <- format_summary_table(all, contact_details_stats, facility_name)
      out %>%
        kableExtra::kbl(booktabs = TRUE,
                        linesep = "",
                        align = c("c", "c")) %>%
        kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
        kableExtra::row_spec(0, bold = TRUE) %>%
        kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
        kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
      
    }
  }
}
```

\newpage

```{r header-clinical-presentation, results = "asis"}
cat(clinical_presentation_title_str)
```

```{r, results = "asis"}
if (nrow(baseline_data) > 0) {
  all <- data.frame(baseline_data)
  
  clinical_presentation_statistics <- list(
    "Facility" = list(
      "Convulsions" = ~qwraps2::n_perc(sx_convulsions == 1, prec),
      "Lethargy" = ~qwraps2::n_perc(sx_lethargy == 1, prec),
      "Vomit" = ~qwraps2::n_perc(sx_vomit == 1, prec),
      "Less appetite" = ~qwraps2::n_perc(sx_less_feed == 1, prec)
      )
  )
  out <- format_summary_table(all, clinical_presentation_statistics, facility_name)
  out %>% 
    kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
}
```

```{r, results = "asis"}
if (nrow(baseline_data) > 0) {
  all <- data.frame(baseline_data)
  
  clinical_presentation_statistics <- list(
    "Facility" = list(
      "Cough" = ~qwraps2::n_perc(sx_cough == 1, prec),
      "Difficulty breathing" = ~qwraps2::n_perc(sx_difficulty_breath == 1, prec),
      "Diarrhoea" = ~qwraps2::n_perc(sx_diarrhoea == 1, prec),
      "Fever" = ~qwraps2::n_perc(sx_fever == 1, prec)
      )
  )
  out <- format_summary_table(all, clinical_presentation_statistics, facility_name)
  out %>% 
    kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
}
```

\newpage

```{r header-pox, results = "asis"}
cat(pox_title_str)
```

```{r, results = "asis"}
if (nrow(baseline_data) > 0) {
  
  if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
    cat(paste0("### 1 - 59 jours\n\n"))
  } else {
    cat(paste0("### 1 - 59 days\n\n"))
  }
  
  all <- data.frame(baseline_data) %>% filter(yg_infant == 1)
  
  pox_statistics <- list(
    "Facility" = list(
      "Reported" = ~qwraps2::n_perc(spo2 == 1, prec)
      )
  )
  out <- format_summary_table(all, pox_statistics, facility_name)
  out %>% 
    kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
}
```

```{r, results = "asis"}
if (nrow(baseline_data) > 0) {
  
  if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
    cat(paste0("### 2-59 months\n\n"))
  } else {
    cat(paste0("### 2-59 months\n\n"))
  }
  
  all <- data.frame(baseline_data) %>% filter(yg_infant == 0)
  
  pox_statistics <- list(
    "Facility" = list(
      "Reported" = ~qwraps2::n_perc(spo2 == 1, prec)
      )
  )
  out <- format_summary_table(all, pox_statistics, facility_name) 
  out %>% 
    kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
}
```

\newpage

```{r header-referrals, results = "asis"}
cat(referral_title_str)
```

```{r}
if (nrow(baseline_data) > 0) {
  all <- data.frame(baseline_data)
  #all$yg_infant <- ifelse(all$yg_infant == 0, "2-59 months", "2-59 days")
  all$referral_cg <- ifelse(!is.na(all$referral_cg), all$referral_cg, 100)
  all$referral_hf <- ifelse(!is.na(all$referral_hf), all$referral_hf, 100)
}
```

```{r header-referrals-cg, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("### Rapporté par l'accompagnant à la sortie de la consultation\n\n"))
} else {
  cat(paste0("### Reported by the caregiver at the consultation exit\n\n"))
}
```

```{r, results = "asis"}
if (nrow(baseline_data) > 0) {
  summary_statistics <- list(
    "Facility" = list(
      "Yes" = ~qwraps2::n_perc(referral_cg == 1, prec),
      "No" = ~qwraps2::n_perc(referral_cg == 0, prec),
      "Unknown" = ~qwraps2::n_perc(referral_cg == 98, prec),
      "Declined" = ~qwraps2::n_perc(referral_cg == 97, prec),
      "Lost at exit" = ~qwraps2::n_perc(referral_cg == 100, prec)
      )
  )
  out <- format_summary_table(all, summary_statistics, facility_name) 
  out %>% 
    kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::column_spec(2, color = ifelse(as.numeric(gsub("\\(([^()]*)%\\)|.", "\\1", x = out[, 1], perl = TRUE)) >= 10,
                                              "red",
                                              "black")) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
  
}
```

```{r header-referrals-hf, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("### Rapporté dans le registre du poste\n\n"))
} else {
  cat(paste0("### Reported in the facility registry\n\n"))
}
```

```{r, results = "asis"}
if (nrow(baseline_data) > 0) {
  summary_statistics <- list(
    "Facility" = list(
      "Yes" = ~qwraps2::n_perc(referral_hf == 1, prec),
      "No" = ~qwraps2::n_perc(referral_hf == 0, prec)
      )
  )
  out <- format_summary_table(all, summary_statistics, facility_name) 
  out %>% 
    kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
} 
```

```{r, fig.height = figsize}
if (nrow(baseline_data) > 0) {
  referral_data <- timci::extract_referrals(baseline_data)
  n_referrals <- nrow(referral_data)
  referral_pie_chart <- timci::generate_pie_chart(data.frame(group = c("Referred at Day 0", "Not referred at Day 0"), value = c(n_referrals, n_enrolled - n_referrals)))
  plot(referral_pie_chart)
}
```

```{r day7fu-subsection, child = if (!is.null(raw_day7fu_data)) 'rct_monitoring_report_sub_day7.Rmd'}
```

```{r hospit-subsection, child = if (!is.null(raw_hospit_data)) 'rct_monitoring_report_sub_hospit.Rmd'}
```

```{r day28fu-subsection, child = if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") 'rct_monitoring_report_sub_day28.Rmd'}
```

\newpage

`r appendix_title`

```{r, results="asis"}
out <- lapply(1:nrow(facilities), function(i) {
  knitr::knit_child(
    'rct_monitoring_report_facility_sub.Rmd', envir = environment(), quiet = TRUE
  )
})
cat(unlist(out), sep = '\n')
```

\newpage
\listoftables

\newpage
\listoffigures

```{r technical-info-subsection, child = 'technical_info.Rmd'}
```
