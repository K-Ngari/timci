---
title: "TIMCI `r if(Sys.getenv('TIMCI_IS_RCT') == 1){'Pragmatic cluster RCT'} else{'Longitudinal Observational Study'}` - Monitoring Report"
author: "`r Sys.getenv('TIMCI_INSTITUTION')`"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
params:
  research_facilities: data.frame(deviceid = character(0), district = character(0), facility = character(0))
  facility_data: NULL
output:
  html_document: default
  word_document:
    reference_docx: word_styles1.docx
    fig_width: 7.5
---

```{r setup-rmd, include=FALSE}
library(magrittr)
library(readxl)
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r load-RCT-LS-environment-variables}
crf_day7_fid <- Sys.getenv("TIMCI_CRF_DAY7_FID")
crf_hospit_fid <- Sys.getenv("TIMCI_CRF_HOSPIT_FID")
if (Sys.getenv('TIMCI_IS_RCT') == 1) {
  crf_day28_fid <- Sys.getenv("TIMCI_CRF_DAY28_FID")
}
wd_fid <- Sys.getenv("TIMCI_WD_FID")
form_list <- ruODK::form_list()$fid
```

```{r load-RCT-LS-ODK-facility-data}
raw_day7fu_data <- NULL
if (crf_day7_fid %in% form_list) {
  raw_day7fu_data <- ruODK::odata_submission_get(fid = crf_day7_fid,
                                                 download = FALSE)
}

raw_hospit_data <- NULL
if (crf_hospit_fid %in% form_list) {
raw_hospit_data <- ruODK::odata_submission_get(fid = crf_hospit_fid,
                                               download = FALSE)
}

if (Sys.getenv('TIMCI_IS_RCT') == 1) {
  raw_day28fu_data <- NULL
  if (crf_day28_fid %in% form_list) {
    raw_day28fu_data <- ruODK::odata_submission_get(fid = crf_day28_fid,
                                                  download = FALSE)
  }
}

raw_withdrawal_data <- NULL
if (wd_fid %in% form_list) {
raw_withdrawal_data <- ruODK::odata_submission_get(fid = wd_fid,
                                                   download = FALSE)
}
```

```{r process-facility-data}
start_date <- NULL
end_date <- NULL
if (nrow(params$facility_data) > 0) {
  start_date <- min(params$facility_data$date_visit)
  end_date <- max(params$facility_data$date_visit)
}
```

This report covers the period from **`r start_date`** to **`r end_date`**.

# 1. Submissions

## Total number of submissions per form
```{r submissions-1, results = "asis"}

n_total <- 0

# Screening data
n_screened <- nrow(params$facility_data)
screening_data <- timci::extract_screening_data(params$facility_data)
visit_names <- c("Screening")
submissions <- c(n_screened)
n_total <- n_total + n_screened

study_data <- timci::extract_all_visits(params$facility_data)
res <- timci::extract_enrolled_participants(params$facility_data)

# Baseline data
baseline_data <- timci::extract_baseline_visits(study_data)
demog_data <- res[[1]]
n_enrolled <- nrow(demog_data)
visit_names <- c(visit_names, "Baseline visit")
submissions <- c(submissions, n_enrolled)

# Count facility submissions corresponding to repeat visits
repeat_data <- timci::extract_repeat_visits(study_data)
n_repeat <- nrow(repeat_data)
visit_names <- c(visit_names, "Repeat visit")
submissions <- c(submissions, n_repeat)

# Count Day 7 phone call submissions
if (!is.null(raw_day7fu_data)) {
  n_day7fu <- nrow(raw_day7fu_data)
  visit_names <- c(visit_names, "Day 7 phone call")
  submissions <- c(submissions, n_day7fu)
  n_total <- n_total + n_day7fu
}

# Count hospital visit submissions
if (!is.null(raw_hospit_data)) {
  n_hospit <- nrow(raw_hospit_data)
  visit_names <- c(visit_names, "Hospital visit")
  submissions <- c(submissions, n_hospit)
  n_total <- n_total + n_hospit
}

# Count withdrawal submissions
if (!is.null(raw_withdrawal_data)) {
  n_withdrawal <- nrow(raw_withdrawal_data)
  visit_names <- c(visit_names, "Withdrawal")
  submissions <- c(submissions, n_withdrawal)
  n_total <- n_total + n_withdrawal
}

if (Sys.getenv('TIMCI_IS_RCT') == 1) {
  if (!is.null(raw_day28fu_data)) {
    n_day28fu <- nrow(raw_day28fu_data)
    visit_names <- c(visit_names, "Day 28 phone call")
    submissions <- c(submissions, n_day28fu)
    n_total <- n_total + n_day28fu
  }
}
  
visit_names <- c(visit_names, "All")
submissions <- c(submissions, n_total)

visits <- data.frame(visit_names, submissions) 
knitr::kable(visits, col.names = c("Visit", "N"))
```

## Number of submissions during the last 30 days

### Screening
```{r, results='asis'}
w <- 30
if (nrow(params$facility_data) > 0) {
  p <- timci::generate_day_bar_plot(params$facility_data$date_visit, as.Date(Sys.Date() - w), as.Date(Sys.Date() + 1), "Submissions")
  plot(p)
  ylim <- layer_scales(p)$y$get_limits()
} else{
  cat('N/A\n\n')
}
```

### Baseline and repeat visits
```{r, results='asis'}
w <- 30
# Frequency
if (nrow(baseline_data) > 0) {
  
  timci::generate_day_cumbar_plot(baseline_data$date_visit,
                                  "Baseline",
                                  repeat_data$date_visit,
                                  "Repeat",
                                  as.Date(Sys.Date() - w),
                                  as.Date(Sys.Date() + 1),
                                  ylim,
                                  "Submissions")
} else{
  cat('N/A\n\n')
}
```

### Day 7 phone call
```{r, results='asis'}
if (!is.null(raw_day7fu_data)) {
  if (nrow(raw_day7fu_data) > 0) {
    plot(timci::generate_day_bar_plot(raw_day7fu_data$today, as.Date(Sys.Date() - w), as.Date(Sys.Date() + 1), "Submissions"))
  } else{
    cat('N/A\n\n')
  }
}
```

### Hospital visit
```{r, results='asis'}
if (!is.null(raw_hospit_data)) {
  if (nrow(raw_hospit_data) > 0) {
    plot(timci::generate_day_bar_plot(raw_hospit_data$today, as.Date(Sys.Date() - w), as.Date(Sys.Date() + 1), "Submissions"))
  } else{
    cat('0 submissions since the start of the study.\n\n')
  }
}
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_IS_RCT') == 1) {
  cat('### Day 28 phone call\n\n')
  if (!is.null(raw_day28fu_data)) {
    if (nrow(raw_day28fu_data) > 0) {
      plot(timci::generate_day_bar_plot(raw_day28fu_data$today, as.Date(Sys.Date() - w), as.Date(Sys.Date() + 1), "Submissions"))
    } else {
      cat('0 submissions since the start of the study.\n\n')
    }
  }
}
```

## Calendar heatmaps

### Screening

```{r}
timci::generate_calendar_heatmap(params$facility_data, date_visit)
```

### Enrolment

```{r}
if (nrow(baseline_data) > 0) {
  timci::generate_calendar_heatmap(baseline_data, date_visit)
}
```

# 2. Participants
```{r, results = "asis"}
options(qwraps2_markup = 'markdown')

all <- data.frame(params$facility_data)
all$sickness[is.na(all$sickness)] <- 0
all$inpatient[is.na(all$inpatient)] <- 0
all$consult_reason[is.na(all$consult_reason)] <- 0
all$prev_enrl[is.na(all$prev_enrl)] <- 0
all$repeat_consult[is.na(all$repeat_consult)] <- 0
all$consent[is.na(all$consent)] <- 0
all$yg_infant <- ifelse(all$yg_infant == 0, "2-59m", "0-2m")

summary_statistics <- list(
  "Age eligibility" = list(
    "0 - 59 months" = ~qwraps2::n_perc(age_incl == 1, 2),
    "First day of life" = ~qwraps2::n_perc(age_excl == 1, 2)
    ),
  "Visit eligibility" = list(
    "Sick child" = ~qwraps2::n_perc(sickness == 1, 2),
    "Inpatient admission" = ~qwraps2::n_perc(inpatient == 1, 2),
    "Trauma" = ~qwraps2::n_perc(consult_reason == 2, 2),
    "Immunisation" = ~qwraps2::n_perc(consult_reason == 3, 2),
    "Monitoring" = ~qwraps2::n_perc(consult_reason == 4, 2)
    ),
  "Multiple enrolments" = list(
    "Previous enrolment" = ~qwraps2::n_perc(prev_enrl == 1 | prev_enrl == 2, 2),
    "Last enrolment < 28 days" = ~qwraps2::n_perc(repeat_consult == 1, 2)
    ),
  "Consenting process outcome" = list(
    "Enrolled" = ~qwraps2::n_perc(consent == 1, 2)
    )
)
st <- qwraps2::summary_table(all, summary_statistics)
st1 <- qwraps2::summary_table(dplyr::group_by(all, yg_infant), summary_statistics)
print(cbind(st, st1))
```

```{r}
deidentified_facility_data <- timci::deidentify_data(study_data)
```

## Screening by facility
```{r}
stats <- timci::get_summary_by_facility(params$facility_data)
stats <- merge(x = stats, y = params$research_facilities, by.x = 'device_id', by.y = 'deviceid', all.x = TRUE)
timci::generate_enrolment_hist(stats, facility, screened, 5, 15, "Number of children screened", "facilities")
```

## Enrolment by facility
```{r}
timci::generate_enrolment_hist(stats, facility, children, 5, 15, "Number of children enrolled", "facilities")
```

## Enrolment heatmap by facility

### Enrolment versus global target

```{r}
timci::plot_enrolment_gauge(n_enrolled/(n_screened - n_repeat), "Enrolment rate\n(excl. repeat visits)", 100, 60, 85)
```
  
### Enrolment versus weekly target
  


### Non-enrolment causes
```{r}
non_enrolment_causes <- timci::count_screening(params$facility_data)
nec_pie_chart <- timci::generate_pie_chart(non_enrolment_causes)
plot(nec_pie_chart)
```

# 3. Baseline visit

## Medical history

## Hypoxaemia

## Lab tests

## Diagnosis and care management 

### Referrals

```{r, results = "asis"}
options(qwraps2_markup = 'markdown')

if (nrow(baseline_data) > 0) {
  all <- data.frame(study_data)
  all$yg_infant <- ifelse(all$yg_infant == 0, "2-59m", "0-2m")
  
  summary_statistics <- list(
    "Referral" = list(
      "Reported (caregiver)" = ~qwraps2::n_perc(referral_cg == 1 | referral_cg == 2, 2),
      "Declined (caregiver)" = ~qwraps2::n_perc(referral_cg == 97, 2),
      "Reported (registry)" = ~qwraps2::n_perc(referral_hf == 1 | referral_hf == 2 | referral_hf == 3, 2),
      "Inpatient admission (registry)" = ~qwraps2::n_perc(referral_hf == 4, 2)
      )
  )
  referral_summary <- qwraps2::summary_table(all, summary_statistics)
  referral_summary1 <- qwraps2::summary_table(dplyr::group_by(all, yg_infant), summary_statistics)
  print(cbind(referral_summary, referral_summary1))
}
```

```{r}
if (nrow(baseline_data) > 0) {
  referral_data <- timci::extract_referrals(deidentified_facility_data)
  n_referrals <- nrow(referral_data)
  referral_pie_chart <- timci::generate_pie_chart(data.frame(group = c("Referred at Day 0", "Not referred at Day 0"), value = c(n_referrals, n_enrolled - n_referrals)))
  plot(referral_pie_chart)
}
```

# 4. Day 7 follow-up

```{r}
wmin <- 7
wmax <- 10
if (nrow(raw_day7fu_data) > 0) {
  raw_day7fu_data <- raw_day7fu_data %>%
    dplyr::mutate(days = as.Date(today) - as.Date(a1_enroldate), na.rm = TRUE)
}
```

The valid Day 7 follow-up period is **`r wmin`** to **`r wmax`** days.

```{r}
if (nrow(raw_day7fu_data) > 0) {
  n_reached_day7fu <- sum(!is.na(raw_day7fu_data$a1_contact_a4_d_1b) & (raw_day7fu_data$a1_contact_a4_d_1b == 1))
  n_valid_day7fu <- sum((raw_day7fu_data$days >= wmin) & (raw_day7fu_data$days < wmax))
} else {
  n_reached_day7fu <- 0
  n_valid_day7fu <- 0
}

# gauge plots
timci::plot_enrolment_gauge(n_reached_day7fu/n_enrolled, "Day 7 follow-up rate", 100, 80, 90)
timci::plot_enrolment_gauge(n_valid_day7fu/n_enrolled, "Day 7 follow-up rate\nwithin the time window", 100, 80, 90)
```

```{r, results = "asis"}
options(qwraps2_markup = 'markdown')

if (nrow(raw_day7fu_data) > 0) {
  all <- data.frame(raw_day7fu_data)
  all$a1_contact_a4_d_1b[is.na(all$a1_contact_a4_d_1b)] <- 0
  all$o1_o1_1a[is.na(all$o1_o1_1a)] <- 0
  all$o1_o1_1[is.na(all$o1_o1_1)] <- 0
  all$n1_o3_1[is.na(all$n1_o3_1)] <- 0
  
  day7_call_ss <- list(
    "Call outcome" = list(
      "Participant reached" = ~qwraps2::n_perc(a1_contact_a4_d_1b == 1, 2),
      "Valid time window" = ~qwraps2::n_perc((days >= wmin) & (days < wmax), 2),
      "Lost to follow-up" = ~qwraps2::n_perc(a1_contact_a4_d_1b == 0, 2)
      )
  )
  print(qwraps2::summary_table(all, day7_call_ss))
  
  day7_outcome_ss <- list(
    "Cure" = list(
      "Known" = ~qwraps2::n_perc(o1_o1_1 == 1 | o1_o1_1 == 2 | o1_o1_1 == 3 | o1_o1_1 == 4, 2)
      ),
    "Hospitalisation" = list(
      "Reported" = ~qwraps2::n_perc(o1_o1_1a == 2 | n1_o3_1 == 1, 2)
      )
  )
  print(qwraps2::summary_table(all, day7_outcome_ss))
}
```
# 5. Hospital follow-up

```{r, results = "asis"}
options(qwraps2_markup = 'markdown')

if (Sys.getenv('TIMCI_IS_RCT') == 1) {
  cat('# 6. Day 28 follow-up\n\n')
  if (!is.null(raw_day28fu_data)) {
    if (nrow(raw_day28fu_data) > 0) {
      all <- data.frame(raw_day28fu_data)
      all$a1_contact_a4_d_1b[is.na(all$a1_contact_a4_d_1b)] <- 0
      all$o1_o1_1a[is.na(all$o1_o1_1a)] <- 0
      all$o1_o1_1[is.na(all$o1_o1_1)] <- 0
      all$n1_o3_1[is.na(all$n1_o3_1)] <- 0
      
      day28_call_ss <- list(
        "Call outcome" = list(
          "Participant reached" = ~qwraps2::n_perc(a1_contact_a4_d_1b == 1, 2),
          "Valid time window" = ~qwraps2::n_perc(a1_contact_a4_d_1b == 1, 2),
          "Lost to follow-up" = ~qwraps2::n_perc(a1_contact_a4_d_1b == 0, 2)
          )
      )
      print(qwraps2::summary_table(all, day28_call_ss))
    }
  }
}
```
