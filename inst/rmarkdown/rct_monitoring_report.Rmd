---
title: "TIMCI `r if (Sys.getenv('TIMCI_COUNTRY') == 'Tanzania' || Sys.getenv('TIMCI_COUNTRY') == 'India') {'Pragmatic cluster RCT - Monitoring Report'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {'Étude Longitudinale Observationnelle - Rapport de suivi'} else {'Longitudinal Observational Study - Monitoring Report'}`"
author: "`r if (Sys.getenv('TIMCI_COUNTRY') == 'Tanzania') {'Ifakara Health Institute (IHI)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'India') {'King George s Medical University (KGMU)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {'Université Cheikh Anta Diop de Dakar (UCAD)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Kenya') {'University of Nairobi (UoN)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Myanmar') {'Burnet Institute (BI)'} else {'Swiss Tropical and Public Health Institute (Swiss TPH)'}`"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
params:
  research_facilities: !r data.frame(deviceid = character(0), district = character(0), facility = character(0))
  facility_data: NULL
  raw_day7fu_data: NULL
  raw_hospit_data: NULL
  raw_day28fu_data: NULL
  raw_withdrawal_data: NULL
output:
  word_document:
    reference_docx: word_styles1.docx
    fig_width: 7.5
  html_document: default
---

```{r setup-rmd, include=FALSE}
library(magrittr)
library(readxl)
library(ggplot2)
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

The overall goal of the Tools for the Management of Childhood Illness (TIMCI) project is to reduce morbidity and mortality in sick children attending primary care facilities, while supporting the rational and efficient use of diagnostics and medicines by healthcare providers. The evaluation component of the project seeks to generate evidence on the health impact, operational priorities, cost and cost-effectiveness of introducing pulse oximetry, alone or embedded into a Clinical Decision Support Algorithm (CDSA), at primary care level in LMICs, for children 0 – 59 months of age, to facilitate national and international decision-making on scale-up.

```{r traductions}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  baseline_str <- "Visite de base"
  repeat_str <- "Visite de suivi"
  submission_str <- "Soumissions"
  screening_str <- "Screening"
  withdrawal_str <- "Désistement"
} else {
  baseline_str <- "Baseline visit"
  repeat_str <- "Repeat visit"
  submission_str <- "Submissions"
  screening_str <- "Screening"
  withdrawal_str <- "Withdrawal"
}
```

```{r setup-variables}
if (!is.null(params$facility_data)) {
  
  facility_data <- params$facility_data
  raw_day7fu_data <- params$raw_day7fu_data
  raw_hospit_data <- params$raw_hospit_data
  raw_day28fu_data <- params$raw_day28fu_data
  raw_withdrawal_data <- params$raw_withdrawal_data
  
} else {
  
  ################
  # Set up ruODK #
  ################
  
  ruODK::ru_setup(
    svc = Sys.getenv("ODKC_SVC"),
    un = Sys.getenv("ODKC_UN"),
    pw = Sys.getenv("ODKC_PW"),
    tz = Sys.getenv("TZ"),
    verbose = TRUE # Can be switched to TRUE for demo or debugging
  )

  # List of projects visible with the credentials `ODKC_UN` and `ODKC_PW`
  odkc_project_list <- ruODK::project_list()$id

  wd_fid <- Sys.getenv("TIMCI_WD_FID")

  # RCT / LS environment variables
  crf_facility_fid <- Sys.getenv("TIMCI_CRF_FACILITY_FID")
  print(crf_facility_fid)
  crf_day7_fid <- Sys.getenv("TIMCI_CRF_DAY7_FID")
  crf_hospit_fid <- Sys.getenv("TIMCI_CRF_HOSPIT_FID")
  if (Sys.getenv('TIMCI_IS_RCT') == 1) {
    crf_day28_fid <- Sys.getenv("TIMCI_CRF_DAY28_FID")
  }

  #######################
  # Load TIMCI ODK data #
  #######################

  # List of forms visible in the RCT / LS project
  rct_ls_form_list <- ruODK::form_list()$fid

  # Load facility data
  print("Load facility data")
  raw_facility_data <- ruODK::odata_submission_get(fid = crf_facility_fid)
  facility_data <- timci::process_facility_data(raw_facility_data)

  pii <- timci::extract_enrolled_participants(facility_data)[[2]]

  # Load day 7 follow-up data
  print("Load day 7 follow-up data")
  raw_day7fu_data <- NULL
  if (crf_day7_fid %in% rct_ls_form_list) {
    raw_day7fu_data <- ruODK::odata_submission_get(fid = crf_day7_fid,
                                                   download = FALSE)
  }

  # Load hospital visit follow-up data
  print("Load hospital visit data")
  raw_hospit_data <- NULL
  if (crf_hospit_fid %in% rct_ls_form_list) {
    raw_hospit_data <- ruODK::odata_submission_get(fid = crf_hospit_fid,
                                                   download = FALSE)
  }

  # Load day 28 follow-up data
  raw_day28fu_data <- NULL
  if (Sys.getenv('TIMCI_IS_RCT') == 1) {
    print("Load day 28 follow-up data")
    if (crf_day28_fid %in% rct_ls_form_list) {
      raw_day28fu_data <- ruODK::odata_submission_get(fid = crf_day28_fid,
                                                      download = FALSE)
    }
  }

  # Load widthdrawal data
  print("Load withdrawal data")
  raw_withdrawal_data <- NULL
  if (wd_fid %in% rct_ls_form_list) {
    raw_withdrawal_data <- ruODK::odata_submission_get(fid = wd_fid,
                                                       download = FALSE)
  }
  
}
```

```{r load-RCT-LS-environment-variables}
crf_hospit_fid <- Sys.getenv("TIMCI_CRF_HOSPIT_FID")
if (Sys.getenv('TIMCI_IS_RCT') == 1) {
  crf_day28_fid <- Sys.getenv("TIMCI_CRF_DAY28_FID")
}
wd_fid <- Sys.getenv("TIMCI_WD_FID")
form_list <- ruODK::form_list()$fid
```

```{r process-facility-data, results='asis'}
start_date <- NULL
end_date <- NULL
if (nrow(facility_data) > 0) {
  start_date <- min(facility_data$date_visit)
  end_date <- max(facility_data$date_visit)
  if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
    cat(paste0("Ce rapport couvre la période du **", start_date, "** au **", end_date, "** pour le **Sénégal**."))
  } else {
    cat(paste0("This report covers the period from **", start_date, "** to **", end_date, "** for **", Sys.getenv('TIMCI_COUNTRY'), "**."))
  }
}
```

\begin{equation} 
  f\left(k\right) = \binom{n}{k} p^k\left(1-p\right)^{n-k}
  (\#eq:binom)
\end{equation}

```{r submissions-1, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("# 1. Soumissions\n\n"))
  cat(paste0("## Nombre total de soumissions par formulaire\n\n"))
} else {
  cat(paste0("# 1. Submissions\n\n"))
  cat(paste0("## Total number of submissions per form\n\n"))
}

n_total <- 0

# Screening data
n_screened <- nrow(facility_data)
screening_data <- timci::extract_screening_data(facility_data)
visit_names <- c(screening_str)
submissions <- c(n_screened)
n_total <- n_total + n_screened

study_data <- timci::extract_all_visits(facility_data)
res <- timci::extract_enrolled_participants(facility_data)

# Baseline data
baseline_data <- timci::extract_baseline_visits(study_data)
demog_data <- res[[1]]
n_enrolled <- nrow(demog_data)
visit_names <- c(visit_names, baseline_str)
submissions <- c(submissions, n_enrolled)

# Count facility submissions corresponding to repeat visits
repeat_data <- timci::extract_repeat_visits(study_data)
n_repeat <- nrow(repeat_data)
visit_names <- c(visit_names, repeat_str)
submissions <- c(submissions, n_repeat)

# Count Day 7 phone call submissions
if (!is.null(raw_day7fu_data)) {
  n_day7fu <- nrow(raw_day7fu_data)
  visit_names <- c(visit_names, "Day 7 phone call")
  submissions <- c(submissions, n_day7fu)
  n_total <- n_total + n_day7fu
}

# Count hospital visit submissions
if (!is.null(raw_hospit_data)) {
  n_hospit <- nrow(raw_hospit_data)
  visit_names <- c(visit_names, "Hospital visit")
  submissions <- c(submissions, n_hospit)
  n_total <- n_total + n_hospit
}

# Count withdrawal submissions
if (!is.null(raw_withdrawal_data)) {
  n_withdrawal <- nrow(raw_withdrawal_data)
  visit_names <- c(visit_names, withdrawal_str)
  submissions <- c(submissions, n_withdrawal)
  n_total <- n_total + n_withdrawal
}

if (Sys.getenv('TIMCI_IS_RCT') == 1) {
  if (!is.null(raw_day28fu_data)) {
    n_day28fu <- nrow(raw_day28fu_data)
    visit_names <- c(visit_names, "Day 28 phone call")
    submissions <- c(submissions, n_day28fu)
    n_total <- n_total + n_day28fu
  }
}
  
visit_names <- c(visit_names, "All")
submissions <- c(submissions, n_total)

visits <- data.frame(visit_names, submissions) 
knitr::kable(visits, col.names = c("Visit", "N"))
```

```{r, results='asis'}
w <- 30

if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("## Nombre de soumissions au cours des 30 derniers jours\n\n"))
  cat(paste0("### Screening\n\n"))
} else {
  cat(paste0("## Number of submissions during the last 30 days\n\n"))
  cat(paste0("### Screening\n\n"))
}

if (nrow(facility_data) > 0) {
  p <- timci::generate_day_bar_plot(facility_data$date_visit, as.Date(Sys.Date() - w),
                                    as.Date(Sys.Date() + 1),
                                    submission_str)
  plot(p)
  ylim <- ggplot2::layer_scales(p)$y$get_limits()
} else{
  cat('N/A\n\n')
}
```

```{r, results='asis'}
w <- 30

if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("### Visites de base et de suivi\n\n"))
} else {
  cat(paste0("### Baseline and repeat visits\n\n"))
}

# Frequency
if (nrow(baseline_data) > 0) {
  
  timci::generate_day_cumbar_plot(baseline_data$date_visit,
                                  baseline_str,
                                  repeat_data$date_visit,
                                  repeat_str,
                                  as.Date(Sys.Date() - w),
                                  as.Date(Sys.Date() + 1),
                                  ylim,
                                  submission_str)
  
} else{
  cat('N/A\n\n')
}
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("### Appel téléphonique à Jour 7\n\n"))
} else {
  cat(paste0("### Day 7 phone call\n\n"))
}

if (!is.null(raw_day7fu_data)) {
  if (nrow(raw_day7fu_data) > 0) {
    plot(timci::generate_day_bar_plot(raw_day7fu_data$date, as.Date(Sys.Date() - w),
                                      as.Date(Sys.Date() + 1),
                                      submission_str))
  } else{
    cat('N/A\n\n')
  }
}
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("### Visite à l'hôpital\n\n"))
} else {
  cat(paste0("### Hospital visit\n\n"))
}

if (!is.null(raw_hospit_data)) {
  if (nrow(raw_hospit_data) > 0) {
    plot(timci::generate_day_bar_plot(raw_hospit_data$date, as.Date(Sys.Date() - w),
                                      as.Date(Sys.Date() + 1),
                                      "Submissions"))
  } else{
    cat('0 submissions since the start of the study.\n\n')
  }
}
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_IS_RCT') == 1) {
  cat('### Day 28 phone call\n\n')
  if (!is.null(raw_day28fu_data)) {
    if (nrow(raw_day28fu_data) > 0) {
      plot(timci::generate_day_bar_plot(raw_day28fu_data$date, as.Date(Sys.Date() - w), as.Date(Sys.Date() + 1), "Submissions"))
    } else {
      cat('0 submissions since the start of the study.\n\n')
    }
  }
}
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("## Cartes thermiques calendaires\n\n"))
  cat(paste0("### Screening\n\n"))
} else {
  cat(paste0("## Calendar heatmaps\n\n"))
  cat(paste0("### Screening\n\n"))
}

timci::generate_calendar_heatmap(facility_data, date_visit)
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("### Recrutement\n\n"))
} else {
  cat(paste0("### Enrolment\n\n"))
}

if (nrow(baseline_data) > 0) {
  timci::generate_calendar_heatmap(baseline_data, date_visit)
}
```

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("# 2. Participants\n\n"))
} else {
  cat(paste0("# 2. Participants\n\n"))
}

options(qwraps2_markup = 'markdown')

all <- data.frame(facility_data)
all$sickness[is.na(all$sickness)] <- 0
all$inpatient[is.na(all$inpatient)] <- 0
all$consult_reason[is.na(all$consult_reason)] <- 0
all$prev_enrl[is.na(all$prev_enrl)] <- 0
all$repeat_consult[is.na(all$repeat_consult)] <- 0
all$consent[is.na(all$consent)] <- 0
all$yg_infant <- ifelse(all$yg_infant == 0, "2-59m", "0-2m")

summary_statistics <- list(
  "Age eligibility" = list(
    "0 - 59 months" = ~qwraps2::n_perc(age_incl == 1, 2),
    "First day of life" = ~qwraps2::n_perc(age_excl == 1, 2)
    ),
  "Visit eligibility" = list(
    "Sick child" = ~qwraps2::n_perc(sickness == 1, 2),
    "Inpatient admission" = ~qwraps2::n_perc(inpatient == 1, 2),
    "Trauma" = ~qwraps2::n_perc(consult_reason == 2, 2),
    "Immunisation" = ~qwraps2::n_perc(consult_reason == 3, 2),
    "Monitoring" = ~qwraps2::n_perc(consult_reason == 4, 2)
    ),
  "Multiple enrolments" = list(
    "Previous enrolment" = ~qwraps2::n_perc(prev_enrl == 1 | prev_enrl == 2, 2),
    "Last enrolment < 28 days" = ~qwraps2::n_perc(repeat_consult == 1, 2)
    ),
  "Consenting process outcome" = list(
    "Enrolled" = ~qwraps2::n_perc(consent == 1, 2)
    )
)
st <- qwraps2::summary_table(all, summary_statistics)
st1 <- qwraps2::summary_table(dplyr::group_by(all, yg_infant), summary_statistics)
print(cbind(st, st1))
```

```{r}
deidentified_facility_data <- timci::deidentify_data(study_data)
```

```{r fig.height=8, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("## Screening par poste de santé\n\n"))
} else {
  cat(paste0("## Screening by facility\n\n"))
}

stats <- timci::get_summary_by_facility(facility_data)
stats <- merge(x = stats, y = params$research_facilities, by.x = 'device_id', by.y = 'deviceid', all.x = TRUE)
timci::generate_enrolment_hist(stats, facility_label, screened, 5, 15, "Number of children screened", "facilities")
```

```{r fig.height=8, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("## Recrutement par poste de santé\n\n"))
} else {
  cat(paste0("## Enrolment by facility\n\n"))
}
timci::generate_enrolment_hist(stats, facility_label, children, 5, 15, "Number of children enrolled", "facilities")
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("## Carte thermique des recrutements par poste de santé\n\n"))
  cat(paste0("### Recrutement par rapport à l'objectif global\n\n"))
} else {
  cat(paste0("## Enrolment heatmap by facility\n\n"))
  cat(paste0("### Enrolment versus global target\n\n"))
}
timci::plot_enrolment_gauge(n_enrolled/(n_screened - n_repeat), "Enrolment rate\n(excl. repeat visits)", 100, 60, 85)
```
  
```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("### Recrutement par rapport à l'objectif hebdomadaire\n\n"))
  cat(paste0("### Causes de non-recrutement\n\n"))
} else {
  cat(paste0("### Enrolment versus weekly target\n\n"))
  cat(paste0("### Non-enrolment causes\n\n"))
}

non_enrolment_causes <- timci::count_screening(facility_data)
nec_pie_chart <- timci::generate_pie_chart(non_enrolment_causes)
plot(nec_pie_chart)
```

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("# 3. Visite de base\n\n"))
  cat(paste0("## Présentation clinique\n\n"))
  cat(paste0("### Orientation vers un centre de référence\n\n"))
} else {
  cat(paste0("# 3. Baseline visit\n\n"))
  cat(paste0("## Clinical presentation\n\n"))
  cat(paste0("### Referrals\n\n"))
}

options(qwraps2_markup = 'markdown')

if (nrow(baseline_data) > 0) {
  all <- data.frame(study_data)
  all$yg_infant <- ifelse(all$yg_infant == 0, "2-59m", "0-2m")
  
  summary_statistics <- list(
    "Referral" = list(
      "Reported (caregiver)" = ~qwraps2::n_perc(referral_cg == 1 | referral_cg == 2, 2),
      "Declined (caregiver)" = ~qwraps2::n_perc(referral_cg == 97, 2),
      "Reported (registry)" = ~qwraps2::n_perc(referral_hf == 1 | referral_hf == 2 | referral_hf == 3, 2),
      "Inpatient admission (registry)" = ~qwraps2::n_perc(referral_hf == 4, 2)
      )
  )
  referral_summary <- qwraps2::summary_table(all, summary_statistics)
  referral_summary1 <- qwraps2::summary_table(dplyr::group_by(all, yg_infant), summary_statistics)
  print(cbind(referral_summary, referral_summary1))
}
```

```{r}
if (nrow(baseline_data) > 0) {
  referral_data <- timci::extract_referrals(deidentified_facility_data)
  n_referrals <- nrow(referral_data)
  referral_pie_chart <- timci::generate_pie_chart(data.frame(group = c("Referred at Day 0", "Not referred at Day 0"), value = c(n_referrals, n_enrolled - n_referrals)))
  plot(referral_pie_chart)
}
```

```{r, results = "asis"}
wmin <- 7
wmax <- 10

if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("# 4. Suivi à Jour 7\n\n"))
  cat(paste0("La période valable pour le suivi à Jour 7 est de **", wmin, "** à **", wmax, "** jours."))
} else {
  cat(paste0("# 4. Day 7 follow-up\n\n"))
  cat(paste0("The valid Day 7 follow-up period is **", wmin, "** to **", wmax, "** days."))
}

day7fu_data <- NULL
if (!is.null(raw_day7fu_data)) {
  if (nrow(raw_day7fu_data) > 0) {

    day7fu_data <- timci::format_day7_data(raw_day7fu_data)[[1]]
    
    day7fu_data <- day7fu_data %>%
      dplyr::mutate(days = as.Date(date_call) - as.Date(date_day0), na.rm = TRUE)
  }
}
```

```{r}
if (!is.null(day7fu_data)) {
  if (nrow(day7fu_data) > 0) {
    n_reached_day7fu <- sum(!is.na(day7fu_data$cg_ok) & (day7fu_data$cg_ok == 1))
    n_valid_day7fu <- sum((day7fu_data$days >= wmin) & (day7fu_data$days < wmax))
  } else {
    n_reached_day7fu <- 0
    n_valid_day7fu <- 0
  }
  
  # gauge plots
  timci::plot_enrolment_gauge(n_reached_day7fu/n_enrolled, "Day 7 follow-up rate", 100, 80, 90)
  timci::plot_enrolment_gauge(n_valid_day7fu/n_enrolled, "Day 7 follow-up rate\nwithin the time window", 100, 80, 90)
}
```

```{r, results = "asis"}
options(qwraps2_markup = 'markdown')

if (!is.null(day7fu_data)) {
  if (nrow(day7fu_data) > 0) {
    
    all <- data.frame(day7fu_data)
    all$cg_ok[is.na(all$cg_ok)] <- 0
    all$status_day7[is.na(all$status_day7)] <- 0
    all$cure_day7[is.na(all$cure_day7)] <- 0
    all$cure_day7[is.na(all$cure_day7)] <- 0
    
    day7_call_ss <- list(
      "Call outcome" = list(
        "Participant reached" = ~qwraps2::n_perc(cg_reached == 1, 2),
        "Valid time window" = ~qwraps2::n_perc((days >= wmin) & (days < wmax), 2),
        "Lost to follow-up" = ~qwraps2::n_perc(cg_ok == 0, 2)
        )
    )
    print(qwraps2::summary_table(all, day7_call_ss))
    
    day7_outcome_ss <- list(
      "Cure" = list(
        "Known" = ~qwraps2::n_perc(cure_day7 == 1 | cure_day7 == 2 | cure_day7 == 3 | cure_day7 == 4, 2)
        ),
      "Hospitalisation" = list(
        "Reported" = ~qwraps2::n_perc(status_day7 == 2 | cure_day7 == 1, 2)
        )
    )
    print(qwraps2::summary_table(all, day7_outcome_ss))
  }
}
```

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("# 5. Suivi des visites à l'hôpital\n\n"))
} else {
  cat(paste0("# 5. Hospital follow-up\n\n"))
}
```

```{r, results = "asis"}
options(qwraps2_markup = 'markdown')

if (Sys.getenv('TIMCI_IS_RCT') == 1) {
  cat('# 6. Day 28 follow-up\n\n')
  if (!is.null(raw_day28fu_data)) {
    if (nrow(raw_day28fu_data) > 0) {
      
      wmin <- 28
      wmax <- 32
      
      day28fu_data <- timci::format_day28_data(raw_day28fu_data)[[1]]
      day28fu_data <- day28fu_data %>%
        dplyr::mutate(days = as.Date(date_call) - as.Date(date_day0), na.rm = TRUE)
      
      all <- data.frame(day28fu_data)
      all$a1_contact_a4_d_1b[is.na(all$cg_ok)] <- 0
      all$o1_o1_1a[is.na(all$status_day28)] <- 0
      all$o1_o1_1[is.na(all$cure_day28)] <- 0
      all$n1_o3_1[is.na(all$hf_visit_day28)] <- 0
      
      day28_call_ss <- list(
        "Call outcome" = list(
          "Participant reached" = ~qwraps2::n_perc(cg_reached == 1, 2),
          "Valid time window" = ~qwraps2::n_perc((days >= wmin) & (days < wmax), 2),
          "Lost to follow-up" = ~qwraps2::n_perc(cg_ok == 0, 2)
          )
      )
      print(qwraps2::summary_table(all, day28_call_ss))
    }
  }
}
```
