---
title: "TIMCI `r if (Sys.getenv('TIMCI_COUNTRY') == 'Tanzania' || Sys.getenv('TIMCI_COUNTRY') == 'India') {'Pragmatic cluster RCT - Monitoring Report'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {'Étude Longitudinale Observationnelle - Rapport de suivi'} else {'Longitudinal Observational Study (LS) - Monitoring Report'}`"
author: "`r if (Sys.getenv('TIMCI_COUNTRY') == 'Tanzania') {'Ifakara Health Institute (IHI)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'India') {'King George s Medical University (KGMU)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {'Université Cheikh Anta Diop de Dakar (UCAD)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Kenya') {'University of Nairobi (UoN)'} else if (Sys.getenv('TIMCI_COUNTRY') == 'Myanmar') {'Burnet Institute (BI)'} else {'Swiss Tropical and Public Health Institute (Swiss TPH)'}`"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M')`"
params:
  research_facilities: !r data.frame(deviceid = character(0), district = character(0), facility = character(0))
  start_date: NULL
  end_date: NULL
  day7fu_end_date: NULL
  sample_target: NULL
  facility_data: NULL
  raw_day7fu_data: NULL
  raw_hospit_data: NULL
  raw_day28fu_data: NULL<
  raw_withdrawal_data: NULL
  wfa_data: NULL
output:
  pdf_document:
    number_sections: true
    extra_dependencies:
      float: null
      flafter: null
      bm: null
      tocbibind: ["nottoc"]
      babel: ["french","english"]
      graphicx: null
      fancyhdr: null
      lastpage: null
classoption: table
---

```{r setup-rmd, include=FALSE}
library(magrittr)
library(readxl)
library(ggplot2)
library(lubridate)
library(gridExtra)
library(knitr)
library(kableExtra)
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      fig.pos='!H')
options(qwraps2_markup = 'rmarkdown')
options(knitr.table.format = "latex")

# Qwraps2 parameters
prec <- 1

#kableExtra table parameters
table_fs <- 7
figsize <- 3
total_row_ft <- "gray"
total_row_ft2 <- "white"
striped_row_bg <- "gray!10"
total_row_bg2 <- "gray"
```

\fancypagestyle{plain}{\pagestyle{fancy}}
\pagestyle{fancy}
\fancyhf{}
\setlength{\headheight}{32pt}
\renewcommand{\headrulewidth}{0pt}
\fancyhead[C]{\includegraphics[width=10cm]{banner.png}}
\fancyfoot[R]{Page \thepage\ of \pageref{LastPage}}
\fancyfoot[L]{TIMCI Data Monitoring Report v1.0 - Template: H. LANGET (Swiss TPH)}

```{r language, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  
  cat("\\selectlanguage{french}")
  
  age_eligibility_table_cap <-"Âge de l'enfant lors du screening."
  age_eligibility_table_gfn <- "Le nombre de screenings est déterminé à l'aide de l'ID de la tablette associée à un poste donné."
  all_str <- "Total"
  appendix_title <- "# Annexe\n\n"
  baseline_str <- "Visite primaire"
  baseline_visit_title_str <- "### Visites primaires\n\n"
  calendar_heatmap_title_str <- "## Cartes thermiques calendaires\n\n"
  clinical_presentation_title_str <- "## Présentation clinique\n\n"
  completion_table_cap <- "Nombre de patients dont la dernière visite est terminée."
  consent_cap <- "Consentement éclairé"
  consultation_nonsick_cap <- "Principal motif de consultation pour les enfants non malades."
  consultion_sick_cap <- "Principal motif de consultation pour les enfants malades."
  context_title_str <- "# Contexte\n\n"
  day7_phone_call_str <- "Appel téléphonique à Jour 7"
  eligibility_str <- "Individual child inclusion:\\begin{itemize}\\item Children 0 – 59 months for whom caregivers provide consent;\\item Consulting for an illness, or reported to be unwell when attending for a routine visit (e.g. vaccination, growth or chronic disease monitoring).\\end{itemize}Individual child exclusion:\\begin{itemize}\\item Children in the immediate post-natal period or first day of life;\\item Attending for a consultation related to trauma only (including new and follow-up presentations for burns, injuries, wounds);\\item Admitted within an inpatient part of the facility (including neonates delivered at the facility admitted with their mother);\\item Enrolled in the study within the preceding 28 days at any study facility.\\end{itemize}"
  eligibility_title <- "# Eligibilité\n\n"
  enrolment_rate_str <- "Taux de recrutement par rapport à l'objectif"
  enrolment_str <- "Recrutement"
  facility_cap <- "Liste des poste de recherche"
  intro_str <- "L’objectif global du projet TIMCI (Outils pour la prise en charge intégrée des maladies de l’enfant) est de réduire la morbidité et la mortalité chez les enfants malades dans les structures de soins primaires, tout en soutenant l’utilisation rationnelle et efficace des moyens diagnostiques et des médicaments par les prestataires de soins de santé. Le volet évaluation du projet vise à apporter des preuves de l’impact de l’introduction de l’oxymètre de pouls, associé à un Algorithme d’aide à la décision clinique (CDSA), sur la santé, les priorités opérationnelles, le coût et l’analyse cout-efficacité modélisée dans le contexte des soins primaires, pour les enfants âgés de 0 à 59 mois des pays à revenu faible ou intermédiaire (PRFI), en vue de faciliter la prise de décision et la mise à l’échelle aux niveaux national et international."
  hospital_submission_str <- "Hospitalisation"
  multi_rec_cap <- "Recrutements multiples"
  nonenrolment_cap <- "Causes de non-recrutement"
  notice_str <- "\\begin{center}\\textbf{Pour usage interne uniquement. Ne pas partager en dehors des équipes recherche. Les tableaux et les figures sont générés à partir des bases de données brutes, et non à partir des bases de données nettoyées, et les résultats de ce rapport peuvent donc être légèrement différents de ceux de l'analyse statistique formelle.}\\end{center}"
  plot0_str <- "Recrutement total\nvs. taille d'échantillon cible"
  plot1_str <- "Recrutement mensuel\nvs. cible mensuelle"
  plot2_str <- "Recrutement hebdomadaire\nvs. cible hebdomadaire"
  plot3_str <- "Taux de recrutement\n(hors visites secondaires)"
  plot4_str <- "Taux de suivi à Jour 7"
  plot5_str <- "Taux de suivi à Jour 7\ndans la fenêtre statistique"
  pox_title_str <- "## Oxymètre de pouls\n\n"
  referral_title_str <- "## Orientation vers un centre de référence\n\n"
  repeat_str <- "Visite secondaire"
  sample_size_str <- "Taille d'échantillon cible : "
  screening_str <- "Screening"
  screening_times_str <- "Heures de screening"
  sick_cap <- "Enfant malade lors du screening"
  submission_str <- "Soumissions"
  submission_table_cap <- "Nombre de visites."
  tech_info_str <- "# Informations techniques"
  title_str <- "# Indicateurs globaux\n\n"
  u18_mother_cap <- "Proportion de mères adolescentes si la mère n'est pas l'accompagnant principal"
  weekly_enrolment_cap <- "Recrutement hebdomadaire pour chaque semaine de l'étude."
  weekly_enrolment_hdr2 <- "## Recrutement hebdomadaire\n\n"
  withdrawal_str <- "Retrait"
  
} else {
  
  age_eligibility_table_cap <- "Age of the child at screening."
  age_eligibility_table_gfn <- "Screening number are extracted using the device ID associated with a given facility."
  all_str <- "All"
  appendix_title <- "# Appendix\n\n"
  baseline_str <- "Baseline visit"
  baseline_visit_title_str <- "### Baseline visits\n\n"
  calendar_heatmap_title_str <- "## Calendar heatmap\n\n"
  clinical_presentation_title_str <- "## Clinical presentation\n\n"
  completion_table_cap <- "Number of patients with latest completed visit."
  consent_cap <- "Informed consent"
  consultation_nonsick_cap <- "Primary reason for consultation for non sick children."
  consultion_sick_cap <- "Primary reason for consultation for sick children."
  context_title_str <- "# Context\n\n"
  day7_phone_call_str <- "Day 7 phone call"
  eligibility_str <- "Individual child inclusion:\\begin{itemize}\\item Children 0 – 59 months for whom caregivers provide consent;\\item Consulting for an illness, or reported to be unwell when attending for a routine visit (e.g. vaccination, growth or chronic disease monitoring).\\end{itemize}Individual child exclusion:\\begin{itemize}\\item Children in the immediate post-natal period or first day of life;\\item Attending for a consultation related to trauma only (including new and follow-up presentations for burns, injuries, wounds);\\item Admitted within an inpatient part of the facility (including neonates delivered at the facility admitted with their mother);\\item Enrolled in the study within the preceding 28 days at any study facility.\\end{itemize}"
  eligibility_title <- "# Eligibility\n\n"
  enrolment_rate_str <- "Enrolment rate vs. target"
  enrolment_str <- "Enrolment"
  facility_cap <- "List of research facilities"
  intro_str <- "The overall goal of the Tools for the Management of Childhood Illness (TIMCI) project is to reduce morbidity and mortality in sick children attending primary care facilities, while supporting the rational and efficient use of diagnostics and medicines by healthcare providers. The evaluation component of the project seeks to generate evidence on the health impact, operational priorities, cost and cost-effectiveness of introducing pulse oximetry, alone or embedded into a Clinical Decision Support Algorithm (CDSA), at primary care level in LMICs, for children 0 – 59 months of age, to facilitate national and international decision-making on scale-up."
  hospital_submission_str <- "Hospital visit"
  multi_rec_cap <- "Multiple enrolments"
  nonenrolment_cap <- "Non-enrolment causes"
  notice_str <- "\\begin{center}\\textbf{For internal use only. Do not share outside research teams. Tables and figures are generated from raw databases, not from the cleaned databases, and findings of this report can therefore be slightly different from those of the formal statistical analysis.}\\end{center}"
  plot0_str <- "Total enrolment\nvs. target sample size"
  plot1_str <- "Monthly enrolment\nvs. monthly target"
  plot2_str <- "Weekly enrolment\nvs. weekly target"
  plot3_str <- "Enrolment rate\n(excl. repeat visits)"
  plot4_str <- "Day 7 follow-up rate"
  plot5_str <- "Day 7 follow-up rate\nwithin the statistical window"
  pox_title_str <- "## Pulse oximetry\n\n"
  referral_title_str <- "## Referrals\n\n"
  repeat_str <- "Repeat visit"
  sample_size_str <- "Target sample size: "
  screening_str <- "Screening"
  screening_times_str <- "Screening times"
  sick_cap <- "Sickness at screening"
  submission_table_cap <- "Number of visits."
  submission_str <- "Submissions"
  tech_info_str <- "# Technical information"
  title_str <- "# Global indicators\n\n"
  u18_mother_cap <- "Proportion of underaged mothers if the mother is not the main caregiver"
  weekly_enrolment_cap <- "Weekly recruitment for each week of the study."
  weekly_enrolment_hdr2 <- "## Weekly enrolment\n\n"
  withdrawal_str <- "Withdrawal"
  
}
```

\setcounter{tocdepth}{2}
\tableofcontents

\newpage

```{r intro-text, results='asis'}
cat(paste0(notice_str, "\n\n", intro_str))
```

```{r setup-variables}
start_date <- params$start_date
end_date <- params$end_date
sample_target <- params$sample_target

if (!is.null(params$facility_data)) {
  
  facility_data <- params$facility_data
  raw_day7fu_data <- params$raw_day7fu_data
  raw_hospit_data <- params$raw_hospit_data
  raw_day28fu_data <- params$raw_day28fu_data
  raw_withdrawal_data <- params$raw_withdrawal_data
  wfa_data <- params$wfa_data
  
}

# Add facility generic information to the RCT/LS facility data
facility_data <- timci::allocate_screening_facility(facility_data,
                                                    params$research_facilities)

# Extract personally identifiable information from RCT/LS facility data
pii <- timci::extract_enrolled_participants(facility_data)[[2]]
# Add facility generic information to personally identifiable information
pii <- timci::allocate_screening_facility(pii,
                                          params$research_facilities)

if (!is.null(raw_day7fu_data)) {
  if (nrow(raw_day7fu_data) > 0) {
    raw_day7fu_data <- merge(x = raw_day7fu_data,
                             y = params$research_facilities[, c("facility_id", "facility_name")],
                             by.x = 'a1-fid',
                             by.y = 'facility_id',
                             all = FALSE)
  }
}

# if (!is.null(raw_hospit_data)) {
#   if (nrow(raw_hospit_data) > 0) {
#     raw_hospit_data <- merge(x = raw_hospit_data,
#                              y = params$research_facilities[, c("facility_id", "facility_name")],
#                              by.x = 'a1-fid',
#                              by.y = 'facility_id',
#                              all = FALSE)
#   }
#}

if (Sys.getenv('TIMCI_COUNTRY') == 'Tanzania' | Sys.getenv('TIMCI_COUNTRY') == 'India') {
  if (!is.null(raw_day28fu_data)) {
    if (nrow(raw_day28fu_data) > 0) {
      raw_day28fu_data <- merge(x = raw_day28fu_data,
                               y = params$research_facilities[, c("facility_id", "facility_name")],
                               by.x = 'a1-fid',
                               by.y = 'facility_id',
                               all = FALSE)
    }
  }
}

```

```{r process-facility-data, results='asis'}
if (nrow(facility_data) > 0) {
  week_nb <- ceiling(difftime(as.Date(end_date), as.Date(start_date) - 1, units = "weeks"))
  days_nb <- sum(!lubridate::wday(seq(as.Date(start_date), as.Date(end_date), "days")) %in% c("7", "1"))
  
  if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
    date_boundary_str <- paste0("Ce rapport couvre la période du **", start_date, "** (début de l'étude) au **", end_date, "** (semaine **", week_nb, "** de l'étude) pour le **Sénégal**.")
  } else {
    date_boundary_str <- paste0("This report covers the period from **", start_date, "** (study start) to **", end_date, "** (week **", week_nb,"** of the study) for **", Sys.getenv('TIMCI_COUNTRY'), "**.")
  }
  
  cat(date_boundary_str)
}
```

```{r context-title, results = "asis"}
cat(context_title_str)
```

```{r context-load-facilities, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  facilities <- params$research_facilities[, c("lvl2", "facility_id", "facility_name")]
  facilities <- facilities[!duplicated(facilities$facility_id), ]
} else{
  facilities <- params$research_facilities[, c("lvl2", "facility_id", "facility_name", "type")]
  facilities <- facilities[!duplicated(facilities$facility_id), ]
}
```

```{r context-display-facilities, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  # Sort by district and rename columns
  facility_disp <- facilities %>%
    dplyr::arrange(lvl2) %>%
    dplyr::rename('District sanitaire' = 'lvl2',
                  'ID' = 'facility_id',
                  'Poste de santé' = 'facility_name')
} else if(Sys.getenv('TIMCI_COUNTRY') == 'Kenya'){
  # Sort by County then type of facility
  facility_disp <- facilities %>%
    dplyr::arrange(lvl2, type) %>%
    dplyr::rename('County' = 'lvl2',
                  'ID' = 'facility_id',
                  'Facility' = 'facility_name',
                  'Type' = 'type')
  
} else{
  # Sort by district then type of facility
  facility_disp <- facilities %>%
    dplyr::arrange(lvl2, type) %>%
    dplyr::rename('District' = 'lvl2',
                  'ID' = 'facility_id',
                  'Facility' = 'facility_name',
                  'Type' = 'type')
  
}
facility_nb <- nrow(facilities)
if (Sys.getenv('TIMCI_COUNTRY') == 'Tanzania' || Sys.getenv('TIMCI_COUNTRY') == 'Kenya') {
  facilities$type <- tolower(facilities$type)
  hc_nb <- nrow(facilities %>% filter(type == "health center"))
  dispensary_nb <- nrow(facilities %>% filter(type == "dispensary"))
  cat(paste0(facility_nb, " research facilities, among which ", hc_nb, " health centres and ", dispensary_nb, " dispensaries"))
} else if (Sys.getenv('TIMCI_COUNTRY') == 'India') {
  hc_nb <- nrow(facilities %>% filter(type == "CHC"))
  dispensary_nb <- nrow(facilities %>% filter(type == "PHC"))
  cat(paste0(facility_nb, " research facilities, among which ", hc_nb, " CHCs and ", dispensary_nb, " PHCs"))
} else if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal'){
  cat(paste0(facility_nb, " postes de recherche"))
} else{
  cat(paste0(facility_nb, " research facilities"))
}
```

```{r context-facilities, results = "asis"}
facility_disp  %>% 
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  caption = facility_cap,
                  align = c("c", "c", "c")) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"),
                            font_size = table_fs) %>%
  kableExtra::row_spec(0, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::collapse_rows(columns = 1, valign = "top") 
```

\newpage

```{r, results = "asis"}
n_total <- 0

# Screening data
n_screened <- nrow(facility_data)
screening_data <- timci::extract_screening_data(facility_data)
visit_names <- c(screening_str)
submissions <- c(n_screened)
n_total <- n_total + n_screened

study_data <- timci::extract_all_visits(facility_data)
res <- timci::extract_enrolled_participants(facility_data)
noneligible <- timci::extract_noneligible(facility_data)

# Baseline data
baseline_data <- timci::extract_baseline_visits(study_data)
baseline_data <- timci::allocate_screening_facility(baseline_data,
                                                    params$research_facilities)

demog_data <- res[[1]]
n_enrolled <- nrow(demog_data)
n_enrolled7 <- nrow(dplyr::filter(demog_data, date_visit >= as.Date(end_date - 6)))
n_enrolled28 <- nrow(dplyr::filter(demog_data, date_visit >= as.Date(end_date - 27)))
visit_names <- c(visit_names, paste0(baseline_str, kableExtra::footnote_marker_number(1)))
submissions <- c(submissions, n_enrolled)

# Count facility submissions corresponding to repeat visits
repeat_data <- timci::extract_repeat_visits(study_data)
n_repeat <- nrow(repeat_data)
visit_names <- c(visit_names, paste0(repeat_str, kableExtra::footnote_marker_number(2)))
submissions <- c(submissions, n_repeat)

# Count Day 7 phone call submissions
if (!is.null(raw_day7fu_data)) {
  n_day7fu <- nrow(raw_day7fu_data)
  visit_names <- c(visit_names, day7_phone_call_str)
  submissions <- c(submissions, n_day7fu)
  n_total <- n_total + n_day7fu
}

if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  if (!is.null(raw_day28fu_data)) {
    n_day28fu <- nrow(raw_day28fu_data)
    visit_names <- c(visit_names, "Day 28 phone call")
    submissions <- c(submissions, n_day28fu)
    n_total <- n_total + n_day28fu
  }
}

# Count hospital visit submissions
if (!is.null(raw_hospit_data)) {
  n_hospit <- nrow(raw_hospit_data)
  visit_names <- c(visit_names, hospital_submission_str)
  submissions <- c(submissions, n_hospit)
  n_total <- n_total + n_hospit
}

# Count withdrawal submissions
if (!is.null(raw_withdrawal_data)) {
  n_withdrawal <- nrow(raw_withdrawal_data)
  visit_names <- c(visit_names, withdrawal_str)
  submissions <- c(submissions, n_withdrawal)
  n_total <- n_total + n_withdrawal
}
```

```{r, results='asis'}
cat(title_str)
```

```{r, results='asis'}
#timci::text_2_plot(paste0(days_nb))
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == "Senegal") {
  wdays_str <- " jours travaillés depuis le début de la collecte de données."
} else{
  wdays_str <- " working days since the start of the data collection."
}
cat(paste0(days_nb, wdays_str))
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == "Kenya") {
  hc_enrolment_target <- 14
  dispensary_enrolment_target <- 6
  day_target <- dispensary_enrolment_target * dispensary_nb + hc_enrolment_target * hc_nb
  enrolment_target <- round(day_target / facility_nb, 0)
} else if (Sys.getenv('TIMCI_COUNTRY') == "Senegal") {
  enrolment_target <- 4
} else if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania") {
  hc_enrolment_target <- 16
  dispensary_enrolment_target <- 4
  day_target <- dispensary_enrolment_target * dispensary_nb + hc_enrolment_target * hc_nb
  enrolment_target <- round(day_target / facility_nb, 0)
} else if (Sys.getenv('TIMCI_COUNTRY') == "India") {
  hc_enrolment_target <- 6
  dispensary_enrolment_target <- 1
  day_target <- dispensary_enrolment_target * dispensary_nb + hc_enrolment_target * hc_nb
  enrolment_target <- round(day_target / facility_nb, 0)
} else{
  enrolment_target <- 8
}
```

```{r, results='asis'}
cat(paste0(sample_size_str, sample_target))
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') != "Tanzania" || Sys.getenv('TIMCI_COUNTRY') != "Kenya") {
  day_target <- enrolment_target * facility_nb
  if (Sys.getenv('TIMCI_COUNTRY') == "Senegal") {
    cat(paste0("Cible de recrutement quotidienne : ", enrolment_target))
  } else{
    cat(paste0("Daily enrolment target: ", enrolment_target))
  }
} else{
  cat(paste0("Daily enrolment target: ", dispensary_enrolment_target, " (dispensaries) and ", hc_enrolment_target, " (health centres), with ", enrolment_target, " as an average target if the facility type is not taken into account"))
}
```

```{r, results='asis'}
if (nrow(facility_data) > 0) {
  plot0 <- timci::plot_gauge(n_enrolled/sample_target, plot0_str, 100, 75, 90, scale = 0.4)
  plot1 <- timci::plot_gauge(n_enrolled28/(min(20, days_nb) * day_target), plot1_str, 100, 62.5, 90, scale = 0.4)
  plot2 <- timci::plot_gauge(n_enrolled7/(min(5, days_nb) * day_target), plot2_str, 100, 62.5, 90, scale = 0.4)
  plot3 <- timci::plot_gauge(n_enrolled/(n_screened - n_repeat), plot3_str, 100, 70, 80, scale = 0.4)
}
```

```{r, results='asis'}
day7_wmin <- 7
day7_wmax <- 10

day7fu_data <- NULL
if (!is.null(raw_day7fu_data)) {
  if (nrow(raw_day7fu_data) > 0) {
    
    # Extract and clean all Day 7 follow-up data
    day7fu_data <- timci::format_day7_data(raw_day7fu_data)[[3]]
    day7fu_data <- day7fu_data[day7fu_data$child_id %in% baseline_data$child_id, ]
    
    # Extract and clean successful Day 7 follow-up data
    succ_day7fu_data <- timci::format_day7_data(raw_day7fu_data)[[1]]
    succ_day7fu_data <- clean_followup_for_rate_estimation(baseline_data, succ_day7fu_data)
    
    n_completed_day7fu <- sum((as.Date(succ_day7fu_data$date_day0, "%Y-%m-%d") + day7_wmin) <= Sys.Date(), na.rm = TRUE) 
    n_valid_day7fu <- sum(((as.Date(succ_day7fu_data$date_day0, "%Y-%m-%d") + day7_wmin) <= Sys.Date()) & (succ_day7fu_data$days >= day7_wmin) & (succ_day7fu_data$days <= day7_wmax), na.rm = TRUE) 
  } else {
    n_completed_day7fu <- 0
    n_valid_day7fu <- 0
  }
} else {
  n_completed_day7fu <- 0
  n_valid_day7fu <- 0
}
```

```{r}
n_due_day7fu <- sum((as.Date(demog_data$date_visit, "%Y-%m-%d") + day7_wmin) <= Sys.Date())
```

```{r, results='asis'}
if (n_due_day7fu > 0) {
  n_day7fu_rate <- n_completed_day7fu/n_due_day7fu
  n_day7fu_rate100 <- round(100 * n_day7fu_rate, prec)
  plot4 <- timci::plot_gauge(n_day7fu_rate, plot4_str, 100, 85, 95, scale = 0.4)
  plot5 <- timci::plot_gauge(n_valid_day7fu/n_due_day7fu, plot5_str, 100, 80, 90, scale = 0.4)
}
```

```{r, results='asis'}
day28_wmin <- 28
day28_wmax <- 32

if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  day28fu_data <- NULL
  if (!is.null(raw_day28fu_data)) {
    if (nrow(raw_day28fu_data) > 0) {
      
      # Extract and clean all Day 28 follow-up data
      day28fu_data <- timci::format_day28_data(raw_day28fu_data)[[3]]
      day28fu_data <- day28fu_data[day28fu_data$child_id %in% baseline_data$child_id, ]
      
      # Extract and clean successful Day 28 follow-up data
      succ_day28fu_data <- timci::format_day28_data(raw_day28fu_data)[[1]]
      succ_day28fu_data <- clean_followup_for_rate_estimation(baseline_data, succ_day28fu_data)
      
      n_completed_day28fu <- sum((as.Date(succ_day28fu_data$date_day0, "%Y-%m-%d") + day28_wmin) <= Sys.Date(), na.rm = TRUE) 
      n_valid_day28fu <- sum(((as.Date(succ_day28fu_data$date_day0, "%Y-%m-%d") + day28_wmin) <= Sys.Date()) & (succ_day28fu_data$days >= day28_wmin) & (succ_day28fu_data$days <= day28_wmax), na.rm = TRUE) 
    } else {
      n_completed_day28fu <- 0
      n_valid_day28fu <- 0
    }
  } else {
    n_completed_day28fu <- 0
    n_valid_day28fu <- 0
  }
  
  n_due_day28fu <- sum((as.Date(demog_data$date_visit, "%Y-%m-%d") + day28_wmin) <= Sys.Date())
}
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  if (n_due_day28fu > 0) {
    plot7 <- timci::plot_gauge(n_completed_day28fu/n_due_day28fu, "Day 28 follow-up rate", 100, 85, 95, scale = 0.4)
    plot8 <- timci::plot_gauge(n_valid_day28fu/n_due_day28fu, "Day 28 follow-up rate\nwithin the time window", 100, 80, 90, scale = 0.4)
  } 
}
```

```{r, results='asis'}
if (n_due_day7fu > 0) {
  if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
    if (n_due_day28fu > 0){
      gridExtra::grid.arrange(plot0, plot1, plot2, plot3, plot4, plot5, plot7, plot8,
                              ncol = 3, nrow = 3,
                              widths = unit(c(6,6,6), c("cm", "cm", "cm")),
                              heights = unit(c(4,4,4), c("cm", "cm", "cm")))
    } else{
      gridExtra::grid.arrange(plot0, plot1, plot2, plot3, plot4, plot5,
                            ncol = 3, nrow = 3,
                            widths = unit(c(6,6,6), c("cm", "cm", "cm")),
                            heights = unit(c(4,4,4), c("cm", "cm", "cm")))
    }
  } else{
    gridExtra::grid.arrange(plot0, plot1, plot2, plot3, plot4, plot5,
                            ncol = 3, nrow = 3,
                            widths = unit(c(6,6,6), c("cm", "cm", "cm")),
                            heights = unit(c(4,4,4), c("cm", "cm", "cm")))
  }
} else{
  gridExtra::grid.arrange(plot0, plot1, plot2, plot3,
                          ncol = 3, nrow = 3,
                          widths = unit(c(6,6,6), c("cm", "cm", "cm")),
                          heights = unit(c(4,4,4), c("cm", "cm", "cm")))
}
```

```{r submissions-1, results = "asis"}
visit_names <- c(all_str, visit_names)
submissions <- c(n_total, submissions)

out <- data.frame(visit_names, submissions)
out %>%
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  col.names = c("Submission", "N"),
                  align = c("l", "c"),
                  caption = submission_table_cap,
                  escape = FALSE) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"),
                            font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg) %>%
  kableExtra::footnote(number = c("Day 0 visit (enrolment on the same day as the screening).",
                                  "All other visits that occur during the enrolment period."),
                       escape = FALSE)
```

```{r completion}
if (!is.null(day7fu_data)) {
  if (nrow(day7fu_data) > 0) {
    # full_df <- merge(x = baseline_data[, c("child_id", "facility_name")],
    #                  y = day7fu_data[, c("child_id", "proceed_day7")],
    #                  by = 'child_id',
    #                  all.x = TRUE)
    # 
    # full_df %>%
    #   knitr::kable(head(full_df, n = 10))
  
    # completion_statistics <- list(
    #   "" = list(
    #     "Day 7" = ~qwraps2::n_perc(day7_done == 1, prec),
    #     )
    # )
    # out <- format_summary_table(full_df, completion_statistics, facility_name)
    # out %>%
    #   kableExtra::kbl(booktabs = TRUE,
    #                   linesep = "",
    #                   caption = completion_table_cap) %>%
    #   kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"),
    #                             font_size = table_fs) %>%
    #   kableExtra::row_spec(0, bold = TRUE) %>%
    #   kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    #   kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
  }
}
```

\newpage

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("# Participants\n\n")
} else {
  cat("# Participants\n\n")
}
```

```{r, results='asis'}
cat(weekly_enrolment_hdr2)
```

```{r, results = "asis", fig.height = figsize}
if (!is.null(baseline_data)){
    if (length(baseline_data) > 0 & nrow(baseline_data) > 0) {
      val <- day_target * 5
      p <- timci::generate_week_bar_plot(date_vec = baseline_data$date_visit,
                                         date_min = as.Date(start_date),
                                         date_max = as.Date(as.Date(end_date) + 7),
                                         ylbl = paste0(enrolment_str),
                                         rref = val,
                                         relative = FALSE)
      plot(p)
  }
}
```

```{r, results='asis'}
if (!is.null(baseline_data)){
    if (length(baseline_data) > 0 & nrow(baseline_data) > 0) {
       baseline_data %>%
        dplyr::mutate(week = lubridate::floor_date(as.Date(baseline_data$date_visit),
                                                   "week",
                                                   week_start = getOption("lubridate.week.start", 1))) %>%
        dplyr::group_by(week) %>%
        dplyr::tally() %>%
        dplyr::rename('N' = 'n') %>%
        kableExtra::kbl(booktabs = TRUE,
                        linesep = "",
                        align = c("l", "c"),
                        caption = weekly_enrolment_cap) %>% 
        kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
        kableExtra::row_spec(0, bold = TRUE) %>%
        kableExtra::row_spec(1:(nrow(baseline_data)/2) * 2, background = striped_row_bg)
  }
}
```

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("## Fréquentation hebdomadaire des postes\n\n")
} else {
  cat("## Clinic weekly attendance\n\n")
}
```

```{r, results = "asis", fig.height = figsize}
if (!is.null(wfa_data)) {
  if (length(wfa_data) > 0 & nrow(wfa_data) > 0) {
    if (Sys.getenv('TIMCI_COUNTRY') != 'India') {
      p <- timci::generate_week_bar_plot2(date_vec = wfa_data$date,
                                          values = wfa_data$u5_attendance_last_week,
                                          date_min = as.Date(start_date),
                                          date_max = as.Date(as.Date(end_date) + 7),
                                          ylbl = "Under 5 attendance")
      plot(p)
    }
  }
}
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("## Nombre de soumissions au cours des 30 derniers jours\n\n")
} else {
  cat("## Number of submissions during the last 30 days\n\n")
}
```

```{r, results='asis', fig.height = figsize}
w <- 29
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("### Recrutement quotidien\n\n"))
} else {
  cat(paste0("### Daily enrolment\n\n"))
}
if (nrow(baseline_data) > 0) {
  timci::generate_day_bar_plot(date_vec = baseline_data$date_visit,
                               date_min = as.Date(end_date - w),
                               date_max = as.Date(end_date + 1),
                               ylbl = enrolment_str,
                               rref = day_target)
}
```

```{r, results='asis', fig.height = figsize}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("### Visites primaires et secondaires\n\n"))
} else {
  cat(paste0("### Baseline and repeat visits\n\n"))
}

# Frequency
if (nrow(baseline_data) > 0) {
  timci::generate_day_cumbar_plot(list(noneligible$date_visit,
                                       baseline_data$date_visit,
                                       repeat_data$date_visit),
                                  c("Non-eligible", baseline_str, repeat_str),
                                  as.Date(end_date - w),
                                  as.Date(end_date + 1),
                                  ylbl = submission_str)
} else{
  cat('N/A\n\n')
}
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("## Cartes thermiques calendaires\n\n")
  cat("### Screening\n\n")
} else {
  cat("## Calendar heatmaps\n\n")
  cat("### Screening\n\n")
}

timci::generate_calendar_heatmap2(facility_data,
                                  date_visit,
                                  legendtitle = "Number of screenings")
```

```{r, results='asis'}

```

```{r, results='asis'}
cat(baseline_visit_title_str)

if (nrow(baseline_data) > 0) {
  timci::generate_calendar_heatmap2(baseline_data,
                                    date_visit,
                                    legendtitle = "Number of enrolments")
}
```

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("## Heure de début du screening\n\n")
} else {
  cat("## Screening start times\n\n")
}
```

```{r, results = "asis", fig.height = figsize}
timci::generate_time_hist_plot(facility_data, screening_times_str)
```

\newpage

```{r, results = "asis"}
cat(eligibility_title)
```

```{r, results = "asis"}
cat(eligibility_str)
```

```{r, results = "asis"}
all <- data.frame(facility_data)
all$yg_infant <- ifelse(all$yg_infant == 0, "2-59m", "0-2m")

age_statistics <- list(
  "Facility" = list(
    "First day of life" = ~qwraps2::n_perc(age_excl == 1, prec),
    "1 - 59 days" = ~qwraps2::n_perc(age_excl == 0 & age_incl == 1 & yg_infant == "0-2m", prec),
    "2 - 59 months" = ~qwraps2::n_perc(age_incl == 1 & yg_infant == "2-59m", prec),
    "Above 59 months" = ~qwraps2::n_perc(age_incl == 0, prec)
    )
)
out <- format_summary_table(all, age_statistics, facility_name)
out %>% 
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  align = c("c", "c", "c", "c"),
                  caption = age_eligibility_table_cap) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::column_spec(5, color = ifelse(grepl(pattern = "(0.0%)", x = out[, 4], fixed = TRUE),
                                            "red",
                                            "black")) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg) %>%
  kableExtra::footnote(general = c(age_eligibility_table_gfn),
                       footnote_as_chunk = TRUE)
```

```{r, results = "asis"}
all <- all %>% filter(age_incl == 1 & age_excl == 0)
all$sickness[is.na(all$sickness)] <- 0

sickness_statistics <- list(
  "Facility" = list(
    "Sick" = ~qwraps2::n_perc(sickness == 1, prec),
    "Not sick" = ~qwraps2::n_perc(sickness == 0, prec)
    )
)
out <- format_summary_table(all, sickness_statistics, facility_name)
out %>% 
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  align = c("c", "c"),
                  caption = sick_cap) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::column_spec(3, color = ifelse(grepl(pattern = "(0.0%)", x = out[, 2], fixed = TRUE),
                                            "red",
                                            "black")) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
```

```{r, results = "asis"}
sick <- all %>% filter(sickness == 1)
nonsick <- all %>% filter(sickness == 0)
all <- sick
all$consult_reason[is.na(all$consult_reason)] <- 0

sick_reason_statistics <- list(
  "Facility" = list(
    "Sickness" = ~qwraps2::n_perc(consult_reason == 1, prec),
    "Trauma" = ~qwraps2::n_perc(consult_reason == 2 & sickness == 1, prec),
    "Immunisation" = ~qwraps2::n_perc(consult_reason == 3 & sickness == 1, prec),
    "Monitoring" = ~qwraps2::n_perc(consult_reason == 4 & sickness == 1, prec)
    )
)
out <- format_summary_table(all, sick_reason_statistics, facility_name) 
out %>% 
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  align = c("c", "c", "c", "c"),
                  caption = consultion_sick_cap) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
```

```{r, results = "asis"}
all <- nonsick
all$inpatient[is.na(all$inpatient)] <- 0
all$consult_reason[is.na(all$consult_reason)] <- 0

reason_statistics <- list(
  "Facility" = list(
    "Trauma" = ~qwraps2::n_perc(consult_reason == 2 & sickness == 0, prec),
    "Immunisation" = ~qwraps2::n_perc(consult_reason == 3 & sickness == 0, prec),
    "Monitoring" = ~qwraps2::n_perc(consult_reason == 4 & sickness == 0, prec),
    "Inpatient admission" = ~qwraps2::n_perc(inpatient == 1, prec)
    )
)
if (!is.null(all) & length(all) > 0 & nrow(all) > 0) {
  out <- format_summary_table(all, reason_statistics, facility_name)
  out %>% 
    kableExtra::kbl(booktabs = TRUE,
                    linesep = "",
                    align = c("c", "c", "c", "c"),
                    caption = consultation_nonsick_cap) %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
}
```

```{r, results = "asis"}
all <- sick
all$cg_eligibility[is.na(all$cg_eligibility)] <- 0

if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cg_age_eligibility_table_cap <- "Âge de l'accompagnant principal"
} else {
  cg_age_eligibility_table_cap <- "Caregiver's age"
}

caregiver_statistics <- list(
  "Facility" = list(
    "Mother < 18" = ~qwraps2::n_perc(cg_eligibility == 0 & main_cg == 1, prec),
    "Other < 18" = ~qwraps2::n_perc(cg_eligibility == 0 & main_cg != 1, prec),
    ">= 18" = ~qwraps2::n_perc(cg_eligibility == 1, prec)
    )
)
out <- format_summary_table(all, caregiver_statistics, facility_name)
out <- gsub("%", "\\\\%", out)
out %>% 
  kableExtra::kbl(booktabs = TRUE,
                  align = c("c", "c", "c"),
                  linesep = "",
                  caption = cg_age_eligibility_table_cap,
                  col.names = c("Mother < 18", "Other < 18", "$\\bm{\\geq 18}$"),
                  escape = FALSE) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
```

```{r, results = "asis"}
all <- sick %>% filter(main_cg != 1 & !is.na(underaged_mother))

if (nrow(all) > 0) {
  mother_statistics <- list(
    "Summary" = list(
      "< 18" = ~qwraps2::n_perc(underaged_mother == 1, prec),
      ">= 18" = ~qwraps2::n_perc(underaged_mother == 0, prec)
      )
  )

  out <- format_summary_table(all, mother_statistics, facility_name)
  out <- gsub("%", "\\\\%", out)
  out %>% 
    kableExtra::kbl(booktabs = TRUE,
                    align = c("c", "c"),
                    linesep = "",
                    caption = u18_mother_cap,
                    col.names = c("< 18", "$\\bm{\\geq 18}$"),
                    escape = FALSE) %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
}
```

```{r, results = "asis"}
all <- sick %>% filter(cg_eligibility == 1)
all$prev_enrl[is.na(all$prev_enrl)] <- 0
all$repeat_consult[is.na(all$repeat_consult)] <- 0

summary_statistics <- list(
  "Summary" = list(
    "First" = ~qwraps2::n_perc(prev_enrl == 3 | prev_enrl == 98, prec),
    "Previous" = ~qwraps2::n_perc(prev_enrl == 1 | prev_enrl == 2, prec),
    "Last <= 28 days" = ~qwraps2::n_perc(repeat_consult == 1, prec),
    "Last > 28 days" = ~qwraps2::n_perc((prev_enrl == 1 | prev_enrl == 2) & repeat_consult == 0, prec)
    )
)
out <- format_summary_table(all, summary_statistics, facility_name)
out <- gsub("%", "\\\\%", out)
out %>% 
  kableExtra::kbl(booktabs = TRUE,
                  align = c("c", "c", "c", "c"),
                  linesep = "",
                  caption = multi_rec_cap,
                  col.names = c("First", "Previous", "Last $\\bm{\\leq 28}$ days", "Last > 28 days"),
                  escape = FALSE) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
```

```{r, results = "asis"}
all <- all %>% filter((prev_enrl == 3 | prev_enrl == 98) | ((prev_enrl == 1 | prev_enrl == 2) & repeat_consult == 0))

consent_statistics <- list(
  "Facility" = list(
    "Consented" = ~qwraps2::n_perc(consent == 1, prec),
    "Not consented" = ~qwraps2::n_perc(consent == 0, prec)
    )
)
out <- format_summary_table(all, consent_statistics, facility_name)
out %>% 
  kableExtra::kbl(booktabs = TRUE,
                  linesep = "",
                  align = c("c", "c"),
                  caption = consent_cap) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE) %>%
  kableExtra::column_spec(2, color = ifelse(grepl(pattern = "(100.0%)", x = out[, 1], fixed = TRUE),
                                            "red",
                                            "black")) %>%
  kableExtra::column_spec(3, color = ifelse(grepl(pattern = "(0.0%)", x = out[, 2], fixed = TRUE),
                                            "red",
                                            "black")) %>%
  kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
  kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
```
  
```{r, results='asis', fig.height = figsize, fig.cap = nonenrolment_cap}
non_enrolment_causes <- timci::count_screening(facility_data)
nec_pie_chart <- timci::generate_pie_chart(non_enrolment_causes)
plot(nec_pie_chart)
```

\newpage

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("# Visite primaire\n\n"))
} else {
  cat(paste0("# Baseline visit\n\n"))
}
```

```{r contact-details-title, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("## Informations de contact")
} else {
  cat("## Contact details")
}
```

```{r, results = "asis"}
if (!is.null(pii)) {
  if (nrow(pii) > 0) {
    
    all <- data.frame(pii)
    all$phone_nb[!is.na(all$phone_nb)] <- 1
    all$phone_nb[is.na(all$phone_nb)] <- 0
    all$phone_nb2[!is.na(all$phone_nb2)] <- 1
    all$phone_nb2[is.na(all$phone_nb2)] <- 0
    
    phone_stats <- list(
      "Facility" = list(
        "0 phone numbers" = ~qwraps2::n_perc(phone_nb == 0, prec),
        "1 phone number" = ~qwraps2::n_perc(phone_nb == 1, prec),
        "2 phone numbers" = ~qwraps2::n_perc((phone_nb == 1) & (phone_nb2 == 1), prec)
        )
    )
    
    out <- format_summary_table(all, phone_stats, facility_name)
    out %>% 
      kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
      kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
      kableExtra::row_spec(0, bold = TRUE) %>%
      kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
      kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
    
  }
}
```

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') != 'India') {
  
  if (!is.null(pii)) {
    if (nrow(pii) > 0) {
      
      all <- all %>%
        dplyr::filter(all$phone_nb == 0)
      
      all$cmty[is.na(all$cmty)] <- 0
      all$cmty[!is.na(all$cmty) & "hapana" %in% tolower(all$cmty)] <- 0
      all$cmty[!is.na(all$cmty) & !("hapana" %in% tolower(all$cmty))] <- 1
      all$location[all$location != '' & all$location != ' ' & all$location != 'Outside the region'] <- 1
      all$location[all$location == '' | all$location == ' ' | all$location == 'Outside the region'] <- 0
      
      contact_details_stats <- list(
        "Facility" = list(
          "No community contact" = ~qwraps2::n_perc((cmty == 0) & (phone_nb == 0), prec),
          "Unknown residence" = ~qwraps2::n_perc((location == 0) & (phone_nb == 0), prec)
          )
      )
  
      out <- format_summary_table(all, contact_details_stats, facility_name)
      out %>%
        kableExtra::kbl(booktabs = TRUE,
                        linesep = "",
                        align = c("c", "c")) %>%
        kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
        kableExtra::row_spec(0, bold = TRUE) %>%
        kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
        kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
      
    }
  }
}
```

\newpage

```{r header-clinical-presentation, results = "asis"}
cat(clinical_presentation_title_str)
```

```{r, results = "asis"}
if (nrow(baseline_data) > 0) {
  all <- data.frame(baseline_data)
  
  clinical_presentation_statistics <- list(
    "Facility" = list(
      "Convulsions" = ~qwraps2::n_perc(sx_convulsions == 1, prec),
      "Lethargy" = ~qwraps2::n_perc(sx_lethargy == 1, prec),
      "Vomit" = ~qwraps2::n_perc(sx_vomit == 1, prec),
      "Less appetite" = ~qwraps2::n_perc(sx_less_feed == 1, prec)
      )
  )
  out <- format_summary_table(all, clinical_presentation_statistics, facility_name)
  out %>% 
    kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
}
```

```{r, results = "asis"}
if (nrow(baseline_data) > 0) {
  all <- data.frame(baseline_data)
  
  clinical_presentation_statistics <- list(
    "Facility" = list(
      "Cough" = ~qwraps2::n_perc(sx_cough == 1, prec),
      "Difficulty breathing" = ~qwraps2::n_perc(sx_difficulty_breath == 1, prec),
      "Diarrhoea" = ~qwraps2::n_perc(sx_diarrhoea == 1, prec),
      "Fever" = ~qwraps2::n_perc(sx_fever == 1, prec)
      )
  )
  out <- format_summary_table(all, clinical_presentation_statistics, facility_name)
  out %>% 
    kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
}
```

\newpage

```{r header-pox, results = "asis"}
cat(pox_title_str)
```

```{r, results = "asis"}
if (nrow(baseline_data) > 0) {
  
  if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
    cat(paste0("### 1 - 59 jours\n\n"))
  } else {
    cat(paste0("### 1 - 59 days\n\n"))
  }
  
  all <- data.frame(baseline_data) %>% filter(yg_infant == 1)
  
  pox_statistics <- list(
    "Facility" = list(
      "Reported" = ~qwraps2::n_perc(spo2 == 1, prec)
      )
  )
  out <- format_summary_table(all, pox_statistics, facility_name)
  out %>% 
    kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
}
```

```{r, results = "asis"}
if (nrow(baseline_data) > 0) {
  
  if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
    cat(paste0("### 2-59 months\n\n"))
  } else {
    cat(paste0("### 2-59 months\n\n"))
  }
  
  all <- data.frame(baseline_data) %>% filter(yg_infant == 0)
  
  pox_statistics <- list(
    "Facility" = list(
      "Reported" = ~qwraps2::n_perc(spo2 == 1, prec)
      )
  )
  out <- format_summary_table(all, pox_statistics, facility_name) 
  out %>% 
    kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
}
```

\newpage

```{r header-referrals, results = "asis"}
cat(referral_title_str)
```

```{r}
if (nrow(baseline_data) > 0) {
  all <- data.frame(baseline_data)
  #all$yg_infant <- ifelse(all$yg_infant == 0, "2-59 months", "2-59 days")
  all$referral_cg <- ifelse(!is.na(all$referral_cg), all$referral_cg, 100)
  all$referral_hf <- ifelse(!is.na(all$referral_hf), all$referral_hf, 100)
}
```

```{r header-referrals-cg, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("### Rapporté par l'accompagnant à la sortie de la consultation\n\n"))
} else {
  cat(paste0("### Reported by the caregiver at the consultation exit\n\n"))
}
```

```{r, results = "asis"}
if (nrow(baseline_data) > 0) {
  summary_statistics <- list(
    "Facility" = list(
      "Yes" = ~qwraps2::n_perc(referral_cg == 1, prec),
      "No" = ~qwraps2::n_perc(referral_cg == 0, prec),
      "Unknown" = ~qwraps2::n_perc(referral_cg == 98, prec),
      "Declined" = ~qwraps2::n_perc(referral_cg == 97, prec),
      "Lost at exit" = ~qwraps2::n_perc(referral_cg == 100, prec)
      )
  )
  out <- format_summary_table(all, summary_statistics, facility_name) 
  out %>% 
    kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::column_spec(2, color = ifelse(as.numeric(gsub("\\(([^()]*)%\\)|.", "\\1", x = out[, 1], perl = TRUE)) >= 10,
                                              "red",
                                              "black")) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
  
}
```

```{r header-referrals-hf, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("### Rapporté dans le registre du poste\n\n"))
} else {
  cat(paste0("### Reported in the facility registry\n\n"))
}
```

```{r, results = "asis"}
if (nrow(baseline_data) > 0) {
  summary_statistics <- list(
    "Facility" = list(
      "Yes" = ~qwraps2::n_perc(referral_hf == 1, prec),
      "No" = ~qwraps2::n_perc(referral_hf == 0, prec)
      )
  )
  out <- format_summary_table(all, summary_statistics, facility_name) 
  out %>% 
    kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
    kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
    kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
} 
```

```{r, fig.height = figsize}
if (nrow(baseline_data) > 0) {
  referral_data <- timci::extract_referrals(baseline_data)
  n_referrals <- nrow(referral_data)
  referral_pie_chart <- timci::generate_pie_chart(data.frame(group = c("Referred at Day 0", "Not referred at Day 0"), value = c(n_referrals, n_enrolled - n_referrals)))
  plot(referral_pie_chart)
}
```

\newpage

```{r, results = "asis"}

if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("# Suivi à Jour 7\n\n"))
  cat(paste0("La période valable pour le suivi à Jour 7 est de **", day7_wmin, "** à **", day7_wmax, "** jours.\n\n"))
  if (n_due_day7fu > 0) {
    cat(paste0("**", n_due_day7fu, "** participants devraient avoir complété leur suivi à Jour 7.\n\n"))
    cat(paste0("**", n_completed_day7fu, "** participants (", n_day7fu_rate100,"%) ont complété leur suivi à Jour 7."))
  }
} else {
  cat(paste0("# Day 7 follow-up\n\n"))
  cat(paste0("The valid Day 7 follow-up period is **", day7_wmin, "** to **", day7_wmax, "** days.\n\n"))
  if (n_due_day7fu > 0) {
    cat(paste0("**", n_due_day7fu, "** participants should have completed their Day 7 follow-up.\n\n"))
    cat(paste0("**", n_completed_day7fu, "** participants (", n_day7fu_rate100,"%) completed their Day 7 follow-up."))
  }
}
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("## Appels hebdomadaires\n\n")
} else {
  cat("## Weekly calls\n\n")
}
```

```{r, results = "asis", fig.height = figsize, fig.cap = "Weekly Day 7 follow-up submissions (plain bars) vs. expected number of submissions (gray line)"}
if (!is.null(raw_day7fu_data) & length(raw_day7fu_data) > 0 & nrow(raw_day7fu_data) > 0) {
  p <- timci::generate_week_bar_plot(date_vec = raw_day7fu_data$date,
                                     date_min = as.Date(start_date),
                                     date_max = as.Date(Sys.Date() + 7),
                                     ylbl = paste0(enrolment_str),
                                     date_vec_ref = as.Date(as.Date(baseline_data$date_visit) + 7))
  plot(p)
}
```

```{r, results='asis'}
raw_day7fu_data %>%
  dplyr::mutate(week = lubridate::floor_date(as.Date(raw_day7fu_data$date),
                                             "week",
                                             week_start = getOption("lubridate.week.start", 1))) %>%
  dplyr::group_by(week) %>%
  dplyr::tally() %>%
  dplyr::rename('N' = 'n') %>%
  kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
  kableExtra::kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header"), font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE)
```

```{r, results='asis', fig.height = figsize, fig.cap = "Day 7 follow-up submissions (plain bars) vs. expected number of submissions (gray line)  over the last 30 days"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("## Nombre de soumissions au cours des 30 derniers jours\n\n")
} else {
  cat("## Number of submissions during the last 30 days\n\n")
}

if (!is.null(raw_day7fu_data)) {
  if (nrow(raw_day7fu_data) > 0) {

    p <- timci::generate_day_bar_plot(raw_day7fu_data$date,
                                      as.Date(Sys.Date() - w),
                                      as.Date(Sys.Date() + 1),
                                      ylbl = submission_str,
                                      date_vec_ref = as.Date(as.Date(baseline_data$date_visit) + 7))
    plot(p)
  } else{
    cat('0 submissions since the start of the study.\n\n')
  }
} else {
  cat('0 submissions since the start of the study.\n\n')
  }
```

```{r, results='asis'}
cat(calendar_heatmap_title_str)

if (!is.null(raw_day7fu_data)) {
  if (nrow(raw_day7fu_data) > 0) {
    timci::generate_calendar_heatmap2(raw_day7fu_data,
                                      date,
                                      legendtitle = "Number of day 7 follow-up phone calls")
  } else{
    cat('N/A\n\n')
  }
} else{
    cat('N/A\n\n')
  }
```

```{r day7-data-monitoring-title, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("## Tentatives d'appel enregistrées")
} else {
  cat("## Recorded call attempts")
}
```

```{r, results = "asis"}
# Add facility generic information to the RCT/LS facility data
day7fu_data <- merge(x = day7fu_data,
                     y = params$research_facilities[, c("facility_id", "facility_name")],
                     by.x = 'fid',
                     by.y = 'facility_id',
                     all = FALSE)
```

```{r, results = "asis"}
if (!is.null(day7fu_data)) {
  if (nrow(day7fu_data) > 0) {
    
    all <- data.frame(day7fu_data)
    all$cg_reached[is.na(all$cg_reached)] <- 0
    
    day7_call_stats <- list(
      "District" = list(
        "Successful call" = ~qwraps2::n_perc(call_ok == 1, prec),
        "Completed follow-up" = ~qwraps2::n_perc(proceed_day7 == 1, prec)
        )
    )
    
    out <- format_summary_table(all, day7_call_stats, facility_name) 
    out %>% 
      kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
      kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
      kableExtra::row_spec(0, bold = TRUE) %>%
      kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
      kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg) %>%
      kableExtra::footnote(general = "denominator = all Day 7 call attempts that have been recorded.")
    
  }
}
```

```{r, results = "asis"}
if (!is.null(day7fu_data)) {
  if (nrow(day7fu_data) > 0) {
    
    all$respondent_ok[is.na(all$respondent_ok)] <- 0
    all$cg_ok[is.na(all$cg_ok)] <- 0
    
    day7_call_stats <- list(
      "District" = list(
        "Caregiver reached" = ~qwraps2::n_perc(cg_reached == 1, prec),
        "Caregiver OK" = ~qwraps2::n_perc(cg_ok == 1, prec),
        "Other OK" = ~qwraps2::n_perc(respondent_ok == 1, prec)
        )
    )
    
    out <- format_summary_table(all, day7_call_stats, facility_name) 
    out %>% 
      kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
      kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
      kableExtra::row_spec(0, bold = TRUE) %>%
      kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
      kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg) %>%
      kableExtra::footnote(general = "denominator = all Day 7 call attempts that have been recorded.")
    
  }
}
```

```{r day7-successful-follow-up-title, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat("## Suivis réalisés")
} else {
  cat("## Completed follow-ups")
}
```

```{r}
if (!is.null(day7fu_data)) {
  if (nrow(day7fu_data) > 0) {
    succ_day7fu_data <- merge(x = succ_day7fu_data,
                              y = params$research_facilities[, c("facility_id", "facility_name")],
                              by.x = 'fid',
                              by.y = 'facility_id',
                              all = FALSE)
  }
}
```

```{r, results = "asis"}
if (!is.null(day7fu_data)) {
  if (nrow(day7fu_data) > 0) {
    
    all <- data.frame(succ_day7fu_data)
    
    day7_outcome_ss <- list(
      "summary" = list(
        "Before day 7" = ~qwraps2::n_perc(days == 6, prec),
        "Day 7-10" = ~qwraps2::n_perc(days >= 7 & days <= 10, prec),
        "Day 11-12" = ~qwraps2::n_perc(days >= 11 & days <= 12, prec),
        "Above day 12" = ~qwraps2::n_perc(days > 12, prec),
        "Average" = ~qwraps2::mean_sd(days, denote_sd = "paren")
        )
      )
    out <- format_summary_table(all, day7_outcome_ss, facility_name) 
    out %>% 
      kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
      kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
      kableExtra::row_spec(0, bold = TRUE) %>%
      # kableExtra::column_spec(2, color = ifelse(as.numeric(gsub("\\(([^()]*)%\\)|.", "\\1", x = out[, 1], perl = TRUE)) > 0,
      #                                           "red",
      #                                           "black")) %>%
      kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
      kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg) %>%
      kableExtra::footnote(general = "Mean and standard deviation (SD) are represented by the format \\\\textit{mean (SD)}.",
                           escape = FALSE)
  }
}
```

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == "India") {
  hospit_value <- 13
} else{
  hospit_value <- 1
}

if (!is.null(day7fu_data)) {
  if (nrow(day7fu_data) > 0) {
    
    all <- data.frame(succ_day7fu_data)
    
    all$cure_day7[is.na(all$cure_day7)] <- 0
    
    day7_outcome_ss <- list(
      "summary" = list(
        "Cure" = ~qwraps2::n_perc(cure_day7 == 1 | cure_day7 == 2, prec),
        "Death" = ~qwraps2::n_perc(status_day7 == 3, prec),
        "Higher level visit" = ~qwraps2::n_perc(status_day7 == 2 | (status_day7 != 2 & hf_visit_day7 == 1 & hf_visit_type == hospit_value), prec)
        )
      )
    out <- format_summary_table(all, day7_outcome_ss, facility_name) 
    out %>% 
      kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
      kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
      kableExtra::row_spec(0, bold = TRUE) %>%
      # kableExtra::column_spec(3, color = ifelse(as.numeric(gsub("\\(([^()]*)%\\)|.", "\\1", x = out[, 2], perl = TRUE)) > 0,
      #                                           "red",
      #                                           "black")) %>%
      # kableExtra::column_spec(4, color = ifelse(as.numeric(gsub("\\(([^()]*)%\\)|.", "\\1", x = out[, 3], perl = TRUE)) > 0,
      #                                           "red",
      #                                           "black")) %>%
      kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
      kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
  }
}
```

\newpage

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("# Suivi des visites à l'hôpital\n\n"))
} else {
  cat(paste0("# Hospital follow-up\n\n"))
}
```

```{r, results='asis', fig.height = figsize}
if (Sys.getenv('TIMCI_COUNTRY') == 'Senegal') {
  cat(paste0("## Visite à l'hôpital\n\n"))
} else {
  cat(paste0("## Hospital visit\n\n"))
}

if (!is.null(raw_hospit_data)) {
  if (nrow(raw_hospit_data) > 0) {
    p <- timci::generate_week_bar_plot(date_vec = raw_hospit_data$date,
                                       date_min = as.Date(start_date),
                                       date_max = as.Date(Sys.Date() + 7),
                                       ylbl = submission_str)
    plot(p)
  } else{
    cat('0 hospital submissions since the start of the study.\n\n')
  }
} else{
  cat('0 hospital submissions since the start of the study.\n\n')
}
```

```{r, results='asis'}
cat(calendar_heatmap_title_str)

if (!is.null(raw_hospit_data)) {
  if (nrow(raw_hospit_data) > 0) {
    timci::generate_calendar_heatmap2(raw_hospit_data,
                                      date,
                                      legendtitle = "Number of hospital submissions")
  } else{
    cat('N/A\n\n')
  }
} else{
    cat('N/A\n\n')
  }
```

```{r hospit-stat-summary, results = "asis"}
if (!is.null(raw_hospit_data)) {
  if (nrow(raw_hospit_data) > 0) {
    
    all <- timci::format_hospital_data(raw_hospit_data)
    all$hospit[is.na(all$hospit)] <- 0
    
    hospit_summary <- list(
      "summary" = list(
        "Found" = ~qwraps2::n_perc(found == 1, prec),
        "Hospitalisation" = ~qwraps2::n_perc(hospit == 1, prec)
        )
      )
    out <- format_summary_table(all, hospit_summary) 
    out %>% 
      kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
      kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
      kableExtra::row_spec(0, bold = TRUE)
  }
}
```

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  cat("\\newpage")
  cat('# Day 28 follow-up\n\n')
  n_day28fu_rate <- round(100 * n_completed_day28fu/n_due_day28fu, prec)
  cat(paste0("The valid Day 28 follow-up period is **", day28_wmin, "** to **", day28_wmax, "** days.\n\n"))
  if (n_due_day28fu > 0) {
    cat(paste0("**", n_due_day28fu, "** participants should have completed their Day 28 follow-up.\n\n"))
    cat(paste0("**", n_completed_day28fu, "** participants (", n_day28fu_rate, "%) completed their Day 28 follow-up."))
  }
}
```

```{r, results = "asis"}
if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  if (!is.null(raw_day28fu_data)) {
    if (nrow(raw_day28fu_data) > 0) {
      day28fu_data <- timci::format_day28_data(raw_day28fu_data)[[1]]
      day28fu_data <- day28fu_data %>%
        dplyr::mutate(days = as.Date(date_call) - as.Date(date_day0), na.rm = TRUE)
      
      all <- data.frame(day28fu_data)
      all$a1_contact_a4_d_1b[is.na(all$cg_ok)] <- 0
      all$o1_o1_1a[is.na(all$status_day28)] <- 0
      all$o1_o1_1[is.na(all$cure_day28)] <- 0
      all$n1_o3_1[is.na(all$hf_visit_day28)] <- 0
      
      day28_call_ss <- list(
        "District" = list(
          "Successful call" = ~qwraps2::n_perc(cg_reached == 1, prec),
          "Valid time window" = ~qwraps2::n_perc(cg_reached == 1 & (days >= day28_wmin) & (days <= day28_wmax), prec)
          )
      )
      out <- format_summary_table(all, day28_call_ss, district)
      out %>% 
        kableExtra::kbl(booktabs = TRUE, linesep = "") %>% 
        kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header"), font_size = table_fs) %>%
        kableExtra::row_spec(0, bold = TRUE) %>%
        kableExtra::row_spec(1, color = total_row_ft2, background = total_row_bg2, bold = TRUE) %>%
        kableExtra::row_spec(1:(nrow(out)/2) * 2, background = striped_row_bg)
    }
  }
}
```

```{r, results='asis', fig.height = figsize}
if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  cat("## Weekly calls\n\n")
  if (!is.null(raw_day28fu_data)) {
    if(length(raw_day28fu_data) > 0 & nrow(raw_day28fu_data) > 0){
      p <- timci::generate_week_bar_plot(date_vec = raw_day28fu_data$date,
                                         date_min = as.Date(start_date),
                                         date_max = as.Date(Sys.Date() + 7),
                                         ylbl = paste0(enrolment_str))
      plot(p)
    }
  }
}
```

```{r, results='asis', fig.height = figsize}
if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  cat('## Number of submissions during the last 30 days\n\n')
  if (!is.null(raw_day28fu_data)) {
    if (nrow(raw_day28fu_data) > 0) {
      plot(timci::generate_day_bar_plot(raw_day28fu_data$date,
                                        as.Date(Sys.Date() - w),
                                        as.Date(Sys.Date() + 1),
                                        ylbl = submission_str,
                                        date_vec_ref = as.Date(as.Date(baseline_data$date_visit) + 28)))
    } else {
      cat('0 submissions since the start of the study.\n\n')
    }
  } else{
    cat('0 submissions since the start of the study.\n\n')
  }
}
```

```{r, results='asis'}
if (Sys.getenv('TIMCI_COUNTRY') == "Tanzania" || Sys.getenv('TIMCI_COUNTRY') == "India") {
  cat("## Calendar heatmap\n\n")
  if (!is.null(raw_day28fu_data)) {
    if (nrow(raw_day28fu_data) > 0) {
      timci::generate_calendar_heatmap2(raw_day28fu_data,
                                        date,
                                        legendtitle = "Number of day 28 follow-up phone calls")
    } else{
      cat('N/A\n\n')
    }
  } else{
    cat('N/A\n\n')
  }
}
```

\newpage

```{r appendix-title, results = "asis"}
cat(appendix_title)
```

```{r, results="asis"}
out <- lapply(1:nrow(facilities), function(i) {
  knitr::knit_child(
    'rct_monitoring_report_facility_sub.Rmd', envir = environment(), quiet = TRUE
  )
})
cat(unlist(out), sep = '\n')
```

\newpage
\listoftables

\newpage
\listoffigures

\newpage

```{r, results='asis', echo=FALSE}
cat(tech_info_str)
df_session <- devtools::session_info(include_base = TRUE)
```

```{r, results='asis', echo=FALSE}
df_session_platform <- df_session$platform %>% 
  unlist(.) %>% 
  as.data.frame(.) %>% 
  tibble::rownames_to_column(.)
colnames(df_session_platform) <- c("Setting", "Value")
kableExtra::kbl(df_session_platform, 
                booktabs = TRUE, 
                align = c("l", "c")) %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header", "striped"),
                            font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE)
```

```{r, results='asis', echo=FALSE}
df_session_packages <- df_session$packages[c("loadedversion", "date", "source")]
colnames(df_session_packages) <- c("Loaded version", "Date", "Source")
df_session_packages %>% kableExtra::kbl(booktabs = TRUE,
                                        linesep = "",
                                        longtable = TRUE,
                                        align = "c") %>% 
  kableExtra::kable_styling(latex_options = c("HOLD_position", "repeat_header", "striped"),
                            font_size = table_fs) %>%
  kableExtra::row_spec(0, bold = TRUE)
```
