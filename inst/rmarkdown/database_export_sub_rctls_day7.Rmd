```{r}
write("Export Day 7 data and run corresponding quality checks", stderr())
```

\newpage

## Day 7 data quality checks\n\n

```{r}
allday7fu_data <- NULL
day7fu_data <- NULL

locked_day7fu_data <- NULL
locked_allday7fu_data <- NULL
```

```{r format-RCT-LS-ODK-fu-day7-data}
db_name <- "Day 7 follow-up"
out <- timci::format_day7_data(raw_day7fu_data)
day7fu_data <- out[[1]]
allday7fu_data <- out[[3]]
```

There are **`r nrow(allday7fu_data)`** records in the raw `r db_name` database, among which **`r nrow(day7fu_data)`** records documenting successful follow-ups.

### Non-valid participant IDs [compliance check `r qc_nonvalid_day7fu`]\n\n

```{r}
write(" o Non-valid participant IDs [Day 7 data quality checks]", stderr())
```

**Rule:** keep only IDs of children who are enrolled in the locked Day 0 database (note: if data collection is still active, all participants enrolled after the date set for the lock will be considered as 'invalid' IDs).

```{r, eval=timci::is_not_empty(raw_day7fu_data)}
# All follow-ups
locked_allday7fu_data <- allday7fu_data[allday7fu_data$child_id %in% locked_day0_data$child_id, ]
allday7fu_data_uids <- allday7fu_data[!allday7fu_data$child_id %in% locked_day0_data$child_id, ]
# Successful follow-ups
locked_day7fu_data <- day7fu_data[day7fu_data$child_id %in% locked_day0_data$child_id, ]
day7fu_data_uids <- day7fu_data[!day7fu_data$child_id %in% locked_day0_data$child_id, ]
locked_day7fu_data <- locked_day7fu_data %>%
  dplyr::mutate(window = ifelse(days >= 7 & days <= 10, 1, 0))
```

* **`r if ( !is.null(allday7fu_data_uids) ) { nrow(allday7fu_data_uids) } else {'NA'}`** records with non-valid participant IDs detected and removed in the locked `r db_name` database.

* **`r if ( !is.null(day7fu_data_uids) ) { nrow(day7fu_data_uids) } else {'NA'}`** records with non-valid participant IDs detected and removed in the locked successful `r db_name` database.

```{r, results = 'asis'}
timci::quality_check_export(allday7fu_data_uids[c("child_id", "uuid")],
                            qc_nonvalid_day7fu,
                            "nonvalid_ids_day7fu",
                            qc_dir,
                            "the child ID does not correspond to any ID found the locked Day 0 database")
```

```{r}
# Replace Day 7 data by locked Day 7 data so that non-valid device IDs/facilities do not appear in the export
day7fu_data <- locked_day7fu_data
```

### Duplicate management\n\n

#### Successful follow-up duplicates [compliance check `r qc_duplicated_day7fu`]\n\n

```{r}
write(" o Successful follow-up duplicates [Day 7 data quality checks]", stderr())
```

`r if (is_kenya) {'##### Initial check'}`

```{r, eval=!is.null(locked_day7fu_data)&is_kenya, results='asis'}
qc_description <- "To be updated later"
qc_rule <- "Keep duplicated records if they correspond to different follow-ups."
qc_type <- "duplicates"
df <- locked_day7fu_data
col_id <- "child_id"
col_date <- "start"
qc_text <- "duplicated IDs"
qc_idx <- qc_duplicated_day7fu
qc_export_label <- "duplicated_successful_day7fu"
qc_export_description <- "Day 7 follow-ups are duplicated"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
```

`r if (is_kenya) {'##### Child ID duplicate manual edits'}`

```{r, results='asis', eval=is_kenya}
out <- timci::correct_day7_duplicates(locked_day7fu_data)
locked_day7fu_data <- out[[1]]
duplicate_edits <- out[[2]]
if (!is.null(duplicate_edits)) {
  duplicate_edits %>%
    select(old_child_id, uuid, new_child_id) %>%
    knitr::kable()
}
```

`r if (is_kenya) {'##### Second check after manual edits'}`

```{r, eval=!is.null(locked_day7fu_data), results='asis'}
qc_description <- "To be updated later"
qc_rule <- "Only the most recent successful Day 7 follow-up is kept."
qc_type <- "duplicates"
df <- locked_day7fu_data
col_id <- "child_id"
col_date <- "start"
qc_text <- "duplicated IDs"
qc_idx <- qc_duplicated_day7fu
qc_export_label <- "duplicated_successful_day7fu"
qc_export_description <- "Day 7 follow-ups are duplicated"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
```

```{r, results = 'asis', eval=FALSE}
if (!is.null(locked_day7fu_data)) {
  cat(paste0("**", nrow(day7fu_data_duplicates) - nrow(processed_day7fu_data_duplicates), "** records were removed in the locked successful Day 7 follow-up database. Note that records duplicated on the same day are kept - we need to define a rule for this."))
}
```

### Day 7 follow-up anterior to enrolment date [consistency check]\n\n

To be implemented

### Data cleaning summary\n\n

```{r}
write(" o Data cleaning summary", stderr())
```

```{r, results = 'asis'}
if (!is.null(allday7fu_data)) {
  if (nrow(allday7fu_data) > 0) {
    timci::format_nrow("There are", locked_allday7fu_data, "record(s) in the locked Day 7 follow-up database.")
  }
}
```

```{r, results = 'asis'}
if (!is.null(day7fu_data)) {
  if (nrow(day7fu_data) > 0) {
    timci::format_nrow("There are", locked_day7fu_data, "record(s) in the locked successful Day 7 follow-up database.")
  }
}
```

```{r day7-lost-to-followup}
ltfu <- NULL
if (!is.null(day7fu_data)) {
  ltfu <- timci::generate_ltfu_log(df = day0_data,
                                   fudf = allday7fu_data,
                                   end_date = 12,
                                   raw = FALSE)
}
```

```{r locked-day7-lost-to-followup}
locked_ltfu <- NULL
if (!is.null(locked_allday7fu_data)) {
  if (nrow(locked_allday7fu_data)>0) {
    locked_ltfu <- timci::generate_ltfu_log(df = locked_day0_data,
                                            fudf = locked_allday7fu_data,
                                            end_date = 12,
                                            raw = FALSE)
  }
}
```

```{r}
timci::create_day7fu_qc_flowchart(nrow(allday7fu_data),
                                  nrow(locked_allday7fu_data),
                                  'NA',
                                  'NA',
                                  'NA',
                                  'NA',
                                  'NA')
```

### Data export\n\n

```{r}
write(" o Export Day 7 data", stderr())
```

```{r, results = 'asis'}
timci::dataset_export(allday7fu_data,
                      "04a",
                      "timci_followup_day7_data",
                      rctls_dir,
                      "Raw Day 7 follow-up data")
```

```{r, results = 'asis'}
timci::dataset_export(day7fu_data,
                      "04b",
                      "timci_followup_successful_day7_data",
                      rctls_dir,
                      "Raw successful Day 7 follow-up only)")
```

```{r, results = 'asis'}
timci::dataset_export(locked_allday7fu_data,
                      "04a",
                      "timci_followup_day7_data",
                      locked_db_dir,
                      "Cleaned Day 7 follow-up data")
```

```{r, results = 'asis'}
timci::dataset_export(locked_day7fu_data,
                      "04b",
                      "timci_followup_successful_day7_data",
                      locked_db_dir,
                      "Cleaned successful Day 7 follow-up data")
```

```{r}
if (!is.null(ltfu)) {
  fn <- timci::export_df2xlsx(ltfu,
                              rctls_dir,
                              "04c_day7_lost_to_followup")
}
```

```{r}
if (!is.null(locked_ltfu)) {
  fn <- timci::export_df2xlsx(locked_ltfu,
                              locked_db_dir,
                              "04c_day7_lost_to_followup")
}
```

```{r}
# if (!is.null(pii) & !is.null(raw_day7fu_data)) {
#   fu7all <- timci::generate_fu_log(pii,
#                                    raw_day7fu_data,
#                                    0,
#                                    12,
#                                    7,
#                                    10,
#                                    ext = TRUE,
#                                    deidentify = TRUE)
#   fn <- timci::export_df2xlsx(fu7all,
#                               params$rctls_dir,
#                               "04d_timci_deidentified_day7_fu_weekly_log_all")
# }
```
