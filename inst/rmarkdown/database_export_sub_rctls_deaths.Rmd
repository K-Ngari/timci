```{r death-export-subsection-verbose}
write("Export death data for monitoring", stderr())
```

\newpage

## Death data

### Export death data reported at Day 7

```{r, eval=is_tanzania}
day7_deaths <- allday7fu_data %>%
  filter(status_day7 == 3 | fu_type == 3)
if (nrow(day7_deaths) > 0) {
  day7_deaths <- pivot_duplicates_to_columns(day7_deaths)
}

locked_day7fu_deaths <- locked_allday7fu_data %>%
  filter(status_day7 == 3 | fu_type == 3)
if (nrow(locked_day7fu_deaths) > 0) {
  locked_day7fu_deaths <- timci::pivot_duplicates_to_columns(locked_day7fu_deaths)
}
```

```{r, eval=!is_tanzania}
day7_deaths <- allday7fu_data %>%
  filter(status_day7 == 3)
if (nrow(day7_deaths) > 0) {
  day7_deaths <- pivot_duplicates_to_columns(day7_deaths)
}
locked_day7fu_deaths <- locked_allday7fu_data %>%
  filter(status_day7 == 3)
if (nrow(locked_day7fu_deaths) > 0) {
  locked_day7fu_deaths <- timci::pivot_duplicates_to_columns(locked_day7fu_deaths)
}
```

```{r, results = 'asis'}
timci::dataset_export(day7_deaths,
                      "14",
                      "timci_day27_death_data",
                      rctls_dir,
                      "Raw Day 7 death data")
```

```{r, results = 'asis'}
timci::dataset_export(locked_day7fu_deaths,
                      "14",
                      "timci_day7_death_data",
                      locked_db_dir,
                      "Cleaned Day 7 death data")
```

### Export death data reported at Day 28

```{r, eval=is_rct}
day28_deaths <- allday28fu_data %>%
  dplyr::filter(status_day28 == 3)
if (nrow(day28_deaths) > 0) {
  day28_deaths <- pivot_duplicates_to_columns(day28_deaths)
}
locked_day28fu_deaths <- locked_allday28fu_data %>%
  dplyr::filter(status_day28 == 3)
if (nrow(locked_day28fu_deaths) > 0) {
  locked_day28fu_deaths <- pivot_duplicates_to_columns(locked_day28fu_deaths)
}
```

```{r, results = 'asis'}
timci::dataset_export(day28_deaths,
                      "15",
                      "timci_day28_death_data",
                      rctls_dir,
                      "Raw Day 28 death data")
```

```{r, results = 'asis'}
timci::dataset_export(locked_day28fu_deaths,
                      "15",
                      "timci_day28_death_data",
                      locked_db_dir,
                      "Cleaned Day 28 death data")
```

### Combined death data

```{r, eval=is_rct}
all_deaths <- day7_deaths %>%
  merge(day28_deaths,
        by = 'child_id',
        all = TRUE) %>%
  merge(day0_data,
        by = 'child_id',
        all.x = TRUE) %>%
  merge(hospit_data,
        by = 'child_id',
        all.x = TRUE)
```

```{r, eval=is_rct}
locked_all_deaths <- locked_day7fu_deaths %>%
  merge(locked_day28fu_deaths,
        by = 'child_id',
        all = TRUE) %>%
  merge(locked_day0_data,
        by = 'child_id',
        all.x = TRUE)
```

```{r, results = 'asis'}
timci::dataset_export(all_deaths,
                      "16",
                      "timci_all_death_data",
                      rctls_dir,
                      "Raw all death data")
```

```{r, results = 'asis'}
timci::dataset_export(locked_all_deaths,
                      "16",
                      "timci_all_death_data",
                      locked_db_dir,
                      "Cleaned all death data")
```
