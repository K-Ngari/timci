---
title: "TIMCI Day 28 follow-up log"
author: "`r Sys.getenv('TIMCI_INSTITUTION')`"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
params:
  output_dir: "."
  facility_data: NULL
output:
  html_document: default
  word_document:
    reference_docx: word_styles2.docx
---

```{r setup-rmd, include=FALSE}
library(qrcode)
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r load-Day28-fu-environment-variables}
crf_day28_fid <- Sys.getenv("TIMCI_CRF_DAY28_FID")
wd_fid <- Sys.getenv("TIMCI_WD_FID")
form_list <- ruODK::form_list()$fid
```

```{r}

# Create `odk_external_files` folder if it does not exist
dir.create(file.path(params$output_dir, "odk_external_files"), showWarnings = FALSE)

# Load contact information
pii <- timci::extract_enrolled_participants(params$facility_data)[[2]]

raw_day28fu_data <- NULL
if (crf_day28_fid %in% form_list) {
  raw_day28fu_data <- ruODK::odata_submission_get(fid = crf_day28_fid)
}
```

```{r}
day28fu <- NULL
if (!is.null(raw_day28fu_data)) {
  if (nrow(raw_day28fu_data) > 0) {
    day28fu <- timci::generate_fu_log(pii, raw_day28fu_data, 28, 32)
    day28lost <- timci::generate_fu_log(pii, raw_day28fu_data, 33, 2000)
    tmp <- timci::export_df2xlsx(day28lost, params$output_dir, "day28_lost_to_followup")
  }
}
```

```{r}
dir.create(file.path(params$output_dir, "odk_external_files"), showWarnings = FALSE)
csv28_fname <- file.path(params$output_dir, "odk_external_files", "day28fu.csv")
write.csv(day28fu, csv28_fname, row.names = FALSE, quote = FALSE)
```

```{r}
if (!is.null(day28fu)) {
  for (i in 1:nrow(day28fu)) {
    pid <- toString(day28fu[i,'name'])
    png_file <- file.path(tempdir(), paste0(pid,".png"))
    png(png_file)
    qrcode_gen(pid)
    dev.off()
    }
  
  df <- day28fu %>%
    dplyr::mutate(
      code = paste0('![](', file.path(tempdir(), paste0(day28fu$name,".png")), ')', '{width=0.75in}')
      ) %>%
    dplyr::select('code', dplyr::everything()) %>%
    dplyr::rename('id' = 'name',
                  'child' = 'label',
                  'date' = 'enroldate',
                  'contact' = 'phonenb')
  
  df$caregiver <- paste(df$caregiver,
                        paste0('(',df$relationship,')'))
  df$child <- paste(df$child,
                    paste0('(',df$sex,')'))
  df$contact <- paste(df$contact,
                    paste0('(',df$location,')'))
  drops <- c("mother", "relationship", "sex", "location")
  df <- df[ , !(names(df) %in% drops)]
  df %>% knitr::kable()
}
```

# Upload list of participants on the ODK Central server

```{r}
current_version <- "N/A"
if (crf_day28_fid %in% form_list) {
  # Get form details
  cform <- ruODK::form_detail(
    pid = ruODK::get_default_pid(),
    fid = crf_day28_fid,
    url = ruODK::get_default_url(),
    un = ruODK::get_default_un(),
    pw = ruODK::get_default_pw(),
  )
  current_version <- as.numeric(cform$version)
}
```

```{r}
form_url <- "NULL"
draft_response <- NULL
csv_upload_response <- NULL
new_version <- "N/A"
publication_response <- NULL
if (crf_day28_fid %in% form_list) {
  form_url <- paste0(ruODK::get_default_url(), "/v1/projects/", ruODK::get_default_pid(), "/forms/", crf_day28_fid)
  # Create a draft form
  draft_response <- timci::create_odkc_draft_form(ruODK::get_default_un(), ruODK::get_default_pw(), form_url)
  # Upload the new CSV created as a form attachment
  csv_upload_response <- timci::upload_odkc_csv_attachment(ruODK::get_default_un(), ruODK::get_default_pw(), form_url, csv28_fname)
  # Publish a draft form
  new_version <- as.character(current_version + 0.000001)
  publication_response <- timci::publish_odkc_draft_form(ruODK::get_default_un(), ruODK::get_default_pw(), form_url, new_version)
}
```

**`r form_url`**

* Initial version of the form: **`r current_version`**

* Create a new draft of the form: **`r draft_response$success`**

* Upload the CSV containing the current follow-up log as an attachment to the draft: **`r csv_upload_response$success`**

* Publish the updated form with version number **`r new_version`**: **`r publication_response$success`**
