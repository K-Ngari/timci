```{r}
write("Export hospital/hospitalisation data and run corresponding quality checks", stderr())
```

\newpage

## Hospitalisation data quality checks

```{r format-RCT-LS-ODK-fu-hospit-data}
hospit_data <- timci::format_hospital_data(raw_hospit_data)
db_name <- "hospitalisation follow-up"
```

There are **`r if ( !is.null(hospit_data) ) { nrow(hospit_data) } else { 'NA' }`** record(s) in the raw `r db_name` database.

```{r}
hospit_data_uids <- NULL
locked_hospit_data <- NULL
hospit_fu <- NULL
```

### Non-valid participant IDs

```{r, eval=!is.null(hospit_data), results='asis'}
qc_description <- "To be updated later"
qc_rule <- "Keep only IDs of participant who are found in the locked Day 0 database."
qc_type <- "nonvalid_pids_fu"
df <- hospit_data
refdf <- locked_day0_data
qc_text <- "non-valid participant IDs"
qc_idx <- qc_nonvalid_hospitfu
qc_export_label <- "nonvalid_pids_hospitfu"
qc_export_description <- "the child ID does not correspond to any ID found the locked Day 0 database"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
```

```{r, eval=!is.null(cleaned_df)}
n_nonvalid_pids_hospitfu <- n_detected
locked_hospit_data <- cleaned_df
```

### Duplicate management

```{r, eval=!is.null(hospit_data), results='asis'}
qc_description <- "To be updated later"
qc_rule <- "Keep duplicated records if they correspond to different hospitalisations."
qc_type <- "duplicates"
df <- locked_hospit_data
date_col <- "start"
qc_text <- "duplicated IDs"
qc_idx <- qc_duplicated_hospitfu
qc_export_label <- "duplicated_hospitfu"
qc_export_description <- "hospitalisation follow-ups are duplicated"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
```

### Lost-to-follow-up

```{r, eval=!is.null(pii)}
hospit_fu <- timci::generate_hospital_log(pii = pii,
                                          fu7df = raw_day7fu_data,
                                          day0df = day0_data,
                                          hospitdf = raw_hospit_data,
                                          deidentify = TRUE)
```

### Data cleaning summary

```{r}
timci::create_day7fu_qc_flowchart(nrow(hospit_data),
                                  n_nonvalid_pids_hospitfu,
                                  nrow(locked_hospit_data),
                                  'NA',
                                  'NA',
                                  'NA',
                                  'NA')
```

### Data export

```{r export-RCT-LS-ODK-fu-hospit-data, results = 'asis'}
timci::dataset_export(hospit_data,
                      "05a",
                      "timci_followup_hospit_data",
                      rctls_dir,
                      "Raw hospitalisation data")
```

```{r, results = 'asis'}
timci::dataset_export(locked_hospit_data,
                      "05a",
                      "timci_followup_hospit_data",
                      locked_db_dir,
                      "Cleaned hospitalisation data")
```

```{r, results = 'asis'}
timci::dataset_export(hospit_fu,
                      "05c",
                      "timci_deidentified_hospit_fu_log_all",
                      rctls_dir,
                      "Hospitalisation log data")
```
