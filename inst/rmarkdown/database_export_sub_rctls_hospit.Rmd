## Hospitalisation data quality checks\n\n

```{r}
write("Export hospital/hospitalisation data and run corresponding quality checks", stderr())
```

```{r format-RCT-LS-ODK-fu-hospit-data}
hospit_data <- timci::format_hospital_data(raw_hospit_data)
db_name <- "hospitalisation follow-up"
```

There are **`r if ( !is.null(hospit_data) ) { nrow(hospit_data) } else { 'NA' }`** record(s) in the raw `r db_name` database.

```{r}
hospit_data_uids <- NULL
locked_hospit_data <- NULL
hospit_fu <- NULL
```

### Non-valid participant IDs [compliance check `r qc_nonvalid_hospitfu`]\n\n

```{r, eval=!is.null(hospit_data), results='asis'}
qc_description <- "To be updated later"
qc_rule <- "Keep only IDs of participant who are found in the locked Day 0 database."
qc_type <- "nonvalid_ids"
df <- hospit_data
idcol1 <- "child_id"
refdf <- day0_data
idcol2 <- "child_id"
qc_text <- "non-valid participant IDs"
qc_idx <- qc_nonvalid_hospitfu
qc_export_label <- "nonvalid_pids_hospitfu"
qc_export_description <- "the child ID does not correspond to any ID found the locked Day 0 database"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_nonvalid_pids_hospitfu <- n_detected
```

```{r, eval=!is.null(cleaned_df)}
locked_hospit_data <- cleaned_df
```

### Duplicate management [compliance check `r qc_duplicated_hospitfu`]\n\n

```{r, eval=!is.null(locked_hospit_data), results='asis'}
qc_description <- "To be updated later"
qc_rule <- "Keep duplicated records only if they correspond to different hospitalisations."
qc_type <- "duplicates"
df <- locked_hospit_data %>% filter(found == 1)
col_id <- "child_id"
col_date <- "start"
qc_text <- "duplicated IDs"
qc_idx <- qc_duplicated_hospitfu
qc_export_label <- "duplicated_hospitfu"
qc_export_description <- "hospitalisation follow-ups are duplicated"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_duplicates_hospitfu <- n_detected
```

### Date [context check `r qc_duplicated_hospitfu`]\n\n

To be updated

### Lost-to-follow-up\n\n

```{r, eval=!is.null(raw_pii)}
hospit_fu <- timci::generate_hospital_log(pii = raw_pii,
                                          fu7df = raw_day7fu_data,
                                          day0df = day0_data,
                                          hospitdf = raw_hospit_data,
                                          deidentify = TRUE)
```

### Data cleaning summary\n\n

```{r}
timci::create_hospit_qc_flowchart(nrow(hospit_data),
                                  n_nonvalid_pids_hospitfu,
                                  n_duplicates_hospitfu,
                                  nrow(locked_hospit_data))
```

### Data export\n\n

```{r export-RCT-LS-ODK-fu-hospit-data, results = 'asis'}
timci::dataset_export(hospit_data,
                      "05a",
                      "timci_followup_hospit_data",
                      rctls_dir,
                      "Raw hospitalisation data")
```

```{r, results = 'asis'}
timci::dataset_export(locked_hospit_data,
                      "05a",
                      "timci_followup_hospit_data",
                      locked_db_dir,
                      "Cleaned hospitalisation data")
```

```{r, results = 'asis'}
timci::dataset_export(hospit_fu,
                      "05c",
                      "timci_deidentified_hospit_fu_log_all",
                      rctls_dir,
                      "Hospitalisation log data")
```
