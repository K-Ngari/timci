---
title: "TIMCI Data Quality and Export Report"
author: "`r Sys.getenv('TIMCI_INSTITUTION')`"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
params:
  rctls_dir: tempdir()
  participant_zip: tempdir()
  spa_dir: tempdir()
  qual_dir: tempdir()
output:
  html_document: default
  word_document:
    reference_docx: word_styles1.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r ruODK-setup, echo=FALSE}
ruODK::ru_setup(
  svc = Sys.getenv("ODKC_SVC"),
  un = Sys.getenv("ODKC_UN"),
  pw = Sys.getenv("ODKC_PW"),
  tz = Sys.getenv("TZ"),
  verbose = FALSE # Can be switched to TRUE for demo or debugging
)
```

```{r load-RCT-LS-ODK-facility-data, echo=FALSE}
raw_facility_data <- ruODK::odata_submission_get(fid = "01-TIMCI-CRF-Facility")
facility_data <- timci::process_facility_data(raw_facility_data)
start_date <- min(facility_data$date_visit)
end_date <- max(facility_data$date_visit)
```

This report covers the period from **`r start_date`** to **`r end_date`**.

# 1. Pragmatic cluster Randomised Controlled Trial (RCT) / Observational Longitudinal Study (LS)

## 1.1. Facility data

```{r, echo=FALSE}
screening_data <- timci::extract_screening_data(facility_data)
timci::export_df2xlsx(screening_data, params$rctls_dir, "01_timci_screening_data")
```

```{r, echo=FALSE}
res <- timci::extract_enrolled_participants(facility_data)

day0_data <- res[[1]]
n_enrolled <- nrow(day0_data)
deidentified_day0_data <- timci::deidentify_data(day0_data)
timci::export_df2xlsx(deidentified_day0_data, params$rctls_dir, "02_timci_day0_data")

pii <- res[[2]]
xlsx_fname <- timci::export_df2xlsx(pii, tempdir(), "timci_contact_data")
pii_pwd <- Sys.getenv("TIMCI_PII_PW")
zip(params$participant_zip, 
    files = xlsx_fname, 
    flags = paste("-r9Xj --password", pii_pwd))

```

```{r, echo=FALSE, results = "asis"}
study_data <- extract_all_visits(facility_data)
deidentified_facility_data <- timci::deidentify_data(study_data)
tmp <- timci::export_df2xlsx(deidentified_facility_data, params$rctls_dir, "03_timci_facility_visits_data")
```

## 1.2. Day 7 follow-up data

```{r load-RCT-LS-ODK-fu-day7-data, echo=FALSE}
raw_day7fu_data <- ruODK::odata_submission_get(fid = "01c-TIMCI-CRF-Day7")
day7fu_data <- format_odk_metadata(raw_day7fu_data)
```

## 1.3. Hospitalisation follow-up data

```{r load-RCT-LS-ODK-fu-hospit-data, echo=FALSE}
raw_hospit_data <- ruODK::odata_submission_get(fid = "01b-TIMCI-CRF-Hospital")
hospit_data <- process_hospital_data(raw_hospit_data)
```

## 1.3. Day 28 follow-up data

```{r load-RCT-LS-ODK-fu-day28-data, echo=FALSE}
raw_day28fu_data <- ruODK::odata_submission_get(fid = "01d-TIMCI-CRF-Day28")
day28fu_data <- format_odk_metadata(raw_day28fu_data)
```

## 1.4. Withdrawal data

```{r load-RCT-LS-ODK-withdrawal, echo=FALSE}
raw_withdrawal_data <- ruODK::odata_submission_get(fid = "99-TIMCI-withdrawal")
withdrawal_data <- format_odk_metadata(raw_withdrawal_data)
```

```{r, echo=FALSE}
tmp <- timci::export_df2xlsx(day7fu_data, params$rctls_dir, "04_timci_followup_day7_data")
tmp <- timci::export_df2xlsx(hospit_data, params$rctls_dir, "05_timci_followup_hospit_data")
tmp <- timci::export_df2xlsx(day28fu_data, params$rctls_dir, "06_timci_followup_day28_data")
```

# 2. Service Provision Assessment (SPA)

```{r, echo=FALSE}
raw_spa_cgei_data <- ruODK::odata_submission_get(pid = 2, fid = "02-TIMCI-SPA-CGEI")
spa_cgei_data <- format_odk_metadata(raw_spa_cgei_data)

raw_spa_fa_data <- ruODK::odata_submission_get(pid = 2, fid = "03-TIMCI-SPA-Fassmt")
spa_fa_data <- format_odk_metadata(raw_spa_fa_data)

raw_spa_hcpi_data <- ruODK::odata_submission_get(pid = 2, fid = "04-TIMCI-SPA-HCPi")
spa_hcpi_data <- format_odk_metadata(raw_spa_hcpi_data)

raw_spa_sco_data <- ruODK::odata_submission_get(pid = 2, fid = "05-TIMCI-SPA-SCO")
spa_sco_data <- format_odk_metadata(raw_spa_sco_data)
```

```{r, echo=FALSE}
timci::export_df2xlsx(spa_cgei_data, params$spa_dir, "03_timci_spa_exit_interview_data")
timci::export_df2xlsx(spa_fa_data, params$spa_dir, "01_timci_spa_facility_assessment_data")
timci::export_df2xlsx(spa_hcpi_data, params$spa_dir, "02_timci_spa_provider_interview_data")
timci::export_df2xlsx(spa_sco_data, params$spa_dir, "04_timci_spa_consultation_obs_data")
```

# 3. Qualitative studies

```{r, echo=FALSE}
raw_cgidi_invitation_data <- ruODK::odata_submission_get(pid = 12, fid = "08a-TIMCI-cg-idi-invitation")
cgidi_invitation_data <- format_odk_metadata(raw_cgidi_invitation_data)
timci::export_df2xlsx(cgidi_invitation_data, params$qual_dir, "01_timci_cg_invitation_data")

raw_cgidi_encryption_data <- ruODK::odata_submission_get(pid = 12, fid = "08b-TIMCI-cg-idi-encryption-list")
cgidi_encryption_data <- format_odk_metadata(raw_cgidi_encryption_data)
timci::export_df2xlsx(cgidi_encryption_data, params$qual_dir, "02_timci_cg_encryption_data")

raw_cgidi_interview_zip <- ruODK::submission_export(pid = 12, fid = "08c-TIMCI-cg-idi-interview")
cgidi_interview_data <- timci::extract_data_from_odk_zip(raw_cgidi_interview_zip, "08c-TIMCI-cg-idi-interview.csv")
timci::export_df2xlsx(cgidi_interview_data, params$qual_dir, "03_timci_cg_interview_data")

sl <- ruODK::submission_list(pid = 12, fid = "08c-TIMCI-cg-idi-interview")
print(sl)
```

```{r, echo=FALSE}
for (i in length(sl$instance_id)) {
  al <- ruODK::get_one_submission_attachment_list(sl$instance_id[[i]])
  test <- ruODK::get_one_submission(sl$instance_id[[i]])
  print(test)
  dir.create(file.path(params$qual_dir, sl$instance_id[[i]]), showWarnings = FALSE)
}
```


