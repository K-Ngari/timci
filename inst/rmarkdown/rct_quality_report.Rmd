---
title: "TIMCI Data Quality and Export Report"
author: "`r Sys.getenv('INSTITUTION')`"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
params:
  main_output_dir: tempdir()
  spa_output_dir: tempdir
output:
  html_document: default
  word_document:
    reference_docx: word_styles1.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Pragmatic cluster Randomised Controlled Trial (RCT) / Observational Longitudinal Study (LS)

```{r, echo=FALSE}
ruODK::ru_setup(
  svc = Sys.getenv("ODKC_SVC"),
  un = Sys.getenv("ODKC_UN"),
  pw = Sys.getenv("ODKC_PW"),
  tz = Sys.getenv("TZ"),
  verbose = FALSE # Can be switched to TRUE for demo or debugging
)
```

```{r, echo=FALSE}
raw_facility_data <- ruODK::odata_submission_get(fid = "01-TIMCI-CRF-Facility")
raw_day7fu_data <- ruODK::odata_submission_get(fid = "01c-TIMCI-CRF-Day7")
raw_hospit_data <- ruODK::odata_submission_get(fid = "01b-TIMCI-CRF-Hospital")
raw_day28fu_data <- ruODK::odata_submission_get(fid = "01d-TIMCI-CRF-Day28")
raw_withdrawal_data <- ruODK::odata_submission_get(fid = "99-TIMCI-withdrawal")
```

```{r, echo=FALSE}
facility_data <- timci::process_facility_data(raw_facility_data)
```

```{r, echo=FALSE}
start_date <- min(facility_data$date_visit)
end_date <- max(facility_data$date_visit)
```

This report covers the period from **`r start_date`** to **`r end_date`**.

## 1.2. Submissions

### 1.2.1. Number of submissions per day
```{r, echo=FALSE}
w <- 14
facility_submission_bar_plot <- timci::generate_day_bar_plot(facility_data$date_visit, as.Date(end_date) - w, as.Date(end_date))
plot(facility_submission_bar_plot)
```

### 1.2.2. Number of submissions per form
```{r, echo=FALSE, results = "asis"}
n_screened <- nrow(facility_data)
screening_data <- timci::extract_match_from_xls_dict(facility_data, "screening_dict.xlsx")
screening_fname <- file.path(params$main_output_dir, paste("timci_screening_data", "_", Sys.Date(), ".xlsx", sep = ""))
openxlsx::write.xlsx(screening_data, screening_fname, row.names = FALSE)

study_data <- timci::extract_enrolled_participants(facility_data)
pii <- timci::extract_pii(study_data)
n_enrolled <- nrow(study_data)

repeat_data <- extract_repeat_visits(facility_data)
n_repeat <- nrow(repeat_data)

n_day7fu <- nrow(raw_day7fu_data)
n_day28fu <- nrow(raw_day28fu_data)
n_hospit <- nrow(raw_hospit_data)

n_withdrawal <- nrow(raw_withdrawal_data)

n_all <- n_screened + n_day7fu + n_day28fu + n_hospit + n_withdrawal
visit_names <- c("Screening",
                 "Baseline visit",
                 "Repeat visit",
                 "Day 7 phone call",
                 "Day 28 phone call",
                 "Hospital visit",
                 "Withdrawal",
                 "All")
submissions <- c(n_screened, n_enrolled, n_repeat, n_day7fu, n_day28fu, n_hospit, n_withdrawal, n_all)
visits <- data.frame(visit_names, submissions) 
knitr::kable(visits, col.names = c("Visit", "N"))
```

## 1.3. Participants
```{r, echo=FALSE, results = "asis"}
options(qwraps2_markup = 'markdown')

all <- data.frame(facility_data)
all$sickness[is.na(all$sickness)] <- 0
all$inpatient[is.na(all$inpatient)] <- 0
all$consult_reason[is.na(all$consult_reason)] <- 0
all$prev_enrl[is.na(all$prev_enrl)] <- 0
all$repeat_consult[is.na(all$repeat_consult)] <- 0
all$consent[is.na(all$consent)] <- 0
all$yg_infant <- ifelse(all$yg_infant == 0, "2-59m", "0-2m")

summary_statistics <- list(
  "Age eligibility" = list(
    "0 - 59 months" = ~qwraps2::n_perc(age_incl == 1, 2),
    "First day of life" = ~qwraps2::n_perc(age_excl == 1, 2)
    ),
  "Visit eligibility" = list(
    "Sick child" = ~qwraps2::n_perc(sickness == 1, 2),
    "Inpatient admission" = ~qwraps2::n_perc(inpatient == 1, 2),
    "Trauma" = ~qwraps2::n_perc(consult_reason == 2, 2),
    "Immunisation" = ~qwraps2::n_perc(consult_reason == 3, 2),
    "Monitoring" = ~qwraps2::n_perc(consult_reason == 4, 2)
    ),
  "Multiple enrolments" = list(
    "Previous enrolment" = ~qwraps2::n_perc(prev_enrl == 1 | prev_enrl == 2, 2),
    "Last enrolment < 28 days" = ~qwraps2::n_perc(repeat_consult == 1, 2)
    ),
  "Consenting process outcome" = list(
    "Enrolled" = ~qwraps2::n_perc(consent == 1, 2)
    )
)
st <- qwraps2::summary_table(all, summary_statistics)
st1 <- qwraps2::summary_table(dplyr::group_by(all, yg_infant), summary_statistics)
print(cbind(st, st1))
```

```{r, echo=FALSE}
deidentified_facility_data <- timci::deidentify_data(study_data)
day0_data_fname <- file.path(params$main_output_dir, paste("timci_facility_day0_data", "_", Sys.Date(), ".xlsx", sep = ""))
openxlsx::write.xlsx(deidentified_facility_data, day0_data_fname, row.names = FALSE)

deidentified_repeat_data <- timci::deidentify_data(repeat_data)
repeat_data_fname <- file.path(params$main_output_dir, paste("timci_facility_repeat_data", "_", Sys.Date(), ".xlsx", sep = ""))
openxlsx::write.xlsx(deidentified_repeat_data, repeat_data_fname, row.names = FALSE)

day7fu_data_fname <- file.path(params$main_output_dir, paste("timci_followup_day7_data", "_", Sys.Date(), ".xlsx", sep = ""))
openxlsx::write.xlsx(raw_day7fu_data, day7fu_data_fname, row.names = FALSE)

hospit_data_fname <- file.path(params$main_output_dir, paste("timci_followup_hospit_data", "_", Sys.Date(), ".xlsx", sep = ""))
openxlsx::write.xlsx(raw_hospit_data, hospit_data_fname, row.names = FALSE)

day28fu_data_fname <- file.path(params$main_output_dir, paste("timci_followup_day28_data", "_", Sys.Date(), ".xlsx", sep = ""))
openxlsx::write.xlsx(raw_day28fu_data, day28fu_data_fname, row.names = FALSE)
```

# 2. Service Provision Assessment (SPA)

```{r, echo=FALSE}
raw_spa_cgei_data <- ruODK::odata_submission_get(pid = 2, fid = "02-TIMCI-SPA-CGEI")
raw_spa_fa_data <- ruODK::odata_submission_get(pid = 2, fid = "03-TIMCI-SPA-Fassmt")
raw_spa_hcpi_data <- ruODK::odata_submission_get(pid = 2, fid = "04-TIMCI-SPA-HCPi")
raw_spa_sco_data <- ruODK::odata_submission_get(pid = 2, fid = "05-TIMCI-SPA-SCO")
```

```{r, echo=FALSE}
cgei_data_fname <- file.path(params$spa_output_dir, paste("timci_spa_exit_interview_data", "_", Sys.Date(), ".xlsx", sep = ""))
openxlsx::write.xlsx(raw_spa_cgei_data, cgei_data_fname, row.names = FALSE)

fa_data_fname <- file.path(params$spa_output_dir, paste("timci_spa_facility_assessment_data", "_", Sys.Date(), ".xlsx", sep = ""))
openxlsx::write.xlsx(raw_spa_fa_data, fa_data_fname, row.names = FALSE)

hcpi_data_fname <- file.path(params$spa_output_dir, paste("timci_spa_provider_interview_data", "_", Sys.Date(), ".xlsx", sep = ""))
openxlsx::write.xlsx(raw_spa_hcpi_data, hcpi_data_fname, row.names = FALSE)

sco_data_fname <- file.path(params$spa_output_dir, paste("timci_spa_consultation_obs_data", "_", Sys.Date(), ".xlsx", sep = ""))
openxlsx::write.xlsx(raw_spa_sco_data, sco_data_fname, row.names = FALSE)
```
